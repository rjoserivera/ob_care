{% extends 'Shared/base.html' %}

{% block title %}Mis Notificaciones{% endblock %}

{% block content %}
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0"><i class="bi bi-bell-fill text-primary me-2"></i>Notificaciones</h4>
            <small class="text-muted">Hola <strong>{{ user.first_name }}</strong> ({{ user.username }})</small>
            {% if not personal_turno %}<span class="badge bg-danger">Sin Turno Activo</span>{% endif %}
        </div>
        <span class="badge bg-primary rounded-pill">{{ notificaciones|length }}</span>
    </div>

    {% if notificaciones %}
        <div class="list-group">
            {% for noti in notificaciones %}
            <div class="list-group-item list-group-item-action flex-column align-items-start shadow-sm mb-3 border-0 rounded-3">
                <div class="d-flex w-100 justify-content-between mb-2">
                    <h5 class="mb-1 text-primary fw-bold">
                        {% if noti.tipo == 'PARTO' %}
                            <i class="bi bi-activity me-1"></i> Parto Iniciado
                        {% else %}
                            <i class="bi bi-info-circle me-1"></i> {{ noti.get_tipo_display }}
                        {% endif %}
                    </h5>
                    <small class="text-muted">{{ noti.timestamp_envio|timesince }}</small>
                </div>
                <p class="mb-1 fw-bold">{{ noti.titulo }}</p>
                <div class="alert alert-light border small text-muted mb-2">
                    {{ noti.mensaje|linebreaksbr }}
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-secondary">
                        <i class="bi bi-person"></i> {{ noti.proceso.ficha_obstetrica.paciente.persona.get_nombre_completo }}
                    </small>
                    <a href="#" class="btn btn-sm btn-outline-primary rounded-pill">
                        <i class="bi bi-eye"></i> Ver Ficha
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-bell-slash display-1 text-muted opacity-25"></i>
            <p class="mt-3 text-muted">No tienes notificaciones recientes.</p>
            <p class="small text-muted">Asegúrate de estar en turno activo.</p>
            <a href="{% url 'gestion_procesos:test_notificacion' %}" class="btn btn-outline-info mt-3">
                <i class="bi bi-broadcast"></i> Enviarme Notificación de Prueba
            </a>
        </div>
    {% endif %}
    
    {% if notificaciones %}
    <div class="mt-3 text-center">
         <a href="{% url 'gestion_procesos:test_notificacion' %}" class="btn btn-sm btn-link text-muted">
            <i class="bi bi-broadcast"></i> Probar sonido
        </a>
    </div>
    {% endif %}
</div>
</div>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

{% endblock %}

{% block extra_js %}
<script>
    // 1. Auto Recarga (Polling simple)
    setTimeout(function() {
        window.location.reload();
    }, 15000); // 15 segundos

    // 2. Play Sound logic
    // Si la notificacion mas reciente tiene menos de 1 minuto, sonar.
    {% if notificaciones %}
        const lastNotifTime = new Date("{{ notificaciones.0.timestamp_envio|date:'Y-m-d H:i:s' }}").getTime();
        const now = new Date().getTime();
        const diffSeconds = (now - lastNotifTime) / 1000;
        
        // Si es reciente (menos de 20 segs) y no hemos sonado ya (usar sessionStorage check simple)
        if (diffSeconds < 60) {
            const sound = document.getElementById('notif-sound');
            sound.play().catch(e => console.log("Audio play failed (interaction needed):", e));
        }
    {% endif %}
</script>
{% endblock %}
