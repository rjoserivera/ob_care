{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Ficha {{ ficha.numero_ficha }} - Sistema Obst√©trico{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .ficha-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* Header Principal */
    .ficha-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
    }

    .ficha-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .ficha-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ficha-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .ficha-numero {
        background: rgba(255,255,255,0.25);
        padding: 0.4rem 1rem;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .patient-info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.2);
    }

    .patient-info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .patient-info-item i {
        opacity: 0.8;
    }

    /* Badge Estado */
    .badge-estado {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .badge-activa {
        background: rgba(255,255,255,0.25);
        color: white;
    }

    .badge-inactiva {
        background: #dc3545;
        color: white;
    }

    /* Card de Acci√≥n (Iniciar Parto) */
    .action-card {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe0e6 100%);
        border: 2px dashed #ff416c;
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .action-card-content h3 {
        color: #ff416c;
        margin: 0 0 0.25rem 0;
        font-size: 1.2rem;
    }

    .action-card-content p {
        color: #666;
        margin: 0;
    }

    .btn-parto {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-parto:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(255, 65, 108, 0.4);
        color: white;
    }

    /* Tabs Navigation */
    .nav-tabs-custom {
        border: none;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        color: #000000;
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 2px solid #7dd3fc;
    }

    .nav-tabs-custom .nav-link:hover {
        background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
        color: #000000;
        border-color: #0284c7;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
    }

    .nav-tabs-custom .nav-link.active {
        background: var(--primary-gradient);
        color: white !important;
        box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        border-color: transparent;
    }

    .nav-tabs-custom .nav-link span,
    .nav-tabs-custom .nav-link i {
        color: #000000 !important;
    }

    .nav-tabs-custom .nav-link.active span,
    .nav-tabs-custom .nav-link.active i {
        color: white !important;
    }

    /* Tab Content */
    .tab-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }

    .tab-pane {
        padding: 2rem;
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
    }

    .info-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #11998e;
    }

    .info-item.warning {
        border-left-color: #ffc107;
        background: #fffef5;
    }

    .info-item.danger {
        border-left-color: #dc3545;
        background: #fff5f5;
    }

    .info-item.success {
        border-left-color: #28a745;
        background: #f0fff4;
    }

    .info-label {
        font-size: 0.75rem;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
    }

    .info-value {
        font-size: 1.05rem;
        color: #333;
        font-weight: 600;
    }

    /* Section dentro de tabs */
    .section-block {
        margin-bottom: 2rem;
    }

    .section-block:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #11998e;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: #11998e;
    }

    .section-title.danger i { color: #dc3545; }
    .section-title.warning i { color: #ffc107; }
    .section-title.info i { color: #17a2b8; }

    /* Badges */
    .badge-custom {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }

    /* Patolog√≠a Tag */
    .patologia-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        border: 1px solid #dc3545;
        border-radius: 8px;
        color: #dc3545;
        font-weight: 500;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    /* Beb√© Card */
    .bebe-card {
        background: linear-gradient(135deg, #fff5f5 0%, #fff0f5 100%);
        border: 2px solid #f8d7da;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }

    .bebe-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .bebe-number {
        width: 45px;
        height: 45px;
        background: var(--danger-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
    }

    /* Medicamento Item */
    .medicamento-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        border-left: 4px solid #17a2b8;
    }

    .medicamento-info h5 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
        color: #333;
    }

    .medicamento-info small {
        color: #666;
    }

    .medicamento-dosis {
        background: #17a2b8;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Dilataci√≥n Timeline */
    .dilatacion-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .dilatacion-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, #11998e, #38ef7d);
        border-radius: 3px;
    }

    .dilatacion-item {
        position: relative;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 1rem;
        margin-left: 1rem;
    }

    .dilatacion-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1.25rem;
        width: 12px;
        height: 12px;
        background: #11998e;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #11998e;
    }

    .dilatacion-item .fecha {
        font-size: 0.8rem;
        color: #666;
    }

    .dilatacion-item .valor {
        font-size: 1.5rem;
        font-weight: 700;
        color: #11998e;
    }

    /* Botones */
    .btn-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        padding: 1.5rem 2rem;
        background: #f8f9fa;
        border-radius: 0 0 16px 16px;
    }

    .btn-gradient {
        background: var(--primary-gradient);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        color: white;
    }

    .btn-outline {
        background: white;
        border: 2px solid #dee2e6;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: #6c757d;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-outline:hover {
        border-color: #11998e;
        color: #11998e;
    }

    /* MODAL PARTO */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-parto {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-icon {
        font-size: 4rem;
        color: #ff416c;
        margin-bottom: 1rem;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .modal-subtitle {
        color: #666;
        margin-bottom: 1.5rem;
    }

    .modal-paciente {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .countdown-container {
        display: none;
        margin: 1.5rem 0;
    }

    .countdown-container.active {
        display: block;
    }

    .countdown-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 1rem;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .countdown-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .btn-confirmar {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-confirmar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
    }

    .btn-confirmar:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-cancelar {
        background: #e0e0e0;
        color: #333;
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .notificacion-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        text-align: left;
    }

    .notificacion-info h4 {
        color: #1565c0;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .notificacion-info ul {
        margin: 0;
        padding-left: 1.2rem;
        font-size: 0.85rem;
        color: #555;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .ficha-header-top {
            flex-direction: column;
        }
        
        .action-card {
            flex-direction: column;
            text-align: center;
        }
        
        .nav-tabs-custom {
            flex-direction: column;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .btn-actions {
            flex-direction: column;
        }
        
        .modal-buttons {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ficha-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'matrona:menu_matrona' %}">Matrona</a></li>
            <li class="breadcrumb-item"><a href="{% url 'matrona:lista_fichas' %}">Fichas</a></li>
            <li class="breadcrumb-item active">{{ ficha.numero_ficha }}</li>
        </ol>
    </nav>

    <!-- Header Principal -->
    <div class="ficha-header">
        <div class="ficha-header-top">
            <div class="ficha-header-left">
                <i class="bi bi-file-earmark-medical" style="font-size: 2rem;"></i>
                <div>
                    <h1>Ficha Obst√©trica</h1>
                    <span class="ficha-numero">{{ ficha.numero_ficha }}</span>
                </div>
            </div>
            <div>
                {% if ficha.activa %}
                    <span class="badge-estado badge-activa"><i class="bi bi-check-circle"></i> Activa</span>
                {% else %}
                    <span class="badge-estado badge-inactiva"><i class="bi bi-x-circle"></i> Inactiva</span>
                {% endif %}
            </div>
        </div>
        
        <div class="patient-info-row">
            <div class="patient-info-item">
                <i class="bi bi-person-fill"></i>
                <strong>{{ ficha.paciente.persona.Nombre }} {{ ficha.paciente.persona.Apellido_Paterno }} {{ ficha.paciente.persona.Apellido_Materno }}</strong>
            </div>
            <div class="patient-info-item">
                <i class="bi bi-card-text"></i>
                RUT: {{ ficha.paciente.persona.Rut }}
            </div>
            <div class="patient-info-item">
                <i class="bi bi-calendar-heart"></i>
                EG: {{ ficha.edad_gestacional_semanas|default:"--" }}+{{ ficha.edad_gestacional_dias|default:"0" }} sem
            </div>
            <div class="patient-info-item">
                <i class="bi bi-telephone"></i>
                {{ ficha.paciente.persona.Telefono|default:"Sin tel√©fono" }}
            </div>
        </div>
    </div>

    <!-- Card de Acci√≥n: Iniciar Parto (solo si cumple condiciones) -->
    {% if puede_iniciar_parto %}
    <div class="action-card">
        <div class="action-card-content">
            <h3><i class="bi bi-exclamation-triangle-fill me-2"></i>{{ razon_parto }}</h3>
            <p>Se recomienda iniciar el proceso de parto. Tipo sugerido: <strong>{{ tipo_parto_sugerido }}</strong></p>
        </div>
        <button type="button" class="btn-parto" onclick="abrirModalParto()">
            <i class="bi bi-heart-pulse-fill"></i> INICIAR PROCESO DE PARTO
        </button>
    </div>
    {% endif %}

    <!-- Navegaci√≥n de Tabs -->
    <ul class="nav nav-tabs-custom" id="fichaTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-paciente" data-bs-toggle="tab" data-bs-target="#panel-paciente" type="button" role="tab">
                <i class="bi bi-person-vcard"></i>
                <span>Paciente</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-embarazo" data-bs-toggle="tab" data-bs-target="#panel-embarazo" type="button" role="tab">
                <i class="bi bi-calendar-heart"></i>
                <span>Embarazo</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-historia" data-bs-toggle="tab" data-bs-target="#panel-historia" type="button" role="tab">
                <i class="bi bi-clock-history"></i>
                <span>Historia Obst√©trica</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-examenes" data-bs-toggle="tab" data-bs-target="#panel-examenes" type="button" role="tab">
                <i class="bi bi-droplet"></i>
                <span>Ex√°menes</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dilatacion" data-bs-toggle="tab" data-bs-target="#panel-dilatacion" type="button" role="tab">
                <i class="bi bi-bullseye"></i>
                <span>Dilataci√≥n</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-medicamentos" data-bs-toggle="tab" data-bs-target="#panel-medicamentos" type="button" role="tab">
                <i class="bi bi-capsule"></i>
                <span>Medicamentos</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-bebes" data-bs-toggle="tab" data-bs-target="#panel-bebes" type="button" role="tab">
                <i class="bi bi-emoji-smile"></i>
                <span>Beb√©(s)</span>
            </button>
        </li>
    </ul>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="fichaTabContent">
        
        <!-- ==================== TAB 1: PACIENTE ==================== -->
        <div class="tab-pane fade show active" id="panel-paciente" role="tabpanel">
            <!-- Medidas Antropom√©tricas -->
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-rulers"></i>
                    Medidas Antropom√©tricas
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Peso Actual</div>
                        <div class="info-value">{{ ficha.peso_actual|default:"--" }} kg</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Talla</div>
                        <div class="info-value">{{ ficha.talla_actual|default:"--" }} cm</div>
                    </div>
                    <div class="info-item {% if ficha.imc >= 30 %}danger{% elif ficha.imc >= 25 %}warning{% else %}success{% endif %}">
                        <div class="info-label">IMC</div>
                        <div class="info-value">
                            {{ ficha.imc|default:"--" }}
                            {% if ficha.imc %}
                                {% if ficha.imc >= 30 %}
                                    <span class="badge-custom badge-danger">Obesidad</span>
                                {% elif ficha.imc >= 25 %}
                                    <span class="badge-custom badge-warning">Sobrepeso</span>
                                {% else %}
                                    <span class="badge-custom badge-success">Normal</span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acompa√±ante -->
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-people-fill"></i>
                    Acompa√±ante y Contacto de Emergencia
                </div>
                <div class="info-grid">
                    {% if ficha.tiene_acompanante %}
                    <div class="info-item success">
                        <div class="info-label">Acompa√±ante</div>
                        <div class="info-value">{{ ficha.nombre_acompanante }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">RUT Acompa√±ante</div>
                        <div class="info-value">{{ ficha.rut_acompanante|default:"No registrado" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Parentesco</div>
                        <div class="info-value">{{ ficha.parentesco_acompanante|default:"No especificado" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tel√©fono</div>
                        <div class="info-value">{{ ficha.telefono_acompanante|default:"No registrado" }}</div>
                    </div>
                    {% else %}
                    <div class="info-item warning">
                        <div class="info-label">Acompa√±ante</div>
                        <div class="info-value"><span class="badge-custom badge-warning">Sin acompa√±ante registrado</span></div>
                    </div>
                    {% endif %}
                    
                    {% if ficha.nombre_contacto_emergencia %}
                    <div class="info-item">
                        <div class="info-label">Contacto Emergencia</div>
                        <div class="info-value">{{ ficha.nombre_contacto_emergencia }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tel. Emergencia</div>
                        <div class="info-value">{{ ficha.telefono_emergencia }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: EMBARAZO ACTUAL ==================== -->
        <div class="tab-pane fade" id="panel-embarazo" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-calendar-heart"></i>
                    Embarazo Actual
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Tipo de Ingreso</div>
                        <div class="info-value">
                            {% if ficha.tipo_ingreso == 'URGENCIA' %}
                                <span class="badge-custom badge-danger">üö® Urgencia</span>
                            {% elif ficha.tipo_ingreso == 'DERIVACION' %}
                                <span class="badge-custom badge-warning">üè• Derivaci√≥n</span>
                            {% elif ficha.tipo_ingreso == 'PROGRAMADO' %}
                                <span class="badge-custom badge-success">üìÖ Programado</span>
                            {% else %}
                                <span class="badge-custom badge-info">üö∂ Sala</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">FUM</div>
                        <div class="info-value">{{ ficha.fecha_ultima_regla|date:"d/m/Y"|default:"No registrada" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Edad Gestacional</div>
                        <div class="info-value">{{ ficha.edad_gestacional_semanas|default:"--" }}+{{ ficha.edad_gestacional_dias|default:"0" }} semanas</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">FPP</div>
                        <div class="info-value">{{ ficha.fecha_probable_parto|date:"d/m/Y"|default:"No calculada" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cantidad de Beb√©s</div>
                        <div class="info-value">
                            {{ ficha.cantidad_bebes|default:"1" }}
                            {% if ficha.cantidad_bebes > 1 %}
                                <span class="badge-custom badge-info">M√∫ltiple</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Control Prenatal</div>
                        <div class="info-value">
                            {% if ficha.control_prenatal %}
                                <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">N¬∞ Controles</div>
                        <div class="info-value">{{ ficha.numero_controles|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Plan de Parto</div>
                        <div class="info-value">
                            {% if ficha.plan_de_parto %}
                                <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Visita Guiada</div>
                        <div class="info-value">
                            {% if ficha.visita_guiada %}
                                <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Consultorio Origen</div>
                        <div class="info-value">{{ ficha.consultorio_origen|default:"No registrado" }}</div>
                    </div>
                </div>
            </div>

            <!-- Patolog√≠as -->
            {% if ficha.preeclampsia_severa or ficha.eclampsia or ficha.sepsis_infeccion_sistemia or ficha.infeccion_ovular or ficha.patologias.exists %}
            <div class="section-block">
                <div class="section-title danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Patolog√≠as Activas
                </div>
                <div>
                    {% if ficha.preeclampsia_severa %}
                        <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Preeclampsia Severa</span>
                    {% endif %}
                    {% if ficha.eclampsia %}
                        <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Eclampsia</span>
                    {% endif %}
                    {% if ficha.sepsis_infeccion_sistemia %}
                        <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Sepsis/Infecci√≥n Sist√©mica</span>
                    {% endif %}
                    {% if ficha.infeccion_ovular %}
                        <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Infecci√≥n Ovular</span>
                    {% endif %}
                    {% for patologia in ficha.patologias.all %}
                        <span class="patologia-tag"><i class="bi bi-bandaid"></i> {{ patologia.nombre }}</span>
                    {% endfor %}
                </div>
                {% if ficha.otras_patologias %}
                <div class="mt-3">
                    <strong>Otras:</strong> {{ ficha.otras_patologias }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- ==================== TAB 3: HISTORIA OBST√âTRICA ==================== -->
        <div class="tab-pane fade" id="panel-historia" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-heart-pulse"></i>
                    Historia Obst√©trica
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">N¬∞ Gestaciones</div>
                        <div class="info-value">{{ ficha.numero_gestas|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">N¬∞ Partos</div>
                        <div class="info-value">{{ ficha.numero_partos|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Partos Vaginales</div>
                        <div class="info-value">{{ ficha.partos_vaginales|default:"0" }}</div>
                    </div>
                    <div class="info-item {% if ficha.partos_cesareas > 0 %}warning{% endif %}">
                        <div class="info-label">Ces√°reas</div>
                        <div class="info-value">{{ ficha.partos_cesareas|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Abortos</div>
                        <div class="info-value">{{ ficha.numero_abortos|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Nacidos Vivos</div>
                        <div class="info-value">{{ ficha.nacidos_vivos|default:"0" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 4: EX√ÅMENES ==================== -->
        <div class="tab-pane fade" id="panel-examenes" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-droplet-fill"></i>
                    Ex√°menes VIH
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">VIH 1 Realizado</div>
                        <div class="info-value">
                            {% if ficha.vih_1_realizado %}
                                <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if ficha.vih_1_fecha or ficha.vih_1_resultado %}
                    <div class="info-item">
                        <div class="info-label">Fecha VIH 1</div>
                        <div class="info-value">{{ ficha.vih_1_fecha|date:"d/m/Y"|default:"--" }}</div>
                    </div>
                    <div class="info-item {% if ficha.vih_1_resultado == 'POSITIVO' %}danger{% else %}success{% endif %}">
                        <div class="info-label">Resultado VIH 1</div>
                        <div class="info-value">{{ ficha.vih_1_resultado|default:"Pendiente" }}</div>
                    </div>
                    {% endif %}
                    <div class="info-item">
                        <div class="info-label">VIH 2 Realizado</div>
                        <div class="info-value">
                            {% if ficha.vih_2_realizado %}
                                <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if ficha.vih_2_fecha or ficha.vih_2_resultado %}
                    <div class="info-item">
                        <div class="info-label">Fecha VIH 2</div>
                        <div class="info-value">{{ ficha.vih_2_fecha|date:"d/m/Y"|default:"--" }}</div>
                    </div>
                    <div class="info-item {% if ficha.vih_2_resultado == 'POSITIVO' %}danger{% else %}success{% endif %}">
                        <div class="info-label">Resultado VIH 2</div>
                        <div class="info-value">{{ ficha.vih_2_resultado|default:"Pendiente" }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ==================== TAB 5: DILATACI√ìN ==================== -->
        <div class="tab-pane fade" id="panel-dilatacion" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-bullseye"></i>
                    Estado de Dilataci√≥n
                </div>
                
                <div class="info-grid mb-4">
                    <div class="info-item {% if ficha.valor_dilatacion_actual >= 8 %}success{% elif ficha.valor_dilatacion_actual >= 4 %}warning{% endif %}">
                        <div class="info-label">Dilataci√≥n Actual</div>
                        <div class="info-value" style="font-size: 1.5rem;">{{ ficha.valor_dilatacion_actual|default:"0" }} cm</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Estado</div>
                        <div class="info-value">
                            {% if ficha.estado_dilatacion == 'SIN_REGISTRO' %}
                                <span class="badge-custom badge-warning">‚è≥ Sin registro</span>
                            {% elif ficha.estado_dilatacion == 'PROGRESANDO' %}
                                <span class="badge-custom badge-info">üìà Progresando</span>
                            {% elif ficha.estado_dilatacion == 'ESTANCADA' %}
                                <span class="badge-custom badge-danger">‚ö†Ô∏è Estancada</span>
                            {% elif ficha.estado_dilatacion == 'LISTA' %}
                                <span class="badge-custom badge-success">‚úÖ Lista</span>
                            {% else %}
                                <span class="badge-custom badge-warning">{{ ficha.estado_dilatacion }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Proceso de Parto</div>
                        <div class="info-value">
                            {% if ficha.proceso_parto_iniciado %}
                                <span class="badge-custom badge-success">‚úÖ Iniciado</span>
                            {% else %}
                                <span class="badge-custom badge-warning">‚è≥ No iniciado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n para registrar nueva dilataci√≥n -->
                <div class="mb-4">
                    <button type="button" class="btn-gradient" onclick="mostrarModalDilatacion()">
                        <i class="bi bi-plus-circle"></i> Registrar Nueva Dilataci√≥n
                    </button>
                </div>

                <!-- Timeline de registros -->
                {% if registros_dilatacion %}
                <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>Historial de Registros</h5>
                <div class="dilatacion-timeline">
                    {% for registro in registros_dilatacion %}
                    <div class="dilatacion-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="valor">{{ registro.valor_dilatacion }} cm</div>
                                <div class="fecha">{{ registro.fecha_hora|date:"d/m/Y H:i" }}</div>
                            </div>
                            {% if registro.observacion %}
                            <small class="text-muted">{{ registro.observacion }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-clipboard-x" style="font-size: 3rem;"></i>
                    <p class="mt-2">No hay registros de dilataci√≥n</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ==================== TAB 6: MEDICAMENTOS ==================== -->
        <div class="tab-pane fade" id="panel-medicamentos" role="tabpanel">
            <div class="section-block">
                <div class="section-title info">
                    <i class="bi bi-capsule-pill"></i>
                    Medicamentos Asignados
                </div>
                
                {% if medicamentos %}
                {% for med in medicamentos %}
                <div class="medicamento-item">
                    <div class="medicamento-info">
                        <h5>{{ med.nombre_display }}</h5>
                        <small>{{ med.via_administracion }} - {{ med.frecuencia }}</small>
                    </div>
                    <span class="medicamento-dosis">{{ med.dosis }}</span>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-capsule" style="font-size: 3rem;"></i>
                    <p class="mt-2">No hay medicamentos asignados</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ==================== TAB 7: BEB√âS ==================== -->
        <div class="tab-pane fade" id="panel-bebes" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-emoji-smile-fill"></i>
                    Beb√©s Esperados
                </div>
                
                <div class="info-grid">
                    <div class="info-item" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; color: #11998e; margin-bottom: 1rem;">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="info-label" style="font-size: 1.2rem; margin-bottom: 0.5rem;">Cantidad de Beb√©s Esperados</div>
                        <div class="info-value" style="font-size: 3rem; font-weight: 700; color: #11998e;">
                            {{ ficha.cantidad_bebes|default:"1" }}
                        </div>
                        <p class="text-muted mt-3">
                            <i class="bi bi-info-circle"></i> 
                            Los datos detallados de cada beb√© se registrar√°n despu√©s del parto
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Botones de Acci√≥n -->
    <div class="btn-actions">
        <a href="{% url 'matrona:editar_ficha' ficha.pk %}" class="btn-gradient">
            <i class="bi bi-pencil"></i> Editar Ficha
        </a>
        <a href="{% url 'matrona:lista_fichas' %}" class="btn-outline">
            <i class="bi bi-list"></i> Ver Todas las Fichas
        </a>
        <a href="{% url 'matrona:menu_matrona' %}" class="btn-outline">
            <i class="bi bi-house"></i> Volver al Men√∫
        </a>
    </div>
</div>

<!-- MODAL INICIAR PARTO -->
<div class="modal-overlay" id="modalParto">
    <div class="modal-parto">
        <div class="modal-icon">
            <i class="bi bi-heart-pulse-fill"></i>
        </div>
        
        <div class="modal-title">¬øIniciar Proceso de Parto?</div>
        <div class="modal-subtitle">Esta acci√≥n lo llevar√° a la sala de espera de parto</div>
        
        <div class="modal-paciente">
            <strong>{{ ficha.paciente.persona.Nombre }} {{ ficha.paciente.persona.Apellido_Paterno }}</strong><br>
            <small>RUT: {{ ficha.paciente.persona.Rut }}</small>
        </div>

        <!-- Contador -->
        <div class="countdown-container" id="countdownContainer">
            <div class="countdown-circle">
                <span class="countdown-number" id="countdownNumber">5</span>
            </div>
            <div class="countdown-text">Preparando ingreso a sala de espera...</div>
        </div>

        <!-- Info notificaciones -->
        <div class="notificacion-info" id="notificacionInfo" style="display: none;">
            <h4><i class="bi bi-bell-fill"></i> Se notificar√° al personal:</h4>
            <ul>
                <li>Matrona de turno</li>
                <li>M√©dico obstetra disponible</li>
                <li>TENS de sala</li>
            </ul>
        </div>

        <div class="modal-buttons" id="modalButtons">
            <button type="button" class="btn-confirmar" id="btnConfirmar" onclick="iniciarContador()">
                <i class="bi bi-check-lg"></i> S√≠, Iniciar
            </button>
            <button type="button" class="btn-cancelar" onclick="cerrarModalParto()">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
        </div>

        <div id="botonFinal" style="display: none;">
            <form action="{% url 'ingreso_parto:crear_ficha' ficha.pk %}" method="get">
                <button type="submit" class="btn-confirmar" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                    <i class="bi bi-door-open-fill"></i> INGRESAR A SALA DE PARTO
                </button>
            </form>
            <button type="button" class="btn-cancelar" style="width: 100%; margin-top: 0.5rem;" onclick="cerrarModalParto()">
                Cancelar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let contadorInterval = null;
    let segundosRestantes = 5;

    function abrirModalParto() {
        document.getElementById('modalParto').classList.add('active');
        resetearModal();
    }

    function cerrarModalParto() {
        document.getElementById('modalParto').classList.remove('active');
        if (contadorInterval) {
            clearInterval(contadorInterval);
            contadorInterval = null;
        }
        resetearModal();
    }

    function resetearModal() {
        segundosRestantes = 5;
        document.getElementById('countdownNumber').textContent = '5';
        document.getElementById('countdownContainer').classList.remove('active');
        document.getElementById('countdownContainer').style.display = '';
        document.getElementById('modalButtons').style.display = 'flex';
        document.getElementById('botonFinal').style.display = 'none';
        document.getElementById('notificacionInfo').style.display = 'none';
        document.getElementById('btnConfirmar').disabled = false;
    }

    function iniciarContador() {
        document.getElementById('btnConfirmar').disabled = true;
        document.getElementById('countdownContainer').classList.add('active');
        document.getElementById('notificacionInfo').style.display = 'block';

        contadorInterval = setInterval(function() {
            segundosRestantes--;
            document.getElementById('countdownNumber').textContent = segundosRestantes;

            if (segundosRestantes <= 0) {
                clearInterval(contadorInterval);
                contadorInterval = null;
                mostrarBotonFinal();
            }
        }, 1000);
    }

    function mostrarBotonFinal() {
        document.getElementById('countdownContainer').style.display = 'none';
        document.getElementById('modalButtons').style.display = 'none';
        document.getElementById('botonFinal').style.display = 'block';
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') cerrarModalParto();
    });

    document.getElementById('modalParto').addEventListener('click', function(e) {
        if (e.target === this) cerrarModalParto();
    });
</script>
{% endblock %}