{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Ficha {{ ficha.numero_ficha }} - Sistema Obst√©trico{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --info-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .ficha-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* Header Principal */
    .ficha-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(245, 87, 108, 0.3);
    }

    .ficha-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .ficha-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ficha-header h1 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
    }

    .ficha-numero {
        background: rgba(255, 255, 255, 0.25);
        padding: 0.4rem 1rem;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .patient-info-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .patient-info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
    }

    .patient-info-item i {
        opacity: 0.8;
    }

    /* Badge Estado */
    .badge-estado {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .badge-activa {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .badge-inactiva {
        background: #dc3545;
        color: white;
    }

    /* Card de Acci√≥n (Iniciar Parto) */
    .action-card {
        background: linear-gradient(135deg, #fff5f5 0%, #ffe0e6 100%);
        border: 2px dashed #ff416c;
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .action-card-content h3 {
        color: #ff416c;
        margin: 0 0 0.25rem 0;
        font-size: 1.2rem;
    }

    .action-card-content p {
        color: #666;
        margin: 0;
    }

    .btn-parto {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-parto:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(255, 65, 108, 0.4);
        color: white;
    }

    /* Tabs Navigation */
    .nav-tabs-custom {
        border: none;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 0.5rem;
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .nav-tabs-custom .nav-link {
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.25rem;
        font-weight: 700;
        font-size: 1rem;
        color: #444;
        background: linear-gradient(135deg, #fff0f5 0%, #ffe4e6 100%);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 2px solid #fbcfe8;
    }

    .nav-tabs-custom .nav-link:hover {
        background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        color: #d63384;
        border-color: #f472b6;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(244, 114, 182, 0.3);
    }

    .nav-tabs-custom .nav-link.active {
        background: var(--primary-gradient);
        color: white !important;
        box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        border-color: transparent;
    }

    .nav-tabs-custom .nav-link span,
    .nav-tabs-custom .nav-link i {
        color: #000000 !important;
    }

    .nav-tabs-custom .nav-link.active span,
    .nav-tabs-custom .nav-link.active i {
        color: white !important;
    }

    /* Tab Content */
    .tab-content {
        background: white;
        border-radius: 16px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }

    .tab-pane {
        padding: 2rem;
    }

    /* Info Grid */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.25rem;
    }

    .info-item {
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #f093fb;
    }

    .info-item.warning {
        border-left-color: #ffc107;
        background: #fffef5;
    }

    .info-item.danger {
        border-left-color: #dc3545;
        background: #fff5f5;
    }

    .info-item.success {
        border-left-color: #28a745;
        background: #f0fff4;
    }

    .info-label {
        font-size: 0.75rem;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.3rem;
    }

    .info-value {
        font-size: 1.05rem;
        color: #333;
        font-weight: 600;
    }

    /* Section dentro de tabs */
    .section-block {
        margin-bottom: 2rem;
    }

    .section-block:last-child {
        margin-bottom: 0;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f093fb;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: #f093fb;
    }

    .section-title.danger i {
        color: #dc3545;
    }

    .section-title.warning i {
        color: #ffc107;
    }

    .section-title.info i {
        color: #17a2b8;
    }

    /* Badges */
    .badge-custom {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    /* Patolog√≠a Tag */
    .patologia-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
        border: 1px solid #dc3545;
        border-radius: 8px;
        color: #dc3545;
        font-weight: 500;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    /* Beb√© Card */
    .bebe-card {
        background: linear-gradient(135deg, #fff5f5 0%, #fff0f5 100%);
        border: 2px solid #f8d7da;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }

    .bebe-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .bebe-number {
        width: 45px;
        height: 45px;
        background: var(--danger-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
    }

    /* Medicamento Item */
    .medicamento-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 0.75rem;
        border-left: 4px solid #17a2b8;
    }

    .medicamento-info h5 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
        color: #333;
    }

    .medicamento-info small {
        color: #666;
    }

    .medicamento-dosis {
        background: #17a2b8;
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Dilataci√≥n Timeline */
    .dilatacion-timeline {
        position: relative;
        padding-left: 2rem;
    }

    .dilatacion-timeline::before {
        content: '';
        position: absolute;
        left: 8px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(to bottom, #f093fb, #f5576c);
        border-radius: 3px;
    }

    .dilatacion-item {
        position: relative;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 1rem;
        margin-left: 1rem;
    }

    .dilatacion-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1.25rem;
        width: 12px;
        height: 12px;
        background: #f093fb;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 3px #f093fb;
    }

    .dilatacion-item .fecha {
        font-size: 0.8rem;
        color: #666;
    }

    .dilatacion-item .valor {
        font-size: 1.5rem;
        font-weight: 700;
        color: #f093fb;
    }

    /* Botones */
    .btn-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        padding: 1.5rem 2rem;
        background: #f8f9fa;
        border-radius: 0 0 16px 16px;
    }

    .btn-gradient {
        background: var(--primary-gradient);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        color: white;
    }

    .btn-outline {
        background: white;
        border: 2px solid #dee2e6;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: #6c757d;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .btn-outline:hover {
        border-color: #f093fb;
        color: #f093fb;
    }

    /* MODAL PARTO */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-parto {
        background: white;
        border-radius: 20px;
        padding: 2.5rem;
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: modalSlide 0.3s ease;
    }

    @keyframes modalSlide {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-icon {
        font-size: 4rem;
        color: #ff416c;
        margin-bottom: 1rem;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .modal-subtitle {
        color: #666;
        margin-bottom: 1.5rem;
    }

    .modal-paciente {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .countdown-container {
        display: none;
        margin: 1.5rem 0;
    }

    .countdown-container.active {
        display: block;
    }

    .countdown-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 1rem;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    .countdown-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }

    .modal-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .btn-confirmar {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-confirmar:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
    }

    .btn-confirmar:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-cancelar {
        background: #e0e0e0;
        color: #333;
        padding: 0.8rem 2rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .notificacion-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        text-align: left;
    }

    .notificacion-info h4 {
        color: #1565c0;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .notificacion-info ul {
        margin: 0;
        padding-left: 1.2rem;
        font-size: 0.85rem;
        color: #555;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .ficha-header-top {
            flex-direction: column;
        }

        .action-card {
            flex-direction: column;
            text-align: center;
        }

        .nav-tabs-custom {
            flex-direction: column;
        }

        .info-grid {
            grid-template-columns: 1fr;
        }

        .btn-actions {
            flex-direction: column;
        }

        .modal-buttons {
            flex-direction: column;
        }
    }

    /* Profesional Modal Style for Dilatation */
    #modalDilatacion.modal-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1050;
        /* Above everything */
        display: none;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    #modalDilatacion[style*="display: flex"] {
        display: flex !important;
    }

    #modalDilatacion .modal-content {
        background: #ffffff;
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        padding: 0;
        overflow: hidden;
        animation: slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
        position: relative;
        /* Ensure stacking context */
    }

    #modalDilatacion .modal-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 1.5rem;
        border: none;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #modalDilatacion .modal-title {
        color: white;
        margin: 0;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    #modalDilatacion .close-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 1.2rem;
    }

    #modalDilatacion .close-btn:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    #modalDilatacion .modal-body {
        padding: 2rem;
    }

    #modalDilatacion .modal-footer {
        padding: 1rem 2rem 2rem;
        border: none;
        background: white;
        gap: 1rem;
        justify-content: center;
        display: flex;
    }

    @keyframes slideUpFade {
        from {
            transform: translateY(20px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ficha-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'matrona:menu_matrona' %}">Matrona</a></li>
            <li class="breadcrumb-item"><a href="{% url 'matrona:lista_fichas' %}">Fichas</a></li>
            <li class="breadcrumb-item active">{{ ficha.numero_ficha }}</li>
        </ol>
    </nav>

    <!-- Header Principal -->
    <div class="ficha-header">
        <div class="ficha-header-top">
            <div class="ficha-header-left">
                <i class="bi bi-file-earmark-medical" style="font-size: 2rem;"></i>
                <div>
                    <h1>Ficha Obst√©trica</h1>
                    <span class="ficha-numero">{{ ficha.numero_ficha }}</span>
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if puede_editar_ficha %}
                <a href="{% url 'matrona:editar_ficha' ficha.pk %}" class="btn btn-light btn-sm shadow-sm"
                    style="color: #f5576c; font-weight: 700; border-radius: 20px; padding: 0.4rem 1rem;">
                    <i class="bi bi-pencil-square"></i> Editar Ficha
                </a>
                {% endif %}
                <div>
                {% if ficha.activa %}
                <span class="badge-estado badge-activa"><i class="bi bi-check-circle"></i> Activa</span>
                {% else %}
                <span class="badge-estado badge-inactiva"><i class="bi bi-x-circle"></i> Inactiva</span>
                {% endif %}
            </div>
            </div>
        </div>

        <div class="patient-info-row">
            <div class="patient-info-item">
                <i class="bi bi-person-fill"></i>
                <strong>{{ ficha.paciente.persona.Nombre }} {{ ficha.paciente.persona.Apellido_Paterno }} {{ ficha.paciente.persona.Apellido_Materno }}</strong>

            </div>
            <div class="patient-info-item">
                <i class="bi bi-card-text"></i>
                RUT: {{ ficha.paciente.persona.Rut }}
            </div>
            <div class="patient-info-item">
                <i class="bi bi-calendar-heart"></i>
                EG: {{ ficha.edad_gestacional_semanas|default:"--" }}+{{ ficha.edad_gestacional_dias|default:"0" }} sem
            </div>
            <div class="patient-info-item">
                <i class="bi bi-telephone"></i>
                {{ ficha.paciente.persona.Telefono|default:"Sin tel√©fono" }}
            </div>
        </div>
    </div>

    <!-- Card de Acci√≥n: Iniciar Parto (solo si cumple condiciones) -->
    <!-- Card de Acci√≥n: Iniciar Parto (Status Monitor) -->
    <div class="action-card {% if puede_parto %}status-active{% else %}status-waiting{% endif %}">
        <div class="action-card-content">
            {% if puede_parto %}
            <h3><i class="bi bi-exclamation-circle-fill me-2"></i>PARTO HABILITADO</h3>
            <p>{{ razon_parto }}</p>
            <p>Tipo sugerido: <strong>{{ tipo_parto_sugerido }}</strong></p>
            {% else %}
            <h3 style="color: #6c757d;"><i class="bi bi-hourglass-split me-2"></i>Monitoreo de Parto</h3>
            <p>{{ razon_parto }}</p>
            <small class="text-muted">El bot√≥n se habilitar√° autom√°ticamente al cumplir criterios.</small>
            {% endif %}
        </div>

        <button type="button" class="btn-parto" onclick="abrirModalParto()" {% if not puede_parto %}disabled
            style="opacity: 0.5; cursor: not-allowed; background: #ccc;" {% endif %}>
            <i class="bi bi-heart-pulse-fill"></i> INICIAR PROCESO DE PARTO
        </button>
    </div>

    <!-- Navegaci√≥n de Tabs -->
    <ul class="nav nav-tabs-custom" id="fichaTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-paciente" data-bs-toggle="tab" data-bs-target="#panel-paciente"
                type="button" role="tab">
                <i class="bi bi-person-vcard"></i>
                <span>Paciente</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-embarazo" data-bs-toggle="tab" data-bs-target="#panel-embarazo"
                type="button" role="tab">
                <i class="bi bi-calendar-heart"></i>
                <span>Embarazo</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-historia" data-bs-toggle="tab" data-bs-target="#panel-historia"
                type="button" role="tab">
                <i class="bi bi-clock-history"></i>
                <span>Historia Obst√©trica</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-examenes" data-bs-toggle="tab" data-bs-target="#panel-examenes"
                type="button" role="tab">
                <i class="bi bi-droplet"></i>
                <span>Ex√°menes</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-controles-previos" data-bs-toggle="tab"
                data-bs-target="#panel-controles-previos" type="button" role="tab">
                <i class="bi bi-clipboard-data"></i>
                <span>Controles Previos</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dilatacion" data-bs-toggle="tab" data-bs-target="#panel-dilatacion"
                type="button" role="tab">
                <i class="bi bi-bullseye"></i>
                <span>Dilataci√≥n</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-medicamentos" data-bs-toggle="tab" data-bs-target="#panel-medicamentos"
                type="button" role="tab">
                <i class="bi bi-capsule"></i>
                <span>Medicamentos</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-bebes" data-bs-toggle="tab" data-bs-target="#panel-bebes" type="button"
                role="tab">
                <i class="bi bi-emoji-smile"></i>
                <span>Beb√©(s)</span>
            </button>
        </li>
    </ul>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="fichaTabContent">

        <!-- ==================== TAB 1: PACIENTE ==================== -->
        <div class="tab-pane fade show active" id="panel-paciente" role="tabpanel">
            <!-- Medidas Antropom√©tricas -->
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-rulers"></i>
                    Medidas Antropom√©tricas
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Peso Actual</div>
                        <div class="info-value">{{ ficha.peso_actual|default:"--" }} kg</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Talla</div>
                        <div class="info-value">{{ ficha.talla_actual|default:"--" }} cm</div>
                    </div>
                    <div
                        class="info-item {% if ficha.imc >= 30 %}danger{% elif ficha.imc >= 25 %}warning{% else %}success{% endif %}">
                        <div class="info-label">IMC</div>
                        <div class="info-value">
                            {{ ficha.imc|default:"--" }}
                            {% if ficha.imc %}
                            {% if ficha.imc >= 30 %}
                            <span class="badge-custom badge-danger">Obesidad</span>
                            {% elif ficha.imc >= 25 %}
                            <span class="badge-custom badge-warning">Sobrepeso</span>
                            {% else %}
                            <span class="badge-custom badge-success">Normal</span>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acompa√±ante -->
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-people-fill"></i>
                    Acompa√±ante y Contacto de Emergencia
                </div>
                <div class="info-grid">
                    {% if ficha.tiene_acompanante %}
                    <div class="info-item success">
                        <div class="info-label">Acompa√±ante</div>
                        <div class="info-value">{{ ficha.nombre_acompanante }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">RUT Acompa√±ante</div>
                        <div class="info-value">{{ ficha.rut_acompanante|default:"No registrado" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Parentesco</div>
                        <div class="info-value">{{ ficha.parentesco_acompanante|default:"No especificado" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tel√©fono</div>
                        <div class="info-value">{{ ficha.telefono_acompanante|default:"No registrado" }}</div>
                    </div>
                    {% else %}
                    <div class="info-item warning">
                        <div class="info-label">Acompa√±ante</div>
                        <div class="info-value"><span class="badge-custom badge-warning">Sin acompa√±ante
                                registrado</span></div>
                    </div>
                    {% endif %}

                    {% if ficha.nombre_contacto_emergencia %}
                    <div class="info-item">
                        <div class="info-label">Contacto Emergencia</div>
                        <div class="info-value">{{ ficha.nombre_contacto_emergencia }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Tel. Emergencia</div>
                        <div class="info-value">{{ ficha.telefono_emergencia }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: EMBARAZO ACTUAL ==================== -->
        <div class="tab-pane fade" id="panel-embarazo" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-calendar-heart"></i>
                    Embarazo Actual
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Tipo de Ingreso</div>
                        <div class="info-value">
                            {% if ficha.tipo_ingreso == 'URGENCIA' %}
                            <span class="badge-custom badge-danger">üö® Urgencia</span>
                            {% elif ficha.tipo_ingreso == 'DERIVACION' %}
                            <span class="badge-custom badge-warning">üè• Derivaci√≥n</span>
                            {% elif ficha.tipo_ingreso == 'PROGRAMADO' %}
                            <span class="badge-custom badge-success">üìÖ Programado</span>
                            {% else %}
                            <span class="badge-custom badge-info">üö∂ Sala</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">FUM</div>
                        <div class="info-value">{{ ficha.fecha_ultima_regla|date:"d/m/Y"|default:"No registrada" }}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Edad Gestacional</div>
                        <div class="info-value">{{ ficha.edad_gestacional_semanas|default:"--" }}+{{
                            ficha.edad_gestacional_dias|default:"0" }} semanas</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">FPP</div>
                        <div class="info-value">{{ ficha.fecha_probable_parto|date:"d/m/Y"|default:"No calculada" }}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cantidad de Beb√©s</div>
                        <div class="info-value">
                            {{ ficha.cantidad_bebes|default:"1" }}
                            {% if ficha.cantidad_bebes > 1 %}
                            <span class="badge-custom badge-info">M√∫ltiple</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Control Prenatal</div>
                        <div class="info-value">
                            {% if ficha.control_prenatal %}
                            <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">N¬∞ Controles</div>
                        <div class="info-value">{{ ficha.numero_controles|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Plan de Parto</div>
                        <div class="info-value">
                            {% if ficha.plan_de_parto %}
                            <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Visita Guiada</div>
                        <div class="info-value">
                            {% if ficha.visita_guiada %}
                            <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Consultorio Origen</div>
                        <div class="info-value">{{ ficha.consultorio_origen|default:"No registrado" }}</div>
                    </div>
                </div>
            </div>

            <!-- Patolog√≠as -->
            {% if ficha.preeclampsia_severa or ficha.eclampsia or ficha.sepsis_infeccion_sistemia or ficha.infeccion_ovular or ficha.patologias.exists %}

            <div class="section-block">
                <div class="section-title danger">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    Patolog√≠as Activas
                </div>
                <div>
                    {% if ficha.preeclampsia_severa %}
                    <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Preeclampsia Severa</span>
                    {% endif %}
                    {% if ficha.eclampsia %}
                    <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Eclampsia</span>
                    {% endif %}
                    {% if ficha.sepsis_infeccion_sistemia %}
                    <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Sepsis/Infecci√≥n
                        Sist√©mica</span>
                    {% endif %}
                    {% if ficha.infeccion_ovular %}
                    <span class="patologia-tag"><i class="bi bi-exclamation-circle"></i> Infecci√≥n Ovular</span>
                    {% endif %}
                    {% for patologia in ficha.patologias.all %}
                    <span class="patologia-tag"><i class="bi bi-bandaid"></i> {{ patologia.nombre }}</span>
                    {% endfor %}
                </div>
                {% if ficha.otras_patologias %}
                <div class="mt-3">
                    <strong>Otras:</strong> {{ ficha.otras_patologias }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- ==================== TAB 3: HISTORIA OBST√âTRICA ==================== -->
        <div class="tab-pane fade" id="panel-historia" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-heart-pulse"></i>
                    Historia Obst√©trica
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">N¬∞ Gestaciones</div>
                        <div class="info-value">{{ ficha.numero_gestas|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">N¬∞ Partos</div>
                        <div class="info-value">{{ ficha.numero_partos|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Partos Vaginales</div>
                        <div class="info-value">{{ ficha.partos_vaginales|default:"0" }}</div>
                    </div>
                    <div class="info-item {% if ficha.partos_cesareas > 0 %}warning{% endif %}">
                        <div class="info-label">Ces√°reas</div>
                        <div class="info-value">{{ ficha.partos_cesareas|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Abortos</div>
                        <div class="info-value">{{ ficha.numero_abortos|default:"0" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Nacidos Vivos</div>
                        <div class="info-value">{{ ficha.nacidos_vivos|default:"0" }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 4: EX√ÅMENES ==================== -->
        <div class="tab-pane fade" id="panel-examenes" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-droplet-fill"></i>
                    Ex√°menes VIH
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">VIH 1 Realizado</div>
                        <div class="info-value">
                            {% if ficha.vih_1_realizado %}
                            <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if ficha.vih_1_fecha or ficha.vih_1_resultado %}
                    <div class="info-item">
                        <div class="info-label">Fecha VIH 1</div>
                        <div class="info-value">{{ ficha.vih_1_fecha|date:"d/m/Y"|default:"--" }}</div>
                    </div>
                    <div
                        class="info-item {% if ficha.vih_1_resultado == 'POSITIVO' %}danger{% else %}success{% endif %}">
                        <div class="info-label">Resultado VIH 1</div>
                        <div class="info-value">{{ ficha.vih_1_resultado|default:"Pendiente" }}</div>
                    </div>
                    {% endif %}
                    <div class="info-item">
                        <div class="info-label">VIH 2 Realizado</div>
                        <div class="info-value">
                            {% if ficha.vih_2_realizado %}
                            <span class="badge-custom badge-success">‚úÖ S√≠</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚ùå No</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if ficha.vih_2_fecha or ficha.vih_2_resultado %}
                    <div class="info-item">
                        <div class="info-label">Fecha VIH 2</div>
                        <div class="info-value">{{ ficha.vih_2_fecha|date:"d/m/Y"|default:"--" }}</div>
                    </div>
                    <div
                        class="info-item {% if ficha.vih_2_resultado == 'POSITIVO' %}danger{% else %}success{% endif %}">
                        <div class="info-label">Resultado VIH 2</div>
                        <div class="info-value">{{ ficha.vih_2_resultado|default:"Pendiente" }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>


        <!-- ==================== TAB: CONTROLES PREVIOS ==================== -->
        <div class="tab-pane fade" id="panel-controles-previos" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-clipboard-data"></i>
                    Controles Previos (Historial Legacy)
                </div>

                {% if controles_previos %}
                <div style="margin-bottom: 1.5rem;">
                    <span class="badge-custom badge-info">
                        <i class="bi bi-info-circle"></i>
                        Se encontraron {{ controles_previos.count }} controles previos
                    </span>
                </div>

                {% for control in controles_previos %}
                <div class="control-previo-card"
                    style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">

                    <!-- HEADER DEL CONTROL -->
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 3px solid #f093fb;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #f093fb; font-weight: 700; font-size: 1.3rem;">
                                <i class="bi bi-calendar-event"></i>
                                Control #{{ control.numero_control|default:forloop.counter }} - {{ control.tipo_control|default:"PRENATAL" }}

                            </h4>
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <div>
                                    <small style="color: #666; font-weight: 600;"><i class="bi bi-calendar3"></i>
                                        Fecha:</small>
                                    <strong style="color: #333; margin-left: 0.3rem;">{{ control.fecha_control|date:"d/m/Y" }}</strong>
                                </div>
                                {% if control.profesional_nombre %}
                                <div>
                                    <small style="color: #666; font-weight: 600;"><i class="bi bi-person-badge"></i>
                                        Profesional:</small>
                                    <strong style="color: #333; margin-left: 0.3rem;">{{ control.profesional_nombre }}
                                        ({{ control.profesional_tipo|default:"" }})</strong>
                                </div>
                                {% endif %}
                                {% if control.consultorio_origen %}
                                <div>
                                    <small style="color: #666; font-weight: 600;"><i class="bi bi-hospital"></i>
                                        Consultorio:</small>
                                    <strong style="color: #333; margin-left: 0.3rem;">{{ control.consultorio_origen }}</strong>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                            {% if control.semanas_gestacion %}
                            <div
                                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.7rem 1.2rem; border-radius: 25px; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);">
                                <i class="bi bi-calendar-heart"></i> {{ control.semanas_gestacion }}{% if control.dias_gestacion %}+{{ control.dias_gestacion }}{% endif %} sem
                            </div>
                            {% endif %}
                            {% if control.nivel_riesgo %}
                            <div
                                style="background: {% if control.nivel_riesgo == 'ALTO' %}#dc3545{% elif control.nivel_riesgo == 'MEDIO' %}#ffc107{% else %}#28a745{% endif %}; color: white; padding: 0.4rem 0.9rem; border-radius: 15px; font-weight: 600; font-size: 0.9rem;">
                                Riesgo: {{ control.nivel_riesgo }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- SECCI√ìN: DATOS CR√çTICOS PARA PARTO -->
                    {% if control.cesareas_previas or control.paridad_formato or control.vih_resultado or control.vdrl_resultado or control.sgb_resultado or control.diabetes_gestacional or control.hipertension_arterial or control.preeclampsia_leve or control.preeclampsia_severa %}

                    <div
                        style="background: linear-gradient(135deg, #fff5f5 0%, #ffe0e6 100%); border: 3px solid #ff416c; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h5 style="color: #ff416c; margin: 0 0 1rem 0; font-weight: 700;">
                            <i class="bi bi-exclamation-triangle-fill"></i> DATOS CR√çTICOS PARA PARTO
                        </h5>
                        <div class="info-grid">
                            <!-- Historia Obst√©trica -->
                            {% if control.paridad_formato %}
                            <div class="info-item" style="border-left-color: #ff416c; background: white;">
                                <div class="info-label"><i class="bi bi-file-medical"></i> PARIDAD</div>
                                <div class="info-value" style="font-size: 1.2rem; color: #ff416c; font-weight: 700;">
                                    {{ control.paridad_formato }}
                                </div>
                            </div>
                            {% endif %}

                            {% if control.cesareas_previas %}
                            <div class="info-item danger">
                                <div class="info-label"><i class="bi bi-scissors"></i> CES√ÅREAS PREVIAS</div>
                                <div class="info-value">
                                    {{ control.cesareas_previas }}
                                    <span class="badge-custom badge-danger">UTPP</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if control.partos_vaginales_previos %}
                            <div class="info-item success">
                                <div class="info-label"><i class="bi bi-check-circle"></i> PARTOS VAGINALES</div>
                                <div class="info-value">{{ control.partos_vaginales_previos }}</div>
                            </div>
                            {% endif %}

                            <!-- Ex√°menes Infecciosos - SIEMPRE VISIBLE -->
                            <div
                                class="info-item {% if control.vih_resultado == 'POSITIVO' %}danger{% elif control.vih_resultado %}success{% else %}warning{% endif %}">
                                <div class="info-label"><i class="bi bi-shield-check"></i> VIH {% if control.vih_orden %}({{ control.vih_orden }}¬∫){% endif %}</div>
                                <div class="info-value">
                                    {% if control.vih_resultado %}
                                    {{ control.vih_resultado }}
                                    {% if control.vih_fecha_toma %}<br><small>{{ control.vih_fecha_toma|date:"d/m/Y" }}</small>{% endif %}
                                    {% if control.vih_resultado == 'POSITIVO' %}
                                    <span class="badge-custom badge-danger">Profilaxis ARV</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge-custom badge-warning"><i class="bi bi-question-circle"></i> NO
                                        REALIZADO</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div
                                class="info-item {% if control.vdrl_resultado == 'REACTIVO' %}danger{% elif control.vdrl_resultado %}success{% else %}warning{% endif %}">
                                <div class="info-label"><i class="bi bi-droplet-half"></i> VDRL/S√≠filis</div>
                                <div class="info-value">
                                    {% if control.vdrl_resultado %}
                                    {{ control.vdrl_resultado }}
                                    {% if control.vdrl_fecha %}<br><small>{{ control.vdrl_fecha|date:"d/m/Y" }}</small>{% endif %}
                                    {% if control.vdrl_resultado == 'REACTIVO' %}
                                    <span class="badge-custom badge-danger">Tratamiento ATB</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge-custom badge-warning"><i class="bi bi-question-circle"></i> NO
                                        REALIZADO</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div
                                class="info-item {% if control.sgb_resultado == 'POSITIVO' %}warning{% elif control.sgb_resultado %}success{% else %}warning{% endif %}">
                                <div class="info-label"><i class="bi bi-bacteria"></i> SGB (Estreptococo B)</div>
                                <div class="info-value">
                                    {% if control.sgb_resultado %}
                                    {{ control.sgb_resultado }}
                                    {% if control.sgb_fecha_cultivo %}<br><small>{{ control.sgb_fecha_cultivo|date:"d/m/Y" }}</small>{% endif %}
                                    {% if control.sgb_resultado == 'POSITIVO' %}
                                    <span class="badge-custom badge-warning">Profilaxis ATB Intraparto</span>
                                    {% endif %}
                                    {% if control.sgb_profilaxis %}
                                    <span class="badge-custom badge-success">Profilaxis ya realizada</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge-custom badge-warning"><i class="bi bi-question-circle"></i> NO
                                        REALIZADO</span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if control.hepatitis_b_resultado %}
                            <div
                                class="info-item {% if control.hepatitis_b_resultado == 'POSITIVO' %}danger{% else %}success{% endif %}">
                                <div class="info-label"><i class="bi bi-shield-fill-exclamation"></i> Hepatitis B</div>
                                <div class="info-value">
                                    {{ control.hepatitis_b_resultado }}
                                    {% if control.hepatitis_b_fecha %}<br><small>{{ control.hepatitis_b_fecha|date:"d/m/Y" }}</small>{% endif %}
                                    {% if control.hepatitis_b_resultado == 'POSITIVO' %}
                                    <span class="badge-custom badge-danger">Inmunoglobulina RN</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Patolog√≠as -->
                            {% if control.diabetes_gestacional %}
                            <div class="info-item danger">
                                <div class="info-label"><i class="bi bi-droplet-fill"></i> DIABETES GESTACIONAL</div>
                                <div class="info-value">
                                    <span class="badge-custom badge-danger">S√ç - Vigilar glucemia</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if control.hipertension_arterial %}
                            <div class="info-item danger">
                                <div class="info-label"><i class="bi bi-heart-pulse-fill"></i> HIPERTENSI√ìN</div>
                                <div class="info-value">
                                    <span class="badge-custom badge-danger">S√ç - Vigilar PA</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if control.preeclampsia_leve or control.preeclampsia_severa or control.eclampsia %}
                            <div class="info-item danger">
                                <div class="info-label"><i class="bi bi-exclamation-octagon-fill"></i>
                                    PREECLAMPSIA/ECLAMPSIA</div>
                                <div class="info-value">
                                    {% if control.eclampsia %}
                                    <span class="badge-custom badge-danger">ECLAMPSIA</span>
                                    {% elif control.preeclampsia_severa %}
                                    <span class="badge-custom badge-danger">PREECLAMPSIA SEVERA</span>
                                    {% elif control.preeclampsia_leve %}
                                    <span class="badge-custom badge-warning">PREECLAMPSIA LEVE</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Resto de las secciones en acorde√≥n -->
                    <div class="accordion" id="accordion{{ control.id }}" style="margin-top: 1rem;">

                        <!-- EVALUACI√ìN FETAL -->
                        <div class="accordion-item"
                            style="border: none; margin-bottom: 0.5rem; border-radius: 8px; overflow: hidden;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#fetal{{ control.id }}"
                                    style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); font-weight: 600;">
                                    <i class="bi bi-heart-fill me-2"></i> Evaluaci√≥n Fetal
                                </button>
                            </h2>
                            <div id="fetal{{ control.id }}" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="info-grid">
                                        {% if control.fcf_lpm %}
                                        <div
                                            class="info-item {% if control.fcf_lpm < 110 or control.fcf_lpm > 160 %}warning{% else %}success{% endif %}">
                                            <div class="info-label">FCF</div>
                                            <div class="info-value">{{ control.fcf_lpm }} lpm</div>
                                        </div>
                                        {% endif %}

                                        {% if control.movimientos_fetales %}
                                        <div class="info-item success">
                                            <div class="info-label">Movimientos</div>
                                            <div class="info-value">{{ control.movimientos_fetales }}</div>
                                        </div>
                                        {% endif %}

                                        {% if control.presentacion_fetal %}
                                        <div class="info-item">
                                            <div class="info-label">Presentaci√≥n</div>
                                            <div class="info-value">{{ control.presentacion_fetal }}</div>
                                        </div>
                                        {% endif %}

                                        {% if control.situacion_fetal %}
                                        <div class="info-item">
                                            <div class="info-label">Situaci√≥n</div>
                                            <div class="info-value">{{ control.situacion_fetal }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SIGNOS VITALES Y ANTROPOMETR√çA -->
                        <div class="accordion-item"
                            style="border: none; margin-bottom: 0.5rem; border-radius: 8px; overflow: hidden;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#vitales{{ control.id }}"
                                    style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); font-weight: 600;">
                                    <i class="bi bi-activity me-2"></i> Signos Vitales y Antropometr√≠a
                                </button>
                            </h2>
                            <div id="vitales{{ control.id }}" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="info-grid">
                                        {% if control.presion_sistolica or control.presion_diastolica %}
                                        <div
                                            class="info-item {% if control.presion_sistolica >= 140 or control.presion_diastolica >= 90 %}danger{% elif control.presion_sistolica >= 120 %}warning{% endif %}">
                                            <div class="info-label">Presi√≥n Arterial</div>
                                            <div class="info-value">{{ control.presion_sistolica }}/{{
                                                control.presion_diastolica }} mmHg</div>
                                        </div>
                                        {% endif %}

                                        {% if control.peso_kg %}
                                        <div class="info-item">
                                            <div class="info-label">Peso</div>
                                            <div class="info-value">{{ control.peso_kg }} kg</div>
                                        </div>
                                        {% endif %}

                                        {% if control.imc %}
                                        <div class="info-item">
                                            <div class="info-label">IMC</div>
                                            <div class="info-value">{{ control.imc }}</div>
                                        </div>
                                        {% endif %}

                                        {% if control.ganancia_peso_total_kg %}
                                        <div class="info-item">
                                            <div class="info-label">Ganancia Peso Total</div>
                                            <div class="info-value">{{ control.ganancia_peso_total_kg }} kg</div>
                                        </div>
                                        {% endif %}

                                        {% if control.altura_uterina_cm %}
                                        <div class="info-item">
                                            <div class="info-label">Altura Uterina</div>
                                            <div class="info-value">{{ control.altura_uterina_cm }} cm</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- EX√ÅMENES DE LABORATORIO -->
                        <div class="accordion-item"
                            style="border: none; margin-bottom: 0.5rem; border-radius: 8px; overflow: hidden;">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#lab{{ control.id }}"
                                    style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); font-weight: 600;">
                                    <i class="bi bi-eyedropper me-2"></i> Ex√°menes de Laboratorio
                                </button>
                            </h2>
                            <div id="lab{{ control.id }}" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="info-grid">
                                        {% if control.hemoglobina_g_dl %}
                                        <div
                                            class="info-item {% if control.hemoglobina_g_dl < 11 %}danger{% elif control.hemoglobina_g_dl < 12 %}warning{% else %}success{% endif %}">
                                            <div class="info-label">Hemoglobina</div>
                                            <div class="info-value">
                                                {{ control.hemoglobina_g_dl }} g/dL
                                                {% if control.hemoglobina_g_dl < 11 %} <span
                                                    class="badge-custom badge-danger">Anemia</span>
                                                    {% endif %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if control.grupo_sanguineo %}
                                        <div class="info-item">
                                            <div class="info-label">Grupo/Rh</div>
                                            <div class="info-value">{{ control.grupo_sanguineo }}{{
                                                control.factor_rh|default:"" }}</div>
                                        </div>
                                        {% endif %}

                                        {% if control.glucosa_mg_dl %}
                                        <div
                                            class="info-item {% if control.glucosa_mg_dl >= 126 %}danger{% elif control.glucosa_mg_dl >= 100 %}warning{% endif %}">
                                            <div class="info-label">Glucosa</div>
                                            <div class="info-value">{{ control.glucosa_mg_dl }} mg/dL</div>
                                        </div>
                                        {% endif %}

                                        {% if control.proteinuria %}
                                        <div
                                            class="info-item {% if control.proteinuria != 'NEGATIVO' %}warning{% endif %}">
                                            <div class="info-label">Proteinuria</div>
                                            <div class="info-value">{{ control.proteinuria }}</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OBSERVACIONES E INDICACIONES -->
                    {% if control.observaciones or control.indicaciones_medicas %}
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #dee2e6;">
                        {% if control.observaciones %}
                        <div style="margin-bottom: 1rem;">
                            <div class="info-label" style="margin-bottom: 0.5rem;"><i class="bi bi-card-text"></i>
                                OBSERVACIONES:</div>
                            <div
                                style="background: white; padding: 1rem; border-radius: 8px; color: #333; border-left: 4px solid #17a2b8;">
                                {{ control.observaciones }}
                            </div>
                        </div>
                        {% endif %}

                        {% if control.indicaciones_medicas %}
                        <div>
                            <div class="info-label" style="margin-bottom: 0.5rem;"><i class="bi bi-prescription2"></i>
                                INDICACIONES M√âDICAS:</div>
                            <div
                                style="background: white; padding: 1rem; border-radius: 8px; color: #333; border-left: 4px solid #28a745;">
                                {{ control.indicaciones_medicas }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                {% else %}
                <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 12px;">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
                    <h4 style="margin-top: 1rem; color: #6c757d;">No se encontraron controles previos</h4>
                    <p style="color: #6c757d;">No hay registros de controles previos en el sistema legacy para esta
                        paciente.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ==================== TAB 5: DILATACI√ìN ==================== -->
        <div class="tab-pane fade" id="panel-dilatacion" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-bullseye"></i>
                    Estado de Dilataci√≥n
                </div>

                <div class="info-grid mb-4">
                    <div
                        class="info-item {% if ficha.valor_dilatacion_actual >= 8 %}success{% elif ficha.valor_dilatacion_actual >= 4 %}warning{% endif %}">
                        <div class="info-label">Dilataci√≥n Actual</div>
                        <div class="info-value" style="font-size: 1.5rem;">{{ ficha.valor_dilatacion_actual|default:"0"|floatformat:"-1" }} cm</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Estado</div>
                        <div class="info-value">
                            {% if ficha.estado_dilatacion == 'SIN_REGISTRO' %}
                            <span class="badge-custom badge-warning">‚è≥ Sin registro</span>
                            {% elif ficha.estado_dilatacion == 'PROGRESANDO' %}
                            <span class="badge-custom badge-info">üìà Progresando</span>
                            {% elif ficha.estado_dilatacion == 'ESTANCADA' %}
                            <span class="badge-custom badge-danger">‚ö†Ô∏è Estancada</span>
                            {% elif ficha.estado_dilatacion == 'LISTA' %}
                            <span class="badge-custom badge-success">‚úÖ Lista</span>
                            {% else %}
                            <span class="badge-custom badge-warning">{{ ficha.estado_dilatacion }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Proceso de Parto</div>
                        <div class="info-value">
                            {% if ficha.proceso_parto_iniciado %}
                            <span class="badge-custom badge-success">‚úÖ Iniciado</span>
                            {% else %}
                            <span class="badge-custom badge-warning">‚è≥ No iniciado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n para registrar nueva dilataci√≥n -->
                <div class="mb-4">
                    <button type="button" class="btn-gradient" onclick="mostrarModalDilatacion()">
                        <i class="bi bi-plus-circle"></i> Registrar Nueva Dilataci√≥n
                    </button>
                </div>

                <!-- Timeline de registros -->
                {% if registros_dilatacion %}
                <h5 class="mb-3"><i class="bi bi-clock-history me-2"></i>Historial de Registros</h5>
                <div class="dilatacion-timeline">
                    {% for registro in registros_dilatacion %}
                    <div class="dilatacion-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="valor">{{ registro.valor_dilatacion|floatformat:"-1" }} cm</div>
                                <div class="fecha">{{ registro.fecha_hora|date:"d/m/Y H:i" }}</div>
                            </div>
                            {% if registro.observacion %}
                            <small class="text-muted">{{ registro.observacion }}</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-clipboard-x" style="font-size: 3rem;"></i>
                    <p class="mt-2">No hay registros de dilataci√≥n</p>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- ==================== TAB 6: MEDICAMENTOS ==================== -->
        <div class="tab-pane fade" id="panel-medicamentos" role="tabpanel">
            <div class="section-block">
                <div class="section-title" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <i class="bi bi-capsule-pill"></i>
                        Medicamentos Asignados
                    </div>
                    <a href="{% url 'matrona:agregar_medicamento' ficha.pk %}" 
                       class="btn" 
                       style="background: white; color: #f5576c; padding: 0.6rem 1.5rem; border-radius: 25px; font-weight: 600; text-decoration: none; font-size: 0.9rem;">
                        <i class="bi bi-plus-circle"></i> Agregar Medicamento
                    </a>
                </div>

                {% if medicamentos %}
                    <!-- Medicamentos Activos -->
                    <div style="margin-bottom: 2rem;">
                        <h5 style="color: #f5576c; margin: 1.5rem 0 1rem; font-weight: 700;">
                            <i class="bi bi-check-circle-fill me-2"></i>Medicamentos ({{ medicamentos.count }})
                        </h5>
                        
                        {% for med in medicamentos %}
                        <div class="medicamento-item" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid {% if med.activo %}#28a745{% else %}#6c757d{% endif %}; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; position: relative;">
                            <!-- Badge de estado -->
                            <div style="position: absolute; top: 1rem; right: 1rem;">
                                {% if med.activo %}
                                    <span class="badge-custom badge-success" style="font-size: 0.8rem;">
                                        <i class="bi bi-check-circle"></i> Activo
                                    </span>
                                {% else %}
                                    <span class="badge-custom" style="background: #6c757d; color: white; font-size: 0.8rem;">
                                        <i class="bi bi-x-circle"></i> Finalizado
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="medicamento-info">
                                <h5 style="color: #333; margin: 0 0 0.5rem 0; font-weight: 700; font-size: 1.3rem;">
                                    <i class="bi bi-capsule-pill" style="color: #f5576c;"></i> {{ med.nombre_display }}
                                </h5>
                                
                                <!-- Grid de informacion -->
                                <div class="info-grid" style="margin-top: 1rem;">
                                    <div class="info-item">
                                        <div class="info-label"><i class="bi bi-prescription2"></i> Dosis</div>
                                        <div class="info-value medicamento-dosis" style="color: #f5576c; font-weight: 700; font-size: 1.2rem;">{{ med.dosis }}</div>
                                    </div>
                                    
                                    <div class="info-item">
                                        <div class="info-label"><i class="bi bi-arrow-repeat"></i> Frecuencia</div>
                                        <div class="info-value">{{ med.frecuencia }}</div>
                                    </div>
                                    
                                    <div class="info-item">
                                        <div class="info-label"><i class="bi bi-eyedropper"></i> Via</div>
                                        <div class="info-value">{{ med.via_administracion }}</div>
                                    </div>
                                    
                                    <div class="info-item">
                                        <div class="info-label"><i class="bi bi-calendar-check"></i> Inicio</div>
                                        <div class="info-value">{{ med.fecha_inicio|date:"d/m/Y" }}</div>
                                    </div>
                                    
                                    {% if med.fecha_termino %}
                                    <div class="info-item">
                                        <div class="info-label"><i class="bi bi-calendar-x"></i> Termino</div>
                                        <div class="info-value">{{ med.fecha_termino|date:"d/m/Y" }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                {% if med.indicaciones %}
                                <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #f5576c;">
                                    <div class="info-label" style="margin-bottom: 0.5rem;"><i class="bi bi-card-text"></i> INDICACIONES:</div>
                                    <div style="color: #333;">{{ med.indicaciones }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Estado vacio -->
                    <div style="text-align: center; padding: 4rem 2rem; background: #f8f9fa; border-radius: 12px; margin-top: 1.5rem;">
                        <i class="bi bi-capsule" style="font-size: 5rem; color: #dee2e6;"></i>
                        <h4 style="margin: 1.5rem 0 0.5rem; color: #6c757d;">No hay medicamentos asignados</h4>
                        <p style="color: #adb5bd; margin-bottom: 1.5rem;">Asigna medicamentos para el tratamiento de la paciente</p>
                        <a href="{% url 'matrona:agregar_medicamento' ficha.pk %}" 
                           class="btn" 
                           style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.75rem 2rem; border-radius: 25px; font-weight: 600; text-decoration: none; display: inline-block;">
                            <i class="bi bi-plus-circle"></i> Agregar Primer Medicamento
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        </div>

        <!-- ==================== TAB 7: BEB√âS ==================== -->
        <div class="tab-pane fade" id="panel-bebes" role="tabpanel">
            <div class="section-block">
                <div class="section-title">
                    <i class="bi bi-emoji-smile-fill"></i>
                    Beb√©s Esperados
                </div>

                <div class="info-grid">
                    <div class="info-item" style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
                        <div style="font-size: 4rem; color: #f093fb; margin-bottom: 1rem;">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <div class="info-label" style="font-size: 1.2rem; margin-bottom: 0.5rem;">Cantidad de Beb√©s
                            Esperados</div>
                        <div class="info-value" style="font-size: 3rem; font-weight: 700; color: #f093fb;">
                            {{ ficha.cantidad_bebes|default:"1" }}
                        </div>
                        <p class="text-muted mt-3">
                            <i class="bi bi-info-circle"></i>
                            Los datos detallados de cada beb√© se registrar√°n despu√©s del parto
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Botones de Acci√≥n -->
    <div class="btn-actions">
        <a href="{% url 'matrona:editar_ficha' ficha.pk %}" class="btn-gradient">
            <i class="bi bi-pencil"></i> Editar Ficha
        </a>
        <a href="{% url 'matrona:lista_fichas' %}" class="btn-outline">
            <i class="bi bi-list"></i> Ver Todas las Fichas
        </a>
        <a href="{% url 'matrona:menu_matrona' %}" class="btn-outline">
            <i class="bi bi-house"></i> Volver al Men√∫
        </a>
    </div>
</div>

<!-- MODAL INICIAR PARTO -->
<div class="modal-overlay" id="modalParto">
    <div class="modal-parto">
        <div class="modal-icon">
            <i class="bi bi-heart-pulse-fill"></i>
        </div>

        <div class="modal-title">¬øIniciar Proceso de Parto?</div>
        <div class="modal-subtitle">Esta acci√≥n lo llevar√° a la sala de espera de parto</div>

        <div class="modal-paciente">
            <strong>{{ ficha.paciente.persona.Nombre }} {{ ficha.paciente.persona.Apellido_Paterno }}</strong><br>
            <small>RUT: {{ ficha.paciente.persona.Rut }}</small>
        </div>

        <!-- Contador -->
        <div class="countdown-container" id="countdownContainer">
            <div class="countdown-circle">
                <span class="countdown-number" id="countdownNumber">5</span>
            </div>
            <div class="countdown-text">Preparando ingreso a sala de espera...</div>
        </div>

        <!-- Info notificaciones -->
        <div class="notificacion-info" id="notificacionInfo" style="display: none;">
            <h4><i class="bi bi-bell-fill"></i> Se notificar√° al personal:</h4>
            <ul>
                <li>Matrona de turno</li>
                <li>M√©dico obstetra disponible</li>
                <li>TENS de sala</li>
            </ul>
        </div>

        <div class="modal-buttons" id="modalButtons">
            <button type="button" class="btn-confirmar" id="btnConfirmar" onclick="iniciarContador()">
                <i class="bi bi-check-lg"></i> S√≠, Iniciar
            </button>
            <button type="button" class="btn-cancelar" onclick="cerrarModalParto()">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
        </div>

        <div id="botonFinal" style="display: none;">
            <form action="{% url 'ingreso_parto:crear_ficha' ficha.pk %}" method="get">
                <button type="submit" class="btn-confirmar" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                    <i class="bi bi-door-open-fill"></i> INGRESAR A SALA DE PARTO
                </button>
            </form>
            <button type="button" class="btn-cancelar" style="width: 100%; margin-top: 0.5rem;"
                onclick="cerrarModalParto()">
                Cancelar
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let contadorInterval = null;
    let segundosRestantes = 5;

    function abrirModalParto() {
        document.getElementById('modalParto').classList.add('active');
        resetearModal();
    }

    function cerrarModalParto() {
        document.getElementById('modalParto').classList.remove('active');
        if (contadorInterval) {
            clearInterval(contadorInterval);
            contadorInterval = null;
        }
        resetearModal();
    }

    function resetearModal() {
        segundosRestantes = 5;
        document.getElementById('countdownNumber').textContent = '5';
        document.getElementById('countdownContainer').classList.remove('active');
        document.getElementById('countdownContainer').style.display = '';
        document.getElementById('modalButtons').style.display = 'flex';
        document.getElementById('botonFinal').style.display = 'none';
        document.getElementById('notificacionInfo').style.display = 'none';
        document.getElementById('btnConfirmar').disabled = false;
    }

    function iniciarContador() {
        document.getElementById('btnConfirmar').disabled = true;
        document.getElementById('countdownContainer').classList.add('active');
        document.getElementById('notificacionInfo').style.display = 'block';

        contadorInterval = setInterval(function () {
            segundosRestantes--;
            document.getElementById('countdownNumber').textContent = segundosRestantes;

            if (segundosRestantes <= 0) {
                clearInterval(contadorInterval);
                contadorInterval = null;
                mostrarBotonFinal();
            }
        }, 1000);
    }


    function mostrarBotonFinal() {
        document.getElementById('countdownContainer').style.display = 'none';
        document.getElementById('modalButtons').style.display = 'none';
        document.getElementById('botonFinal').style.display = 'block';
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') cerrarModalParto();
    });

    document.getElementById('modalParto').addEventListener('click', function (e) {
        if (e.target === this) cerrarModalParto();
    });
</script>

<script>
    // ==========================================
    // LOGICA DE REGISTRO DE DILATACION
    // ==========================================

    function mostrarModalDilatacion() {
        const modal = document.getElementById('modalDilatacion');
        if (modal) {
            modal.style.display = 'flex';

            // Set current date and time
            const now = new Date();
            const dateInput = document.getElementById('id_dilatacion_fecha');
            if (dateInput) {
                dateInput.valueAsDate = now;
            }

            // Format time for input type="time"
            const timeInput = document.getElementById('id_dilatacion_hora');
            if (timeInput) {
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeInput.value = hours + ':' + minutes;
            }

            // Focus on first input
            setTimeout(() => {
                const firstInput = document.getElementById('id_dilatacion_cm');
                if (firstInput) firstInput.focus();
            }, 100);
        }
    }

    function cerrarModalDilatacion() {
        const modal = document.getElementById('modalDilatacion');
        if (modal) modal.style.display = 'none';
        const form = document.getElementById('formDilatacion');
        if (form) form.reset();
    }

    // Close modal on Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') cerrarModalDilatacion();
    });

    // Handle Form Submission
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Validacion y Envio AJAX
    document.addEventListener('DOMContentLoaded', function () {
        const formDilatacion = document.getElementById('formDilatacion');

        if (formDilatacion) {
            formDilatacion.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log('Interceptando env√≠o de formulario...');

                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;

                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';

                const csrftoken = getCookie('csrftoken');
                // Ensure URL is rendered correctly
                const url = "{% url 'matrona:registrar_dilatacion' ficha.id %}";
                console.log('Enviando a URL:', url);

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || response.statusText) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'success') {
                            submitBtn.classList.remove('btn-primary');
                            submitBtn.classList.add('btn-success');
                            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> ¬°Guardado!';
                            setTimeout(() => location.reload(), 500);
                        } else {
                            throw new Error(data.message || 'Error desconocido del servidor');
                        }
                    })
                    .catch(error => {
                        console.error('Error AJAX:', error);
                        alert('Hubo un problema al guardar: ' + error.message);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    });
            });
        });
    }
    }); // End DOMContentLoaded

    // Funciones Modal Parto (Global Scope)
    function abrirModalParto() {
        const modal = document.getElementById('modalIniciarParto');
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } else {
            console.error('Modal Parto no encontrado');
        }
    }

    function cerrarModalParto() {
        const modal = document.getElementById('modalIniciarParto');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // Cerrar modal al hacer click fuera
    window.onclick = function (event) {
        const modalParto = document.getElementById('modalIniciarParto');
        if (event.target == modalParto) {
            cerrarModalParto();
        }
    }


</script>

<!-- Modal Registro Dilatacion -->
<div id="modalDilatacion" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="bi bi-bullseye"></i> Registrar Dilatacion
            </h3>
            <button class="close-btn" type="button" onclick="cerrarModalDilatacion()">&times;</button>
        </div>

        <form id="formDilatacion">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-group mb-3">
                    <label class="form-label">Dilatacion (cm) <span class="text-danger">*</span></label>
                    <input type="number" name="valor_dilatacion" id="id_dilatacion_cm" class="form-control" step="0.5"
                        min="0" max="10" required placeholder="Ej: 5.5">
                    <small class="text-muted">Ingrese valor entre 0 y 10 cm</small>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Fecha <span class="text-danger">*</span></label>
                            <input type="date" name="fecha" id="id_dilatacion_fecha" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label class="form-label">Hora <span class="text-danger">*</span></label>
                            <input type="time" name="hora" id="id_dilatacion_hora" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-3">
                    <label class="form-label">Observaciones</label>
                    <textarea name="observacion" class="form-control" rows="3"
                        placeholder="Opcional: detalles adicionales..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalDilatacion()">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save"></i> Guardar Registro
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block modal_parto %}
<!-- Modal Iniciar Parto -->
<div id="modalIniciarParto" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
    <div class="modal-dialog"
        style="background: white; border-radius: 8px; max-width: 500px; width: 90%; margin: 10% auto; padding: 0;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white p-3"
                style="border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title m-0"><i class="bi bi-heart-pulse-fill me-2"></i>Iniciar Proceso de Parto</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModalParto()"
                    style="background: transparent; border: none; color: white; font-size: 1.5rem;">&times;</button>
            </div>
            <form action="{% url 'matrona:iniciar_parto' ficha.id %}" method="POST">
                {% csrf_token %}
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-exclamation-circle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center mb-4">¬øEst√° seguro que desea iniciar el proceso de parto para la paciente
                        <strong>{{ paciente.persona.get_nombre_completo }}</strong>?</p>

                    <div class="alert alert-info">
                        <strong>Condici√≥n Actual:</strong> {{ razon_parto }}<br>
                        <strong>Tipo Sugerido:</strong> {{ tipo_parto_sugerido }}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Confirmar Tipo de Parto:</label>
                        <select name="tipo_parto" class="form-control">
                            <option value="VAGINAL" {% if tipo_parto_sugerido == 'VAGINAL' %}selected{% endif %}>Parto
                                Vaginal</option>
                            <option value="CESAREA" {% if tipo_parto_sugerido == 'CESAREA' %}selected{% endif %}>Ces√°rea
                            </option>
                            <option value="URGENTE">Ces√°rea de Urgencia</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer p-3 bg-light"
                    style="border-radius: 0 0 8px 8px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalParto()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-play-circle-fill me-2"></i>S√≠, Iniciar Proceso
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}