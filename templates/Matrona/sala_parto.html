{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Sala de Parto - Atención Materna{% endblock %}

{% block extra_css %}
<style>
    /* Global */
    .delivery-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    
    /* Header Fixed - Professional + Color */
    .patient-header {
        background: linear-gradient(to right, #ffffff, #f0f7ff);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 6px solid #0d6efd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e1e8ef;
    }
    .patient-info h1 { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin: 0; } /* Dark Blue/Gray */
    
    .timer-display {
        font-family: 'Courier New', monospace;
        font-size: 2rem;
        color: white;
        background: #0d6efd; /* Solid Blue Background */
        padding: 0.5rem 1.2rem;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
    }

    /* Association Section - High Visibility */
    .association-card {
        background: #e7f1ff; /* Light Blue Background */
        border: 2px dashed #aecce5;
        border-radius: 12px;
        padding: 1.2rem 2rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .rn-link {
        background: white;
        border: 2px solid #0d6efd;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        text-decoration: none;
        color: #0d6efd;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .rn-link:hover { background: #0d6efd; color: white; transform: translateY(-2px); }

    .btn-associate {
        background: #198754; /* Green for Action */
        color: white;
        border: none;
        padding: 0.8rem 1.8rem;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
    }
    .btn-associate:hover { background: #146c43; transform: scale(1.05); color: white; }

    /* TAF Tabs - High Contrast Fix */
    .taf-tabs .nav-link {
        color: #212529; /* Black Text */
        font-weight: 700;
        padding: 1rem 1.5rem;
        background: #e9ecef; /* Darker Gray Background for Inactive */
        margin-right: 5px;
        border: 1px solid #ced4da; /* Visible Border */
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }
    .taf-tabs .nav-link.active {
        color: white;
        background: #0d6efd; /* Active Blue */
        border-color: #0d6efd;
    }
    .taf-content {
        background: white;
        border: 3px solid #0d6efd; /* Thicker Border */
        border-radius: 0 8px 8px 8px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        padding: 2.5rem;
    }
    
    /* Input Visibility */
    .form-control, .form-select {
        border: 1px solid #adb5bd !important; /* Darker Border for Inputs */
        background-color: #fcfcfc;
        color: #000;
        font-weight: 500;
    }
    .form-control:focus, .form-select:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        background-color: #fff;
    }

    /* Strong Labels for Blind Visibility */
    .form-label {
        color: #000 !important; /* Pure Black */
        font-weight: 800 !important;
        font-size: 1rem;
    }
    .form-check-label {
        color: #212529 !important;
        font-weight: 700;
    }
    
    .section-title {
        background: #f8f9fa;
        color: #212529;
        border-left: 5px solid #0d6efd;
        padding: 0.8rem 1.2rem;
        margin-bottom: 2rem;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 1.2rem;
        border-radius: 4px;
    }

    /* Strong Labels */
    .form-label {
        color: #212529; /* Black/Dark Gray */
        font-weight: 700 !important;
        font-size: 0.95rem;
    }
    .form-check-label {
        font-weight: 600;
        color: #495057;
    }
    h6 { color: #0d6efd; font-weight: 800 !important; margin-bottom: 1rem; }
    
    .alert-light {
        background: #fff3cd; /* Warning Yellow tint for context */
        border: 1px solid #ffecb5;
        color: #664d03;
    }
</style>
{% endblock %}

{% block content %}
<div class="delivery-container">

    <!-- 1. ENCABEZADO FIJO -->
    <div class="patient-header">
        <div class="patient-info">
            <h1>{{ ficha_parto.ficha_obstetrica.paciente.persona.nombre_completo }}</h1>
            <div class="patient-details">
                <span><i class="bi bi-person-vcard"></i> RUT: {{ ficha_parto.ficha_obstetrica.paciente.persona.rut }}-{{ ficha_parto.ficha_obstetrica.paciente.persona.dv }}</span>
                <span><i class="bi bi-cake"></i> {{ ficha_parto.ficha_obstetrica.paciente.edad }} años</span>
                <span><i class="bi bi-calendar-event"></i> EG: {{ ficha_parto.ficha_obstetrica.edad_gestacional_semanas }}+{{ ficha_parto.ficha_obstetrica.edad_gestacional_dias }}</span>
            </div>
        </div>
        <div class="text-end">
            <div class="small text-muted text-uppercase fw-bold">Tiempo en Sala</div>
            <div id="chronometer" class="timer-display">00:00:00</div>
        </div>
    </div>

    <!-- 2. & 3. SECCIÓN DE ASOCIACIONES -->
    <div class="association-card">
        <div>
            <h6 class="text-muted fw-bold text-uppercase mb-2" style="font-size: 0.8rem;">Recién Nacidos Asociados</h6>
            <div class="rn-list">
                {% for rn in recien_nacidos %}
                <a href="{% url 'matrona:ficha_rn' rn.id %}" class="rn-link" target="_blank">
                    <i class="bi bi-person-baby"></i> RN{{ forloop.counter }} 
                    <small class="text-muted">#{{ rn.id }}</small>
                </a>
                {% empty %}
                <span class="text-muted fst-italic">No hay recién nacidos asociados aún.</span>
                {% endfor %}
            </div>
        </div>
        <div>
            <a href="{% url 'matrona:asociar_rn' ficha_parto.id %}" class="btn-associate">
                <i class="bi bi-plus-lg"></i> Asociar Recién Nacido
            </a>
        </div>
    </div>

    <!-- 4. TAF - PESTAÑAS DE ATENCIÓN FUNCIONAL -->
    <div class="taf-header-box">
        <ul class="nav nav-tabs taf-tabs" id="tafTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#taf1">TAF 1 - Ingreso</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf2">TAF 2 - Proceso</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf3">TAF 3 - Acompañamiento</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf4">TAF 4 - Analgesia</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf5">TAF 5 - Periné</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf6">TAF 6 - Equipo</button></li>
        </ul>
    </div>
    
    <div class="tab-content taf-content">
        
        <!-- TAF 1: INGRESO -->
        <div class="tab-pane fade show active" id="taf1">
            <h5 class="section-title"><i class="bi bi-file-medical"></i> Contexto del Ingreso</h5>
            <div class="row g-4">
                <div class="col-md-3">
                    <label class="form-label">Inicio Proceso Parto</label>
                    <input type="text" class="form-control" value="{{ ficha_parto.pin_generado_en|date:'d/m/Y H:i' }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Edad Gestacional Reales</label>
                    <input type="text" class="form-control" value="{{ ficha_parto.ficha_obstetrica.edad_gestacional_semanas }}+{{ ficha_parto.ficha_obstetrica.edad_gestacional_dias }}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Diagnóstico de Ingreso</label>
                    <textarea class="form-control" rows="1" readonly>{{ ficha_parto.ficha_obstetrica.diagnostico_ingreso|default:"Sin diagnóstico registrado" }}</textarea>
                </div>
                <div class="col-12">
                    <div class="alert alert-light border">
                        <strong>Continuidad de la atención:</strong> Paciente proveniente de {{ ficha_parto.ficha_obstetrica.procedencia|default:"Urgencia Maternidad" }}.
                    </div>
                </div>
            </div>
        </div>

        <!-- TAF 2: PROCESO DE PARTO -->
        <div class="tab-pane fade" id="taf2">
            <h5 class="section-title"><i class="bi bi-heart-pulse"></i> Desarrollo del Parto</h5>
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Clasificación Clínica</label>
                    <select class="form-select" name="tipo_parto">
                        <option value="">Seleccione...</option>
                        {% for t in tipos_parto %}<option value="{{t.id}}">{{t.descripcion}}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Clasificación Robson</label>
                    <select class="form-select" name="robson">
                         <option value="">Seleccione...</option>
                        {% for r in robsons %}<option value="{{r.id}}">Grupo {{ r.numero_grupo }} - {{r.descripcion}}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Posición Materna</label>
                    <select class="form-select" name="posicion">
                         <option value="">Seleccione...</option>
                        {% for p in posiciones %}<option value="{{p.id}}">{{p.descripcion}}</option>{% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label d-block mb-2">Posiciones Alternativas</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="checkPosAlt">
                        <label class="form-check-label" for="checkPosAlt">Se ofrecieron posiciones alternativas durante el trabajo de parto</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label d-block mb-2">Periodos del Parto</label>
                    <div class="d-flex gap-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="perPreparto" checked disabled>
                            <label class="form-check-label" for="perPreparto">Preparto</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="perParto" checked>
                            <label class="form-check-label" for="perParto">Parto Vaginal / Cesárea</label>
                        </div>
                        <!-- "Parto con RN" excluido explicita solicitud -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TAF 3: ACOMPAÑAMIENTO -->
        <div class="tab-pane fade" id="taf3">
            <h5 class="section-title"><i class="bi bi-people"></i> Acompañamiento</h5>
            <div class="row g-4">
                 <div class="col-md-5">
                    <label class="form-label">Nombre Acompañante</label>
                    <input type="text" class="form-control" name="nombre_acompanante" placeholder="Nombre completo">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vínculo</label>
                    <select class="form-select" name="vinculo_acompanante">
                        <option value="">Seleccione...</option>
                        {% for p in personas_acompanante %}<option value="{{p.id}}">{{p.descripcion}}</option>{% endfor %}
                    </select>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Motivo NO Acompañado</label>
                    <select class="form-select" name="motivo_no_acomp">
                        <option value="">(Si aplica) Seleccione...</option>
                        {% for m in motivos_no_acompanado %}<option value="{{m.id}}">{{m.descripcion}}</option>{% endfor %}
                    </select>
                </div>
                
                <div class="col-12 mt-3">
                    <div class="form-check p-3 border rounded bg-light">
                        <input class="form-check-input" type="checkbox" name="corta_cordon" id="checkCortaCordon">
                        <label class="form-check-label fw-bold" for="checkCortaCordon">
                            Acompañante participa en corte de cordón umbilical
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAF 4: ANALGESIA -->
        <div class="tab-pane fade" id="taf4">
             <h5 class="section-title"><i class="bi bi-prescription2"></i> Manejo del Dolor</h5>
             
             <div class="row">
                 <!-- Farmacologico -->
                 <div class="col-md-6 border-end">
                     <h6 class="text-secondary fw-bold mb-3">Anestesia / Analgesia Farmacológica</h6>
                     
                     <div class="mb-3">
                         <label class="form-label fw-bold">Peridural</label>
                         <div class="d-flex flex-column gap-2 ms-2">
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="peri1"> <label for="peri1">Solicitada por Paciente</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="peri2"> <label for="peri2">Indicada por Médico</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="peri3"> <label for="peri3">Administrada Efectivamente</label></div>
                         </div>
                     </div>
                     
                     <div class="mb-3">
                         <label class="form-label fw-bold">Otras</label>
                         <div class="d-flex flex-column gap-2 ms-2">
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="anestOtras"> <label for="anestOtras">Neuroaxial (Raquídea/Espinal)</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="anestGral"> <label for="anestGral">Anestesia General</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="anestLocal"> <label for="anestLocal">Anestesia Local / Pudenda</label></div>
                             <div class="form-check"><input type="checkbox" class="form-check-input" id="anestNitro"> <label for="anestNitro">Óxido Nitroso</label></div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- No Farmacologico -->
                 <div class="col-md-6 ps-4">
                     <h6 class="text-secondary fw-bold mb-3">Métodos No Farmacológicos</h6>
                     <div class="row row-cols-2 g-3">
                         {% for m in metodos_no_farm %}
                         <div class="col">
                             <div class="form-check">
                                 <input class="form-check-input" type="checkbox" name="metodo_no_farm_{{m.id}}" id="mn_{{m.id}}">
                                 <label class="form-check-label" for="mn_{{m.id}}">{{ m.descripcion }}</label>
                             </div>
                         </div>
                         {% endfor %}
                     </div>
                 </div>
             </div>
        </div>

        <!-- TAF 5: PERINÉ -->
        <div class="tab-pane fade" id="taf5">
             <h5 class="section-title"><i class="bi bi-bandaid"></i> Periné y Complicaciones</h5>
             
             <div class="row g-4 mb-4">
                 <div class="col-md-6">
                     <label class="form-label">Estado del Periné Post-Parto</label>
                     <select class="form-select" name="estado_perine">
                         <option value="">Seleccione...</option>
                         {% for p in perines %}<option value="{{p.id}}">{{p.descripcion}}</option>{% endfor %}
                     </select>
                 </div>
             </div>
             
             <hr class="text-muted">
             
             <h6 class="text-danger fw-bold mb-3">Complicaciones Maternas</h6>
             <div class="row row-cols-md-3 g-3 mb-4">
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp1"><label for="comp1">Inercia Uterina</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp2"><label for="comp2">Restos Placentarios</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp3"><label for="comp3">Desgarro / Trauma</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp4"><label for="comp4">Hemorragia Post-Parto</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp5"><label for="comp5">Histerectomía Obstétrica</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" class="form-check-input" id="comp6"><label for="comp6">Transfusión Sanguínea</label></div></div>
             </div>
             
             <div class="card bg-light border-0 p-3">
                 <h6 class="fw-bold mb-3">Esterilización Quirúrgica</h6>
                 <div class="row align-items-center">
                     <div class="col-md-3">
                         <div class="form-check">
                             <input type="checkbox" class="form-check-input" id="checkEsterilizacion">
                             <label class="form-check-label" for="checkEsterilizacion">Se realizó esterilización</label>
                         </div>
                     </div>
                     <div class="col-md-4">
                         <select class="form-select" id="selTipoEst" disabled>
                             <option value="">Tipo...</option>
                             {% for t in tipos_esterilizacion %}<option value="{{t.id}}">{{t.descripcion}}</option>{% endfor %}
                         </select>
                     </div>
                     <div class="col-md-3">
                         <input type="datetime-local" class="form-control" id="fechaEst" disabled>
                     </div>
                 </div>
             </div>
        </div>

        <!-- TAF 6: EQUIPO MATERNO -->
        <div class="tab-pane fade" id="taf6">
            <h5 class="section-title"><i class="bi bi-person-badge"></i> Equipo Responsable (Madre)</h5>
            <p class="text-muted mb-4">Profesionales responsables de la atención directa de la mujer durante el parto.</p>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card h-100 border-primary shadow-sm" style="border-left-width: 5px;">
                        <div class="card-body">
                            <h6 class="card-title text-primary fw-bold">Matrona Responsable</h6>
                            <select class="form-select form-select-lg mb-3">
                                <option value="">Seleccione...</option>
                                {% for m in matronas_staff %}<option value="{{m.usuario.id}}">{{m.usuario.get_full_name}}</option>{% endfor %}
                            </select>
                            <small class="text-muted">Lidera el proceso de parto y atención inmediata.</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100 border-success shadow-sm" style="border-left-width: 5px;">
                         <div class="card-body">
                            <h6 class="card-title text-success fw-bold">TENS de Apoyo</h6>
                            <select class="form-select form-select-lg mb-3">
                                <option value="">Seleccione...</option>
                                {% for t in tens_staff %}<option value="{{t.usuario.id}}">{{t.usuario.get_full_name}}</option>{% endfor %}
                            </select>
                             <small class="text-muted">Asiste en procedimientos y confort de la paciente.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Acciones Finales -->
    <div class="text-end mt-4">
        <a href="{% url 'matrona:cierre_parto' ficha_parto.id %}" class="btn btn-dark btn-lg">
            Finalizar Atención Materna <i class="bi bi-arrow-right"></i>
        </a>
    </div>

</div>

<script>
    // Timer Logic
    const startTimeIso = "{{ ficha_parto.pin_generado_en|date:'c' }}";
    const start = new Date(startTimeIso).getTime();

    setInterval(() => {
        const now = new Date().getTime();
        const diff = now - start;
        if (diff < 0) return;
        
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('chronometer').textContent = 
            (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
    }, 1000);
</script>
{% endblock %}
