{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Sala de Parto - Atención Materna{% endblock %}

{% block extra_css %}
<style>
    /* Global */
    .delivery-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    
    /* Header Fixed - Professional + Color */
    .patient-header {
        background: linear-gradient(to right, #ffffff, #f0f7ff);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 6px solid #0d6efd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e1e8ef;
    }
    .patient-info h1 { font-size: 1.6rem; font-weight: 700; color: #2c3e50; margin: 0; } /* Dark Blue/Gray */
    
    .timer-display {
        font-family: 'Courier New', monospace;
        font-size: 2rem;
        color: white;
        background: #0d6efd; /* Solid Blue Background */
        padding: 0.5rem 1.2rem;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);
    }

    /* Association Section - High Visibility */
    .association-card {
        background: #e7f1ff; /* Light Blue Background */
        border: 2px dashed #aecce5;
        border-radius: 12px;
        padding: 1.2rem 2rem;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .rn-link {
        background: white;
        border: 2px solid #0d6efd;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        text-decoration: none;
        color: #0d6efd;
        font-weight: 700;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .rn-link:hover { background: #0d6efd; color: white; transform: translateY(-2px); }

    .btn-associate {
        background: #198754; /* Green for Action */
        color: white;
        border: none;
        padding: 0.8rem 1.8rem;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
    }
    .btn-associate:hover { background: #146c43; transform: scale(1.05); color: white; }

    /* TAF Tabs - High Contrast Fix */
    .taf-tabs .nav-link {
        color: white; /* White Text */
        font-weight: 700;
        padding: 1rem 1.5rem;
        background: #dc3545; /* RED for Inactive */
        margin-right: 5px;
        border: 1px solid #dc3545;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        opacity: 0.8;
    }
    .taf-tabs .nav-link:hover {
        opacity: 1;
        background: #bb2d3b;
    }
    .taf-tabs .nav-link.active {
        color: white;
        background: #0d6efd; /* Active Blue */
        border-color: #0d6efd;
        opacity: 1;
    }
    
    .section-title {
        background: #f8f9fa;
        color: #212529;
        border-left: 5px solid #0d6efd;
        padding: 0.8rem 1.2rem;
        margin-bottom: 2rem;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 1.2rem;
        border-radius: 4px;
    }

    /* Strong Labels */
    .form-label {
        color: #212529; /* Black/Dark Gray */
        font-weight: 700 !important;
        font-size: 0.95rem;
    }
    .form-check-label {
        font-weight: 600;
        color: #495057;
    }
    h6 { color: #0d6efd; font-weight: 800 !important; margin-bottom: 1rem; }
    
    /* Removed Yellow Alert Style */
</style>
{% endblock %}

{% block content %}
<div class="delivery-container">

    <!-- 1. ENCABEZADO FIJO -->
    <div class="patient-header">
        <div class="patient-info">
            <h1>{{ ficha_parto.ficha_obstetrica.paciente.persona.nombre_completo }}</h1>
            <div class="patient-details">
                <span><i class="bi bi-person-vcard"></i> RUT: {{ ficha_parto.ficha_obstetrica.paciente.persona.rut }}-{{ ficha_parto.ficha_obstetrica.paciente.persona.dv }}</span>
                <span><i class="bi bi-cake"></i> {{ ficha_parto.ficha_obstetrica.paciente.edad }} años</span>
                <span><i class="bi bi-calendar-event"></i> EG: {{ ficha_parto.ficha_obstetrica.edad_gestacional_semanas }}+{{ ficha_parto.ficha_obstetrica.edad_gestacional_dias }}</span>
            </div>
        </div>
        <div class="text-end">
            <div class="small text-muted text-uppercase fw-bold">Tiempo en Sala</div>
            <div id="chronometer" class="timer-display">00:00:00</div>
        </div>
    </div>

    <!-- 2. SECCIÓN DE ASOCIACIONES - DISEÑO LIMPIO V2 -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white border-bottom py-3">
             <h6 class="text-uppercase mb-0 fw-bold text-secondary">
                <i class="bi bi-people-fill me-2"></i>Recién Nacidos Asociados
             </h6>
        </div>
        <div class="card-body">
                <div class="rn-list d-flex flex-wrap gap-2">
                    {% for rn in recien_nacidos %}
                    <a href="{% url 'matrona:ficha_rn' rn.id %}" target="_blank" 
                       class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-2"
                       style="border-radius: 20px; padding: 0.4rem 1rem; font-weight: 600;">
                        <i class="bi bi-person-badge"></i>
                        <span>RN{{ forloop.counter }}</span>
                        <small class="text-muted opacity-75">#{{ rn.id }}</small>
                    </a>
                    {% empty %}
                    <span class="text-muted fst-italic" style="font-size: 0.9rem;">
                        <i class="bi bi-info-circle me-1"></i>No hay recién nacidos asociados aún.
                    </span>
                    {% endfor %}
                 </div>

             
             <div class="d-grid mt-2">
                 <a href="{% url 'matrona:asociar_rn' ficha_parto.id %}" class="btn btn-outline-success border-2 fw-bold py-2">
                    <i class="bi bi-plus-lg me-1"></i> Asociar Nuevo Recién Nacido
                 </a>
             </div>
        </div>
    </div>

    <form id="partoForm" method="POST" action="{% url 'matrona:guardar_registro_parto' ficha_parto.id %}">
        {% csrf_token %}
        
        <!-- Hidden Required Fields -->
        <input type="hidden" name="ficha_obstetrica" value="{{ ficha_parto.ficha_obstetrica.id }}">
        <input type="hidden" name="edad_gestacional_semanas" value="{{ ficha_parto.ficha_obstetrica.edad_gestacional_semanas }}">
        <input type="hidden" name="edad_gestacional_dias" value="{{ ficha_parto.ficha_obstetrica.edad_gestacional_dias }}">
        <input type="hidden" name="fecha_hora_admision" value="{{ ficha_parto.pin_generado_en|date:'Y-m-d\TH:i' }}">
        <input type="hidden" name="numero_registro" value="{{ registro_parto.numero_registro|default:'' }}">


    <!-- 4. TAF - PESTAÑAS DE ATENCIÓN FUNCIONAL -->
    <div class="taf-header-box">
        <ul class="nav nav-tabs taf-tabs" id="tafTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#taf1" type="button">Ingreso</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf2" type="button">Proceso</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf3" type="button">Acompañamiento</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf4" type="button">Analgesia</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf5" type="button">Periné</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#taf6" type="button">Equipo</button></li>
        </ul>
    </div>
    
    <div class="tab-content taf-content">
        
        <!-- TAF 1: INGRESO -->
        <div class="tab-pane fade show active" id="taf1">
            <h5 class="section-title"><i class="bi bi-file-medical"></i> Contexto del Ingreso</h5>
            <div class="row g-4">
                <div class="col-md-3">
                    <label class="form-label">Inicio Proceso Parto</label>
                    <input type="text" class="form-control" value="{{ ficha_parto.pin_generado_en|date:'d/m/Y H:i' }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Edad Gestacional Reales</label>
                    <input type="text" class="form-control" value="{{ ficha_parto.ficha_obstetrica.edad_gestacional_semanas }}+{{ ficha_parto.ficha_obstetrica.edad_gestacional_dias }}" readonly>
                </div>
            </div>

            <!-- Clasificaciones y Posiciones -->
            <h5 class="section-title mt-4"><i class="bi bi-bookmark-check"></i> Clasificación del Parto</h5>
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Clasificación Clínica</label>
                    <select class="form-select" name="tipo_parto">
                        <option value="">Seleccione...</option>
                        {% for t in tipos_parto %}
                        <option value="{{t.id}}" {% if registro_parto.tipo_parto_id == t.id %}selected{% endif %}>{{t.descripcion}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Clasificación Robson</label>
                    <select class="form-select" name="clasificacion_robson">
                        <option value="">Seleccione...</option>
                        {% for r in robsons %}
                        <option value="{{r.id}}" {% if registro_parto.clasificacion_robson_id == r.id %}selected{% endif %}>Grupo {{ r.numero_grupo }} - {{r.descripcion}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Posición Materna</label>
                    <select class="form-select" name="posicion_parto">
                        <option value="">Seleccione...</option>
                        {% for p in posiciones %}
                        <option value="{{p.id}}" {% if registro_parto.posicion_parto_id == p.id %}selected{% endif %}>{{p.descripcion}}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label d-block mb-2">Posiciones Alternativas</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ofrecimiento_posiciones_alternativas" id="checkPosAlt" {% if registro_parto.ofrecimiento_posiciones_alternativas %}checked{% endif %}>
                        <label class="form-check-label" for="checkPosAlt">Se ofrecieron posiciones alternativas durante el trabajo de parto</label>
                    </div>
                </div>
                <!-- Alert Removed -->
            </div>
        </div>

        <!-- TAF 2: PROCESO DE PARTO -->
        <div class="tab-pane fade" id="taf2">
            
            <!-- NUEVA SECCION: MANEJO DEL TRABAJO DE PARTO -->
            <h5 class="section-title mt-4"><i class="bi bi-activity"></i> Manejo y Tiempos</h5>
            <div class="row g-4 bg-light p-3 rounded border">
                <!-- COLUMNA 1: PROCESOS -->
                <div class="col-md-3">
                    <h6 class="small text-muted text-uppercase fw-bold mb-3">Intervenciones</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="monitor_continuo" id="chkMonitor" {% if registro_parto.monitor_continuo %}checked{% endif %}>
                        <label class="form-check-label" for="chkMonitor">Monitor Continuo</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="induccion" id="chkInduccion" {% if registro_parto.induccion %}checked{% endif %}>
                        <label class="form-check-label" for="chkInduccion">Inducción</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="aceleracion" id="chkAceleracion" {% if registro_parto.aceleracion %}checked{% endif %}>
                        <label class="form-check-label" for="chkAceleracion">Aceleración (Oxitocina)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="libertad_movimiento" id="chkLibertad" {% if registro_parto.libertad_movimiento %}checked{% endif %}>
                        <label class="form-check-label" for="chkLibertad">Libertad de Movimiento</label>
                    </div>
                </div>

                <!-- COLUMNA 2: REGIMEN Y MEMBRANAS -->
                <div class="col-md-4">
                    <h6 class="small text-muted text-uppercase fw-bold mb-3">Manejo Clínico</h6>
                    <label class="form-label small">Régimen</label>
                    <select class="form-select mb-3" name="regimen_parto">
                        <option value="">Seleccione...</option>
                        {% for r in regimenes_parto %}
                        <option value="{{ r.id }}" {% if registro_parto.regimen_parto_id == r.id %}selected{% endif %}>{{ r.descripcion }}</option>
                        {% endfor %}
                    </select>

                    <label class="form-label small">Rotura de Membranas</label>
                    <select class="form-select" name="tipo_rotura_membrana">
                        <option value="">Seleccione...</option>
                        {% for rm in tipos_rotura %}
                        <option value="{{ rm.id }}" {% if registro_parto.tipo_rotura_membrana_id == rm.id %}selected{% endif %}>{{ rm.descripcion }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- COLUMNA 3: TIEMPOS TOTALES -->
                <div class="col-md-5">
                    <h6 class="small text-muted text-uppercase fw-bold mb-3">Tiempos Totales (Minutos)</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text" style="width: 140px;">Dilatación</span>
                        <input type="number" class="form-control" name="tiempo_dilatacion_minutos" value="{{ registro_parto.tiempo_dilatacion_minutos|default:'' }}" placeholder="Min">
                    </div>
                    <div class="input-group mb-2">
                        <span class="input-group-text" style="width: 140px;">Expulsivo</span>
                        <input type="number" class="form-control" name="tiempo_expulsivo_minutos" value="{{ registro_parto.tiempo_expulsivo_minutos|default:'' }}" placeholder="Min">
                    </div>
                    <div class="input-group">
                        <span class="input-group-text" style="width: 140px;">Total Parto</span>
                        <input type="number" class="form-control" name="tiempo_trabajo_parto_total_minutos" value="{{ registro_parto.tiempo_trabajo_parto_total_minutos|default:'' }}" placeholder="Min">
                    </div>
                </div>
            </div>
        </div>
            
        <!-- TAF 3: ACOMPAÑAMIENTO -->
        <div class="tab-pane fade" id="taf3">
            <h5 class="section-title"><i class="bi bi-people"></i> Acompañamiento</h5>
            <div class="row g-4">
                 <div class="col-md-5">
                    <label class="form-label">Nombre Acompañante</label>
                    <input type="text" class="form-control" name="nombre_acompanante" value="{{ registro_parto.ficha_obstetrica.nombre_acompanante|default:'' }}" placeholder="Nombre completo"> <!-- Bound to FichaObstetrica original? Check backend -->
                </div>
                <div class="col-md-3">
                    <label class="form-label">Vínculo</label>
                    <select class="form-select" name="persona_acompanante">
                        <option value="">Seleccione...</option>
                        {% for p in personas_acompanante %}
                        <option value="{{p.id}}" {% if registro_parto.persona_acompanante_id == p.id %}selected{% endif %}>{{p.descripcion}}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="col-md-4">
                    <label class="form-label">Motivo NO Acompañado</label>
                    <select class="form-select" name="motivo_parto_no_acompanado">
                        <option value="">(Si aplica) Seleccione...</option>
                        {% for m in motivos_no_acompanado %}
                        <option value="{{m.id}}" {% if registro_parto.motivo_parto_no_acompanado_id == m.id %}selected{% endif %}>{{m.descripcion}}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-12">
                    <h6 class="small text-muted fw-bold">Detalles</h6>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="acompanamiento_preparto" id="chkAcompP" {% if registro_parto.acompanamiento_preparto %}checked{% endif %}>
                        <label class="form-check-label" for="chkAcompP">En Preparto</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="acompanamiento_parto" id="chkAcompPa" {% if registro_parto.acompanamiento_parto %}checked{% endif %}>
                        <label class="form-check-label" for="chkAcompPa">En Parto</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" name="acompanamiento_rn" id="chkAcompRN" {% if registro_parto.acompanamiento_rn %}checked{% endif %}>
                        <label class="form-check-label" for="chkAcompRN">Con Recién Nacido</label>
                    </div>
                     <div class="form-check form-check-inline ms-3">
                        <input class="form-check-input" type="checkbox" name="acompanante_secciona_cordon" id="chkCordon" {% if registro_parto.acompanante_secciona_cordon %}checked{% endif %}>
                        <label class="form-check-label" for="chkCordon">Acompañante secciona cordón</label>
                    </div>
                </div>
                
                 <!-- Ley Dominga -->
                 <div class="col-12 mt-3">
                    <h5 class="section-title" style="font-size: 1rem;"><i class="bi bi-heart"></i> Ley Dominga</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Recuerdos Entregados</label>
                            <textarea class="form-control" name="ley_dominga_recuerdos" rows="2">{{ registro_parto.ley_dominga_recuerdos|default:'' }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Justificación (Si no se entregan)</label>
                            <textarea class="form-control" name="ley_dominga_justificacion" rows="2">{{ registro_parto.ley_dominga_justificacion|default:'' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAF 4: ANALGESIA -->
        <div class="tab-pane fade" id="taf4">
            <h5 class="section-title"><i class="bi bi-capsule"></i> Manejo del Dolor</h5>
            <div class="row g-4">
                 <div class="col-12 mb-3">
                    <h6 class="text-primary fw-bold">Métodos No Farmacológicos</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="analgesia_no_farmacologica" id="chkNoFarm" {% if registro_parto.analgesia_no_farmacologica %}checked{% endif %}>
                        <label class="form-check-label" for="chkNoFarm">Se utilizaron métodos no farmacológicos</label>
                    </div>
                    <div class="p-3 bg-light border rounded">
                        <small class="d-block text-muted mb-2 fw-bold">Seleccione los métodos usados:</small>
                        <div class="row row-cols-md-4 g-2">
                            {% for m in metodos_no_farm %}
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="metodos_no_farmacologicos" value="{{m.id}}" id="metodo{{m.id}}" 
                                    {% if m in registro_parto.metodos_no_farmacologicos.all %}checked{% endif %}>
                                    <label class="form-check-label" for="metodo{{m.id}}">{{m.descripcion}}</label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <h6 class="text-primary fw-bold">Analgesia Farmacológica (Peridural)</h6>
                    <div class="row">
                        <div class="col-md-3">
                             <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="peridural_solicitada_paciente" id="periSol" {% if registro_parto.peridural_solicitada_paciente %}checked{% endif %}>
                                <label class="form-check-label" for="periSol">Solicitada por Paciente</label>
                            </div>
                        </div>
                         <div class="col-md-3">
                             <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="peridural_indicada_medico" id="periInd" {% if registro_parto.peridural_indicada_medico %}checked{% endif %}>
                                <label class="form-check-label" for="periInd">Indicada por Médico</label>
                            </div>
                        </div>
                         <div class="col-md-3">
                             <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="peridural_administrada" id="periAdm" {% if registro_parto.peridural_administrada %}checked{% endif %}>
                                <label class="form-check-label" for="periAdm">Administrada</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                             <label class="form-label">Tiempo Espera (min)</label>
                             <input type="number" class="form-control" name="tiempo_espera_peridural_minutos" value="{{ registro_parto.tiempo_espera_peridural_minutos|default:'' }}">
                        </div>
                    </div>
                </div>
                
                <div class="col-12 mt-3">
                    <h6 class="text-secondary fw-bold">Otras Anestesias (Parto)</h6>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                             <input class="form-check-input" type="checkbox" name="anestesia_local" id="anesLocal" {% if registro_parto.anestesia_local %}checked{% endif %}>
                             <label class="form-check-label" for="anesLocal">Anestesia Local (Periné)</label>
                        </div>
                        <div class="form-check">
                             <input class="form-check-input" type="checkbox" name="anestesia_general" id="anesGral" {% if registro_parto.anestesia_general %}checked{% endif %}>
                             <label class="form-check-label" for="anesGral">Anestesia General</label>
                        </div>
                         <div class="form-check">
                             <input class="form-check-input" type="checkbox" name="anestesia_raquidea" id="anesRaq" {% if registro_parto.anestesia_raquidea %}checked{% endif %}>
                             <label class="form-check-label" for="anesRaq">Raquídea / Espinal</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAF 5: PERINÉ Y ALUMBRAMIENTO -->
        <div class="tab-pane fade" id="taf5">
             <h5 class="section-title"><i class="bi bi-layers"></i> Alumbramiento y Periné</h5>
             
             <div class="row g-4 mb-4">
                 <div class="col-md-5">
                     <h6 class="fw-bold mb-2">Alumbramiento (Placenta)</h6>
                     <div class="form-check">
                         <input class="form-check-input" type="checkbox" name="alumbramiento_dirigido" id="alumDir" {% if registro_parto.alumbramiento_dirigido %}checked{% endif %}>
                         <label class="form-check-label" for="alumDir">Manejo Dirigido (Oxitocina Profiláctica)</label>
                     </div>
                      <div class="form-check mt-2">
                         <input class="form-check-input" type="checkbox" name="retira_placenta" id="retPlac" {% if registro_parto.retira_placenta %}checked{% endif %}>
                         <label class="form-check-label" for="retPlac">Placenta Completa (Revisión)</label>
                     </div>
                 </div>
                 <div class="col-md-3">
                     <label class="form-label">Estado del Periné</label>
                     <select class="form-select" name="estado_perine">
                         <option value="">Seleccione...</option>
                         {% for p in perines %}
                         <option value="{{p.id}}" {% if registro_parto.estado_perine_id == p.id %}selected{% endif %}>{{p.descripcion}}</option>
                         {% endfor %}
                     </select>
                 </div>
             </div>
             
             <hr class="text-muted">
             
             <h6 class="text-danger fw-bold mb-3">Complicaciones Maternas</h6>
             <div class="row row-cols-md-3 g-3 mb-4">
                 <div class="col"><div class="form-check"><input type="checkbox" name="inercia_uterina" class="form-check-input" id="comp1" {% if registro_parto.inercia_uterina %}checked{% endif %}><label for="comp1">Inercia Uterina</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" name="restos_placentarios" class="form-check-input" id="comp2" {% if registro_parto.restos_placentarios %}checked{% endif %}><label for="comp2">Restos Placentarios</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" name="desgarro_vaginal" class="form-check-input" id="comp3" {% if registro_parto.desgarro_vaginal %}checked{% endif %}><label for="comp3">Desgarro / Trauma</label></div></div>
                 <div class="col"><div class="form-check"><input type="checkbox" name="hemorragia_postparto" class="form-check-input" id="comp4" {% if registro_parto.hemorragia_postparto %}checked{% endif %}><label for="comp4">Hemorragia Post-Parto</label></div></div>
                 <!-- Note: Histerectomía and Transfusión not in simple model boolean list, might check model -->
             </div>
             
             <div class="card bg-light border-0 p-3">
                 <h6 class="fw-bold mb-3">Esterilización Quirúrgica</h6>
                 <div class="row align-items-center">
                     <div class="col-md-3">
                         <div class="form-check">
                             <input type="checkbox" name="esterilizacion" class="form-check-input" id="checkEsterilizacion" {% if registro_parto.esterilizacion %}checked{% endif %}>
                             <label class="form-check-label" for="checkEsterilizacion">Se realizó esterilización</label>
                         </div>
                     </div>
                     <div class="col-md-4">
                         <select class="form-select" name="tipo_esterilizacion" id="selTipoEst">
                             <option value="">Tipo...</option>
                             {% for t in tipos_esterilizacion %}
                             <option value="{{t.id}}" {% if registro_parto.tipo_esterilizacion_id == t.id %}selected{% endif %}>{{t.descripcion}}</option>
                             {% endfor %}
                         </select>
                     </div>
                     <div class="col-md-3">
                         <input type="datetime-local" class="form-control" id="fechaEst" value="{{ registro_parto.fecha_esterilizacion|date:'Y-m-d\TH:i' }}">
                     </div>
                 </div>
             </div>
        </div>

        <!-- TAF 6: EQUIPO MATERNO -->
        <div class="tab-pane fade" id="taf6">
            <h5 class="section-title"><i class="bi bi-person-badge"></i> Equipo Responsable (Madre)</h5>
            <p class="text-muted mb-4 d-flex justify-content-between align-items-center">
                <span>Profesionales responsables de la atención directa.</span>
                <span class="badge bg-secondary">{{ matronas_staff.count|add:tens_staff.count }} Asignados</span>
            </p>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Nombre Completo</th>
                            <th>Rol</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if matronas_staff %}
                            {% for m in matronas_staff %}
                            <tr>
                                <td class="fw-bold text-primary">{{ m.usuario.get_full_name }}</td>
                                <td><span class="badge bg-primary">Matrona</span></td>
                                <td>Responsable</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                             <tr><td colspan="3" class="text-center text-muted">No hay matronas asignadas.</td></tr>
                        {% endif %}

                        {% if tens_staff %}
                            {% for t in tens_staff %}
                            <tr>
                                <td class="fw-bold text-success">{{ t.usuario.get_full_name }}</td>
                                <td><span class="badge bg-success">TENS</span></td>
                                <td>Apoyo</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                             <tr><td colspan="3" class="text-center text-muted">No hay TENS asignados.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Acciones Finales (CON BOTON GUARDAR) -->
    <div class="d-flex justify-content-end align-items-center gap-3 mt-4 border-top pt-3">
        <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="bi bi-save"></i> Guardar Ficha
        </button>
        <a href="{% url 'matrona:cierre_parto' ficha_parto.id %}" class="btn btn-dark btn-lg">
            Finalizar Atención Materna <i class="bi bi-arrow-right"></i>
        </a>
    </div>

    </form>


</div>

<script>
    // Timer Logic
    const startTimeIso = "{{ ficha_parto.pin_generado_en|date:'c' }}";
    const start = new Date(startTimeIso).getTime();

    setInterval(() => {
        const now = new Date().getTime();
        const diff = now - start;
        if (diff < 0) return;
        
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('chronometer').textContent = 
            (h<10?"0"+h:h) + ":" + (m<10?"0"+m:m) + ":" + (s<10?"0"+s:s);
    }, 1000);

    // Form Submission Logic
    document.addEventListener('DOMContentLoaded', function() {
        const partoForm = document.getElementById('partoForm');
        
        if (partoForm) {
            partoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                
                // Disable button during current submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Success: Alert and Redirect/Reload
                        alert(data.message || 'Registro guardado correctamente.');
                        if (data.redirect_url) {
                            window.location.href = data.redirect_url;
                        } else {
                            window.location.reload(); 
                        }
                    } else {
                        // Error: Alert and Re-enable
                        let errorMsg = data.message || 'Ha ocurrido un error.';
                        if (data.errors) {
                            const details = Object.values(data.errors).flat().join('\n');
                            errorMsg += '\n\nDetalles:\n' + details;
                        }
                        alert(errorMsg);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexión o del servidor.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
            });
        } else {
            console.error('El formulario partoForm no se encontró en el DOM.');
        }
    });

</script>
{% endblock %}
