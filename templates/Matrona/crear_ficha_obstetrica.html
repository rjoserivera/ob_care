<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Ficha Obstétrica</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --matrona-primary: #f093fb;
            --matrona-secondary: #f5576c;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Navbar Styles */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: white !important;
        }

        .navbar-brand i {
            margin-right: 0.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: 500;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: white !important;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item:hover {
            background-color: #f0f0f0;
        }

        main {
            min-height: calc(100vh - 150px);
        }

        footer {
            margin-top: auto;
            border-top: 1px solid #dee2e6;
        }

        /* Navbar Matrona */
        .navbar-matrona {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
        }

        /* Ficha Container */
        .ficha-container {
            max-width: 1200px;
            margin: 2rem auto;
        }

        .ficha-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
        }

        .ficha-header h2 {
            margin-bottom: 0.5rem;
        }

        .persona-info-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #f5576c;
        }

        .persona-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }

        .info-value {
            font-size: 1.1rem;
            color: #333;
            font-weight: 500;
        }

        .ficha-form {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f5576c;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title i {
            color: #f5576c;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .form-control,
        .form-select {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #f5576c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
        }

        .form-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.3rem;
        }

        /* Tabla de Dilatación */
        .dilatacion-container {
            background: #fff5f7;
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid #f5576c;
        }

        .dilatacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dilatacion-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .dilatacion-table th {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
        }

        .dilatacion-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .dilatacion-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .dilatacion-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #eee;
            background: white;
        }

        .dilatacion-table tr:last-child td:first-child {
            border-radius: 0 0 0 8px;
        }

        .dilatacion-table tr:last-child td:last-child {
            border-radius: 0 0 8px 0;
        }

        .dilatacion-input {
            width: 60px;
            text-align: center;
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-weight: 600;
        }

        .dilatacion-input:focus {
            border-color: #f5576c;
            outline: none;
        }

        /* Indicadores de Dilatación */
        .dilatacion-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-progresando {
            background: #d4edda;
            color: #155724;
        }

        .status-estancada {
            background: #f8d7da;
            color: #721c24;
        }

        .status-lista {
            background: #cce5ff;
            color: #004085;
        }

        /* Medicamentos */
        .medicamento-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #f5576c;
            position: relative;
        }

        .medicamento-card .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .medicamento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        /* Personal Asignado */
        .personal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .personal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .personal-card.matrona {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .personal-card.tens {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .personal-card.medico {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .personal-card i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .personal-card .cantidad {
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Botones */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-add {
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: none;
            border-left: 4px solid;
        }

        .alert-info {
            background-color: #fde8f0;
            border-color: #f5576c;
            color: #a83950;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #721c24;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        /* VIH Tests */
        .vih-test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border-left: 4px solid #17a2b8;
        }

        .vih-test-title {
            font-weight: 600;
            color: #17a2b8;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Acompañante */
        .acompanante-toggle {
            margin-bottom: 1.5rem;
        }

        .acompanante-fields {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            display: none;
        }

        .acompanante-fields.active {
            display: block;
        }

        /* Parto Section */
        .parto-decision {
            background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid #f5576c;
        }

        .parto-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .parto-option {
            flex: 1;
            min-width: 200px;
            padding: 1.5rem;
            border: 3px solid #ddd;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .parto-option:hover {
            border-color: #f5576c;
            transform: translateY(-3px);
        }

        .parto-option.selected {
            border-color: #f5576c;
            background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%);
        }

        .parto-option i {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #f5576c;
        }

        .parto-option h5 {
            margin: 0;
            color: #333;
        }

        /* Bebés Counter */
        .bebes-counter {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .bebes-counter button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #f5576c;
            background: white;
            color: #f5576c;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bebes-counter button:hover {
            background: #f5576c;
            color: white;
        }

        .bebes-counter .count {
            font-size: 2rem;
            font-weight: bold;
            color: #f5576c;
            min-width: 60px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .parto-options {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-matrona sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hospital"></i>
                Obstetric Care
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!-- Menús de navegación... -->
                    <li class="nav-item">
                        <a class="nav-link" href="/matrona/">
                            <i class="bi bi-house-door"></i> Menú Matrona
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <main class="container-fluid py-4">
        <div class="ficha-container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="/matrona/">Matrona</a></li>
                    <li class="breadcrumb-item active">Crear Ficha Obstétrica</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="ficha-header">
                <h2><i class="bi bi-file-earmark-medical"></i> Crear Ficha Obstétrica</h2>
                <p>Completa los datos de la ficha obstétrica. Los campos en verde se calculan automáticamente.</p>
            </div>

            <!-- Información Paciente -->
            {% if persona %}
            <div class="persona-info-card">
                <h3 style="margin-bottom: 1.5rem; color: #333;">
                    <i class="bi bi-person-check-fill"></i> Información de la Persona
                </h3>

                <div class="persona-info-grid">
                    <div class="info-item">
                        <div class="info-label">Nombre Completo</div>
                        <div class="info-value">{{ persona.Nombre }} {{ persona.Apellido_Paterno }} {{ persona.Apellido_Materno }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">RUT</div>
                        <div class="info-value">{{ persona.Rut }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Edad</div>
                        <div class="info-value">{{ edad }} años</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de Nacimiento</div>
                        <div class="info-value">{{ persona.Fecha_nacimiento|date:"d/m/Y" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Teléfono</div>
                        <div class="info-value">{{ persona.Telefono|default:"No registrado" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Dirección</div>
                        <div class="info-value">{{ persona.Direccion|default:"No registrada" }}</div>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            {% else %}
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error:</strong> No se encontró la información de la persona.
                <a href="{% url 'matrona:seleccionar_persona_ficha' %}">Volver a seleccionar</a>
            </div>
            {% endif %}
            <div class="ficha-form">
                <form method="post" id="fichaForm" novalidate>
                    {% csrf_token %}

                    <!-- ==================== SECCIÓN: ACOMPAÑANTE ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-people"></i> Acompañante y Contacto de Emergencia
                        </div>

                        <!-- Toggle Acompañante -->
                        <div class="acompanante-toggle">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="tieneAcompanante" name="tiene_acompanante">
                                <label class="form-check-label" for="tieneAcompanante">
                                    <strong>¿Viene con acompañante?</strong>
                                </label>
                            </div>
                        </div>

                        <!-- Campos Acompañante (ocultos por defecto) -->
                        <div class="acompanante-fields" id="acompananteFields">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Nombre Completo del Acompañante <span class="text-danger">*</span></label>
                                    <input type="text" name="nombre_acompanante" class="form-control" 
                                           placeholder="Nombre completo" maxlength="200" id="id_nombre_acompanante">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">RUT del Acompañante <span class="text-danger">*</span></label>
                                    <input type="text" name="rut_acompanante" class="form-control" 
                                           placeholder="12345678-9" maxlength="12" id="id_rut_acompanante">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Parentesco <span class="text-danger">*</span></label>
                                    <select name="parentesco_acompanante" class="form-select" id="id_parentesco_acompanante">
                                        <option value="">Seleccione parentesco...</option>
                                        <option value="PAREJA">Pareja</option>
                                        <option value="ESPOSO">Esposo/a</option>
                                        <option value="MADRE">Madre</option>
                                        <option value="PADRE">Padre</option>
                                        <option value="HERMANO">Hermano/a</option>
                                        <option value="SUEGRA">Suegra/o</option>
                                        <option value="AMIGO">Amigo/a</option>
                                        <option value="OTRO">Otro</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Teléfono del Acompañante</label>
                                    <input type="tel" name="telefono_acompanante" class="form-control" 
                                           placeholder="+56912345678" id="id_telefono_acompanante">
                                </div>
                            </div>
                        </div>

                        <!-- Contacto de Emergencia -->
                        <h5 style="margin-top: 1.5rem; color: #f5576c;">
                            <i class="bi bi-telephone-fill"></i> Contacto de Emergencia
                        </h5>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nombre Contacto Emergencia <span class="text-danger">*</span></label>
                                <input type="text" name="nombre_contacto_emergencia" class="form-control" 
                                       placeholder="Nombre completo" maxlength="200" required id="id_nombre_contacto_emergencia">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Teléfono de Emergencia <span class="text-danger">*</span></label>
                                <input type="tel" name="telefono_emergencia" class="form-control" 
                                       placeholder="+56912345678" required id="id_telefono_emergencia">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Parentesco Contacto Emergencia <span class="text-danger">*</span></label>
                                <select name="parentesco_contacto_emergencia" class="form-select" required id="id_parentesco_emergencia">
                                    <option value="">Seleccione parentesco...</option>
                                    <option value="PAREJA">Pareja</option>
                                    <option value="ESPOSO">Esposo/a</option>
                                    <option value="MADRE">Madre</option>
                                    <option value="PADRE">Padre</option>
                                    <option value="HERMANO">Hermano/a</option>
                                    <option value="HIJO">Hijo/a</option>
                                    <option value="OTRO">Otro familiar</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: DATOS GENERALES ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-info-circle"></i> Datos Generales del Embarazo
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="plan_de_parto" class="form-check-input" id="id_plan_de_parto">
                                    ¿Tiene Plan de Parto?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="visita_guiada" class="form-check-input" id="id_visita_guiada">
                                    ¿Realizó Visita Guiada?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Consultorio o Centro de Origen</label>
                                <select name="consultorio_origen" class="form-select" id="id_consultorio_origen">
                                    <option value="" selected>---------</option>
                                    <option value="2">CESFAM Los Volcanes</option>
                                    <option value="3">CESFAM San Ramón</option>
                                    <option value="1">CESFAM Ultraestación</option>
                                    <option value="4">Hospital Herminda Martín</option>
                                    <option value="5">Particular</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: MEDIDAS ANTROPOMÉTRICAS ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-rulers"></i> Medidas Antropométricas
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Peso Actual (kg) <span class="text-danger">*</span></label>
                                <input type="number" name="peso_actual" class="form-control" step="0.01" 
                                       placeholder="Ej: 65.5" id="id_peso_actual">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Talla (cm) <span class="text-danger">*</span></label>
                                <input type="number" name="talla_actual" class="form-control" step="0.01" 
                                       placeholder="Ej: 165" id="id_talla_actual">
                            </div>

                            <div class="form-group">
                                <label class="form-label"><strong>IMC (Calculado)</strong></label>
                                <input type="number" name="imc" class="form-control" step="0.01" 
                                       placeholder="Automático" readonly id="id_imc" style="background-color: #e8f5e9;">
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: HISTORIA OBSTÉTRICA ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-heart-pulse"></i> Historia Obstétrica
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Número de Gestaciones <span class="text-danger">*</span></label>
                                <input type="number" name="numero_gestas" value="1" class="form-control" min="0" required id="id_numero_gestas">
                                <small class="form-text">Incluye embarazos anteriores + actual</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Número de Partos</label>
                                <input type="number" name="numero_partos" value="0" class="form-control" min="0" required id="id_numero_partos">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Partos Vaginales</label>
                                <input type="number" name="partos_vaginales" value="0" class="form-control" min="0" required id="id_partos_vaginales">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Partos por Cesárea</label>
                                <input type="number" name="partos_cesareas" value="0" class="form-control" min="0" required id="id_partos_cesareas">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Número de Abortos</label>
                                <input type="number" name="numero_abortos" value="0" class="form-control" min="0" required id="id_numero_abortos">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nacidos Vivos</label>
                                <input type="number" name="nacidos_vivos" value="0" class="form-control" min="0" required id="id_nacidos_vivos">
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: EMBARAZO ACTUAL ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-calendar-heart"></i> Embarazo Actual
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Fecha Última Menstruación (FUM) <span class="text-danger">*</span></label>
                                <input type="date" name="fecha_ultima_regla" class="form-control" id="id_fecha_ultima_regla">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Semanas de Gestación (Calculadas)</label>
                                <input type="number" name="edad_gestacional_semanas" class="form-control" 
                                       placeholder="Automático" readonly id="id_edad_gestacional_semanas" style="background-color: #e8f5e9;">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Días Adicionales (Calculados)</label>
                                <input type="number" name="edad_gestacional_dias" value="0" class="form-control" 
                                       readonly id="id_edad_gestacional_dias" style="background-color: #e8f5e9;">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Fecha Probable de Parto (Calculada)</label>
                                <input type="date" name="fecha_probable_parto" class="form-control" 
                                       readonly id="id_fecha_probable_parto" style="background-color: #e8f5e9;">
                            </div>
                        </div>

                        <!-- Cantidad de Bebés -->
                        <div style="margin-top: 1.5rem;">
                            <label class="form-label"><i class="bi bi-people-fill"></i> Cantidad de Bebés</label>
                            <div class="bebes-counter">
                                <button type="button" onclick="cambiarCantidadBebes(-1)">-</button>
                                <span class="count" id="cantidadBebes">1</span>
                                <input type="hidden" name="cantidad_bebes" id="id_cantidad_bebes" value="1">
                                <button type="button" onclick="cambiarCantidadBebes(1)">+</button>
                                <span style="color: #666; margin-left: 1rem;">bebé(s) esperado(s)</span>
                            </div>

                            <!-- Personal Requerido (calculado automáticamente) -->
                            <div class="personal-grid" style="margin-top: 1.5rem;" id="personalRequerido">
                                <div class="personal-card medico">
                                    <i class="bi bi-person-badge"></i>
                                    <div class="cantidad" id="cantidadMedicos">1</div>
                                    <div>Médico(s)</div>
                                </div>
                                <div class="personal-card matrona">
                                    <i class="bi bi-heart-pulse"></i>
                                    <div class="cantidad" id="cantidadMatronas">2</div>
                                    <div>Matrona(s)</div>
                                </div>
                                <div class="personal-card tens">
                                    <i class="bi bi-clipboard2-pulse"></i>
                                    <div class="cantidad" id="cantidadTens">2</div>
                                    <div>TENS</div>
                                </div>
                            </div>
                            <small class="form-text">Personal requerido calculado: 1 médico, 2 matronas y 2 TENS por cada bebé</small>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: EXÁMENES VIH ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-droplet"></i> Exámenes VIH
                        </div>

                        <div class="form-row">
                            <!-- VIH Test 1 -->
                            <div class="vih-test-card">
                                <div class="vih-test-title">
                                    <i class="bi bi-1-circle-fill"></i> Test VIH 1
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Fecha Examen</label>
                                        <input type="date" name="vih1_fecha" class="form-control" id="id_vih1_fecha">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Resultado</label>
                                        <select name="vih1_resultado" class="form-select" id="id_vih1_resultado">
                                            <option value="">Sin realizar</option>
                                            <option value="NEGATIVO">Negativo</option>
                                            <option value="POSITIVO">Positivo</option>
                                            <option value="INDETERMINADO">Indeterminado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- VIH Test 2 -->
                            <div class="vih-test-card">
                                <div class="vih-test-title">
                                    <i class="bi bi-2-circle-fill"></i> Test VIH 2
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Fecha Examen</label>
                                        <input type="date" name="vih2_fecha" class="form-control" id="id_vih2_fecha">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Resultado</label>
                                        <select name="vih2_resultado" class="form-select" id="id_vih2_resultado">
                                            <option value="">Sin realizar</option>
                                            <option value="NEGATIVO">Negativo</option>
                                            <option value="POSITIVO">Positivo</option>
                                            <option value="INDETERMINADO">Indeterminado</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: PATOLOGÍAS ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-exclamation-triangle"></i> Patologías
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="preeclampsia_severa" class="form-check-input" id="id_preeclampsia_severa">
                                    ¿Preeclampsia Severa?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="eclampsia" class="form-check-input" id="id_eclampsia">
                                    ¿Eclampsia?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="sepsis_infeccion_sistemia" class="form-check-input" id="id_sepsis_infeccion_sistemia">
                                    ¿Sepsis o Infección Sistémica?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="infeccion_ovular" class="form-check-input" id="id_infeccion_ovular">
                                    ¿Infección Ovular?
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Otras Patologías</label>
                            <textarea name="otras_patologias" rows="3" class="form-control" 
                                      placeholder="Describa otras patologías si las hay..." id="id_otras_patologias"></textarea>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: CONTROL PRENATAL ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-clipboard-check"></i> Control Prenatal
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-check-label">
                                    <input type="checkbox" name="control_prenatal" class="form-check-input" id="id_control_prenatal" checked>
                                    ¿Tuvo Control Prenatal?
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Número de Controles</label>
                                <input type="number" name="numero_controles" value="0" class="form-control" min="0" required id="id_numero_controles">
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: MEDICAMENTOS ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-capsule"></i> Medicamentos Asociados
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Agregue los medicamentos que se administrarán a la paciente durante su estadía.
                        </div>

                        <div id="medicamentosContainer">
                            <!-- Los medicamentos se agregan dinámicamente aquí -->
                        </div>

                        <button type="button" class="btn btn-add" onclick="agregarMedicamento()">
                            <i class="bi bi-plus-circle"></i> Agregar Medicamento
                        </button>

                        <!-- Template oculto para medicamentos -->
                        <template id="medicamentoTemplate">
                            <div class="medicamento-card" data-index="__INDEX__">
                                <button type="button" class="remove-btn" onclick="removerMedicamento(this)">
                                    <i class="bi bi-x"></i>
                                </button>
                                <div class="medicamento-grid">
                                    <div class="form-group">
                                        <label class="form-label">Medicamento</label>
                                        <select name="medicamentos[__INDEX__][medicamento]" class="form-select" required>
                                            <option value="">Seleccione...</option>
                                            <option value="1">Oxitocina</option>
                                            <option value="2">Misoprostol</option>
                                            <option value="3">Sulfato de Magnesio</option>
                                            <option value="4">Metilergonovina</option>
                                            <option value="5">Nifedipino</option>
                                            <option value="6">Betametasona</option>
                                            <option value="7">Ampicilina</option>
                                            <option value="8">Paracetamol</option>
                                            <option value="9">Hierro</option>
                                            <option value="10">Ácido Fólico</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Cantidad</label>
                                        <input type="number" name="medicamentos[__INDEX__][cantidad]" class="form-control" 
                                               placeholder="Ej: 10" min="1" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dosis</label>
                                        <input type="text" name="medicamentos[__INDEX__][dosis]" class="form-control" 
                                               placeholder="Ej: 500mg c/8hrs" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Fecha Inicio</label>
                                        <input type="date" name="medicamentos[__INDEX__][fecha_inicio]" class="form-control" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Fecha Término</label>
                                        <input type="date" name="medicamentos[__INDEX__][fecha_termino]" class="form-control">
                                        <small class="form-text">Dejar vacío si es continuo</small>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- ==================== SECCIÓN: REGISTRO DE DILATACIÓN ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-graph-up"></i> Registro de Dilatación Cervical
                        </div>

                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Importante:</strong> El registro de dilatación se inicia cuando la paciente alcanza 4 cm. 
                            Se registra cada hora. Si hay 3 registros consecutivos con el mismo valor, se considera estancamiento 
                            y se habilita la opción de cesárea.
                        </div>

                        <div class="dilatacion-container">
                            <div class="dilatacion-header">
                                <h5><i class="bi bi-rulers"></i> Control Horario de Dilatación</h5>
                                <div>
                                    <span class="dilatacion-status" id="dilatacionStatus">
                                        <i class="bi bi-hourglass"></i> Esperando registro
                                    </span>
                                </div>
                            </div>

                            <div class="form-row" style="margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Dilatación Inicial (cm)</label>
                                    <input type="number" name="dilatacion_inicial" class="form-control" 
                                           min="0" max="10" step="1" placeholder="0-10" id="id_dilatacion_inicial">
                                    <small class="form-text">El seguimiento horario inicia desde 4 cm</small>
                                </div>
                            </div>

                            <div id="registrosDilatacionContainer" style="display: none;">
                                <table class="dilatacion-table">
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Dilatación (cm)</th>
                                            <th>Observación</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dilatacionTableBody">
                                        <!-- Los registros se agregan dinámicamente -->
                                    </tbody>
                                </table>

                                <button type="button" class="btn btn-add" onclick="agregarRegistroDilatacion()" 
                                        style="margin-top: 1rem;" id="btnAgregarDilatacion">
                                    <i class="bi bi-plus-circle"></i> Agregar Registro (1 hora)
                                </button>
                            </div>

                            <!-- Resumen de Dilatación -->
                            <div id="resumenDilatacion" style="margin-top: 1.5rem; display: none;">
                                <div class="alert" id="alertaDilatacion">
                                    <!-- Mensaje dinámico sobre el estado de dilatación -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== SECCIÓN: TIPO DE PARTO ==================== -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="bi bi-heart"></i> Tipo de Parto
                        </div>

                        <div class="parto-decision">
                            <p style="color: #666; margin-bottom: 1rem;">
                                Seleccione el tipo de parto. El parto vaginal requiere al menos 8 cm de dilatación. 
                                La cesárea se habilita automáticamente si hay estancamiento en la dilatación.
                            </p>

                            <div class="parto-options">
                                <div class="parto-option" id="opcionVaginal" onclick="seleccionarTipoParto('VAGINAL')">
                                    <i class="bi bi-heart-fill"></i>
                                    <h5>Parto Vaginal</h5>
                                    <small>Requiere ≥8 cm de dilatación</small>
                                    <input type="radio" name="tipo_parto" value="VAGINAL" style="display: none;" id="id_tipo_parto_vaginal">
                                </div>

                                <div class="parto-option" id="opcionCesarea" onclick="seleccionarTipoParto('CESAREA')">
                                    <i class="bi bi-scissors"></i>
                                    <h5>Cesárea</h5>
                                    <small>Por indicación médica o estancamiento</small>
                                    <input type="radio" name="tipo_parto" value="CESAREA" style="display: none;" id="id_tipo_parto_cesarea">
                                </div>
                            </div>

                            <div id="alertaTipoParto" style="margin-top: 1rem; display: none;">
                                <!-- Alertas sobre validación del tipo de parto -->
                            </div>

                            <!-- Botón Iniciar Proceso de Parto -->
                            <div style="margin-top: 1.5rem; text-align: center;">
                                <button type="button" class="btn btn-success btn-lg" id="btnIniciarParto" 
                                        onclick="iniciarProcesoParto()" disabled>
                                    <i class="bi bi-play-circle"></i> Iniciar Proceso de Parto
                                </button>
                                <p id="mensajeIniciarParto" style="color: #666; margin-top: 0.5rem; font-size: 0.9rem;">
                                    Complete los registros de dilatación y seleccione el tipo de parto
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== BOTONES FINALES ==================== -->
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Guardar Ficha
                        </button>

                        <a href="/matrona/seleccionar-persona/" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center text-muted py-3 mt-5">
        <div class="container">
            <p class="mb-0">© 2025 Hospital Clínico Herminda Martín - Sistema de Trazabilidad Obstétrica</p>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript -->
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let medicamentoIndex = 0;
        let registroDilatacionIndex = 0;
        let registrosDilatacion = [];
        let tipoPartoSeleccionado = null;
        let procesoPartoHabilitado = false;

        // ==================== FUNCIONES DE INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', function () {
            // Cálculos automáticos
            setupCalculosAutomaticos();
            
            // Toggle acompañante
            setupAcompananteToggle();
            
            // Dilatación inicial
            setupDilatacionInicial();
        });

        // ==================== CÁLCULOS AUTOMÁTICOS ====================
        function setupCalculosAutomaticos() {
            const fumInput = document.getElementById('id_fecha_ultima_regla');
            const pesoInput = document.getElementById('id_peso_actual');
            const tallaInput = document.getElementById('id_talla_actual');

            fumInput.addEventListener('change', calcularEdadGestacional);
            pesoInput.addEventListener('input', calcularIMC);
            tallaInput.addEventListener('input', calcularIMC);
        }

        function calcularEdadGestacional() {
            const fumInput = document.getElementById('id_fecha_ultima_regla');
            const semanasInput = document.getElementById('id_edad_gestacional_semanas');
            const diasInput = document.getElementById('id_edad_gestacional_dias');
            const fppInput = document.getElementById('id_fecha_probable_parto');

            const fum = fumInput.value;
            if (!fum) return;

            const fumDate = new Date(fum);
            const hoy = new Date();
            const milisegundos = hoy - fumDate;
            const diasTranscurridos = Math.floor(milisegundos / (1000 * 60 * 60 * 24));

            const semanas = Math.min(Math.floor(diasTranscurridos / 7), 42);
            const dias = diasTranscurridos % 7;

            semanasInput.value = semanas;
            diasInput.value = dias;

            // FPP = FUM + 280 días
            const fppDate = new Date(fumDate);
            fppDate.setDate(fppDate.getDate() + 280);
            fppInput.value = fppDate.toISOString().split('T')[0];
        }

        function calcularIMC() {
            const peso = parseFloat(document.getElementById('id_peso_actual').value);
            const talla = parseFloat(document.getElementById('id_talla_actual').value);
            const imcInput = document.getElementById('id_imc');

            if (peso && talla && peso > 0 && talla > 0) {
                const tallaMetros = talla / 100;
                const imc = peso / (tallaMetros * tallaMetros);
                imcInput.value = imc.toFixed(2);
            } else {
                imcInput.value = '';
            }
        }

        // ==================== ACOMPAÑANTE ====================
        function setupAcompananteToggle() {
            const toggle = document.getElementById('tieneAcompanante');
            const fields = document.getElementById('acompananteFields');

            toggle.addEventListener('change', function() {
                if (this.checked) {
                    fields.classList.add('active');
                } else {
                    fields.classList.remove('active');
                    // Limpiar campos
                    fields.querySelectorAll('input, select').forEach(el => el.value = '');
                }
            });
        }

        // ==================== CANTIDAD DE BEBÉS ====================
        function cambiarCantidadBebes(delta) {
            const countElement = document.getElementById('cantidadBebes');
            const inputElement = document.getElementById('id_cantidad_bebes');
            let count = parseInt(countElement.textContent);
            
            count = Math.max(1, Math.min(5, count + delta)); // Mínimo 1, máximo 5
            
            countElement.textContent = count;
            inputElement.value = count;
            
            // Actualizar personal requerido
            document.getElementById('cantidadMedicos').textContent = count;
            document.getElementById('cantidadMatronas').textContent = count * 2;
            document.getElementById('cantidadTens').textContent = count * 2;
        }

        // ==================== MEDICAMENTOS ====================
        function agregarMedicamento() {
            const container = document.getElementById('medicamentosContainer');
            const template = document.getElementById('medicamentoTemplate');
            const clone = template.content.cloneNode(true);
            
            // Reemplazar índice
            clone.querySelector('.medicamento-card').dataset.index = medicamentoIndex;
            clone.querySelectorAll('[name*="__INDEX__"]').forEach(el => {
                el.name = el.name.replace('__INDEX__', medicamentoIndex);
            });
            
            container.appendChild(clone);
            medicamentoIndex++;
        }

        function removerMedicamento(btn) {
            btn.closest('.medicamento-card').remove();
        }

        // ==================== DILATACIÓN ====================
        function setupDilatacionInicial() {
            const dilatacionInicial = document.getElementById('id_dilatacion_inicial');
            
            dilatacionInicial.addEventListener('change', function() {
                const valor = parseInt(this.value);
                const container = document.getElementById('registrosDilatacionContainer');
                
                if (valor >= 4) {
                    container.style.display = 'block';
                    // Agregar primer registro automático
                    if (registrosDilatacion.length === 0) {
                        agregarRegistroDilatacionConValor(valor);
                    }
                } else {
                    container.style.display = 'none';
                }
                
                actualizarEstadoDilatacion();
            });
        }

        function agregarRegistroDilatacion() {
            agregarRegistroDilatacionConValor(null);
        }

        function agregarRegistroDilatacionConValor(valorInicial) {
            const tbody = document.getElementById('dilatacionTableBody');
            const now = new Date();
            
            // Calcular hora (si hay registros previos, sumar 1 hora)
            if (registrosDilatacion.length > 0) {
                const ultimoRegistro = registrosDilatacion[registrosDilatacion.length - 1];
                now.setTime(new Date(ultimoRegistro.hora).getTime() + 60 * 60 * 1000);
            }
            
            const horaStr = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
            
            const row = document.createElement('tr');
            row.dataset.index = registroDilatacionIndex;
            row.innerHTML = `
                <td>
                    <strong>${horaStr}</strong>
                    <input type="hidden" name="dilatacion[${registroDilatacionIndex}][hora]" value="${now.toISOString()}">
                </td>
                <td>
                    <input type="number" class="dilatacion-input" 
                           name="dilatacion[${registroDilatacionIndex}][valor]" 
                           min="1" max="10" step="1" 
                           value="${valorInicial || ''}"
                           onchange="actualizarEstadoDilatacion()"
                           required>
                    <span>cm</span>
                </td>
                <td>
                    <input type="text" class="form-control" style="width: 150px; display: inline-block;"
                           name="dilatacion[${registroDilatacionIndex}][observacion]" 
                           placeholder="Opcional">
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerRegistroDilatacion(${registroDilatacionIndex})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            
            registrosDilatacion.push({
                index: registroDilatacionIndex,
                hora: now.toISOString(),
                valor: valorInicial
            });
            
            registroDilatacionIndex++;
            actualizarEstadoDilatacion();
        }

        function removerRegistroDilatacion(index) {
            const row = document.querySelector(`tr[data-index="${index}"]`);
            if (row) {
                row.remove();
                registrosDilatacion = registrosDilatacion.filter(r => r.index !== index);
                actualizarEstadoDilatacion();
            }
        }

        function actualizarEstadoDilatacion() {
            const valores = [];
            document.querySelectorAll('.dilatacion-input').forEach(input => {
                if (input.value) {
                    valores.push(parseInt(input.value));
                }
            });

            const statusElement = document.getElementById('dilatacionStatus');
            const resumenElement = document.getElementById('resumenDilatacion');
            const alertaElement = document.getElementById('alertaDilatacion');
            
            if (valores.length === 0) {
                statusElement.innerHTML = '<i class="bi bi-hourglass"></i> Esperando registro';
                statusElement.className = 'dilatacion-status';
                resumenElement.style.display = 'none';
                return;
            }

            const ultimoValor = valores[valores.length - 1];
            
            // Verificar estancamiento (3 valores iguales consecutivos)
            let estancada = false;
            if (valores.length >= 3) {
                const ultimos3 = valores.slice(-3);
                estancada = ultimos3.every(v => v === ultimos3[0]);
            }

            resumenElement.style.display = 'block';

            if (estancada) {
                statusElement.innerHTML = '<i class="bi bi-exclamation-circle"></i> ESTANCAMIENTO';
                statusElement.className = 'dilatacion-status status-estancada';
                alertaElement.className = 'alert alert-danger';
                alertaElement.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>¡Estancamiento detectado!</strong> Se han registrado 3 valores consecutivos de ${ultimos3[0]} cm.
                    Se recomienda proceder con cesárea.
                `;
                habilitarCesarea(true);
            } else if (ultimoValor >= 8) {
                statusElement.innerHTML = '<i class="bi bi-check-circle"></i> LISTA PARA PARTO';
                statusElement.className = 'dilatacion-status status-lista';
                alertaElement.className = 'alert alert-success';
                alertaElement.innerHTML = `
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Dilatación completa:</strong> ${ultimoValor} cm. Se puede proceder con parto vaginal.
                `;
                habilitarPartoVaginal(true);
            } else {
                statusElement.innerHTML = '<i class="bi bi-arrow-up-circle"></i> PROGRESANDO';
                statusElement.className = 'dilatacion-status status-progresando';
                alertaElement.className = 'alert alert-info';
                alertaElement.innerHTML = `
                    <i class="bi bi-info-circle"></i>
                    <strong>Dilatación actual:</strong> ${ultimoValor} cm. Continuar monitoreo.
                    Faltan ${8 - ultimoValor} cm para parto vaginal.
                `;
            }
            
            validarTipoParto();
        }

        // ==================== TIPO DE PARTO ====================
        function seleccionarTipoParto(tipo) {
            const opcionVaginal = document.getElementById('opcionVaginal');
            const opcionCesarea = document.getElementById('opcionCesarea');
            const radioVaginal = document.getElementById('id_tipo_parto_vaginal');
            const radioCesarea = document.getElementById('id_tipo_parto_cesarea');
            
            opcionVaginal.classList.remove('selected');
            opcionCesarea.classList.remove('selected');
            
            if (tipo === 'VAGINAL') {
                if (!puedePartoVaginal()) {
                    mostrarAlertaTipoParto('danger', 'No se puede seleccionar parto vaginal. La dilatación debe ser ≥8 cm.');
                    return;
                }
                opcionVaginal.classList.add('selected');
                radioVaginal.checked = true;
            } else {
                opcionCesarea.classList.add('selected');
                radioCesarea.checked = true;
            }
            
            tipoPartoSeleccionado = tipo;
            validarTipoParto();
        }

        function puedePartoVaginal() {
            const valores = [];
            document.querySelectorAll('.dilatacion-input').forEach(input => {
                if (input.value) valores.push(parseInt(input.value));
            });
            
            if (valores.length === 0) return false;
            return valores[valores.length - 1] >= 8;
        }

        function hayEstancamiento() {
            const valores = [];
            document.querySelectorAll('.dilatacion-input').forEach(input => {
                if (input.value) valores.push(parseInt(input.value));
            });
            
            if (valores.length < 3) return false;
            const ultimos3 = valores.slice(-3);
            return ultimos3.every(v => v === ultimos3[0]);
        }

        function habilitarPartoVaginal(habilitar) {
            const opcion = document.getElementById('opcionVaginal');
            opcion.style.opacity = habilitar ? '1' : '0.5';
            opcion.style.pointerEvents = habilitar ? 'auto' : 'none';
        }

        function habilitarCesarea(forzar) {
            const opcion = document.getElementById('opcionCesarea');
            if (forzar) {
                // Seleccionar automáticamente cesárea si hay estancamiento
                seleccionarTipoParto('CESAREA');
            }
        }

        function validarTipoParto() {
            const btnIniciar = document.getElementById('btnIniciarParto');
            const mensaje = document.getElementById('mensajeIniciarParto');
            
            // Condiciones para habilitar el botón
            const tieneRegistros = registrosDilatacion.length > 0;
            const tieneTipoSeleccionado = tipoPartoSeleccionado !== null;
            const estancada = hayEstancamiento();
            const dilatacionSuficiente = puedePartoVaginal();
            
            // Se puede iniciar si:
            // 1. Cesárea seleccionada y hay estancamiento
            // 2. Vaginal seleccionado y dilatación >= 8
            let puedeIniciar = false;
            
            if (tipoPartoSeleccionado === 'CESAREA' && (estancada || tieneRegistros)) {
                puedeIniciar = true;
                mensaje.textContent = 'Listo para iniciar cesárea';
                mensaje.style.color = '#28a745';
            } else if (tipoPartoSeleccionado === 'VAGINAL' && dilatacionSuficiente) {
                puedeIniciar = true;
                mensaje.textContent = 'Listo para iniciar parto vaginal';
                mensaje.style.color = '#28a745';
            } else if (!tieneTipoSeleccionado) {
                mensaje.textContent = 'Seleccione el tipo de parto';
                mensaje.style.color = '#666';
            } else if (tipoPartoSeleccionado === 'VAGINAL' && !dilatacionSuficiente) {
                mensaje.textContent = 'La dilatación debe ser ≥8 cm para parto vaginal';
                mensaje.style.color = '#dc3545';
            }
            
            btnIniciar.disabled = !puedeIniciar;
        }

        function mostrarAlertaTipoParto(tipo, mensaje) {
            const alerta = document.getElementById('alertaTipoParto');
            alerta.style.display = 'block';
            alerta.className = `alert alert-${tipo}`;
            alerta.innerHTML = `<i class="bi bi-exclamation-circle"></i> ${mensaje}`;
            
            setTimeout(() => {
                alerta.style.display = 'none';
            }, 5000);
        }

        function iniciarProcesoParto() {
            const btnIniciar = document.getElementById('btnIniciarParto');
            
            if (btnIniciar.disabled) return;
            
            // Confirmar
            const tipo = tipoPartoSeleccionado === 'VAGINAL' ? 'parto vaginal' : 'cesárea';
            if (confirm(`¿Está seguro de iniciar el proceso de ${tipo}?`)) {
                // Aquí iría la lógica para redireccionar o guardar
                alert(`Proceso de ${tipo} iniciado. Redirigiendo a sala de parto...`);
                // window.location.href = '/parto/iniciar/';
            }
        }
    </script>
</body>

</html>