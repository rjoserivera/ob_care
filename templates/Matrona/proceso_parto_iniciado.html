{% extends 'Shared/base.html' %}

{% block title %}Sala de Preparación - Profesional{% endblock %}

{% block extra_css %}
<style>
    .avatar-circle {
        width: 36px;
        height: 36px;
        background-color: #e9ecef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #495057;
        font-size: 0.9rem;
    }
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 .25rem .5rem rgba(0,0,0,.1) !important;
        transition: all 0.2s ease-in-out;
    }
    .status-badge {
        font-size: 0.7rem;
        padding: 0.25em 0.6em;
        border-radius: 10rem;
    }
    /* Tabs Custom Styling */
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        transition: all 0.2s;
    }
    
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        background-color: #f8f9fa;
        border-color: transparent;
    }
    
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        background-color: transparent;
        border-bottom: 3px solid #0d6efd;
        font-weight: bold;
    }
    
    .role-badge-medico { background-color: #e3f2fd; color: #0d47a1; }
    .role-badge-matrona { background-color: #e8f5e9; color: #1b5e20; }
    .role-badge-tens { background-color: #fff3e0; color: #e65100; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 fade-in">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
        <div>
            <h1 class="h4 mb-1 text-gray-800 font-weight-bold">
                <i class="bi bi-hospital me-2 text-primary"></i>Sala de Preparación
            </h1>
            <p class="text-muted mb-0 small">
                Gestión de Equipo Clínico para Parto
            </p>
        </div>
        <div class="text-end">
            <div class="h5 fw-bold text-dark mb-0">{{ ficha.paciente.persona.nombre_completo }}</div>
            <span class="badge bg-light text-dark border">
                Ficha: {{ ficha.numero_ficha }} | Bebés: {{ cantidad_bebes }}
            </span>
        </div>
    </div>

    <div class="row g-4">
        <!-- IZQUIERDA: Tabs de Personal -->
        <div class="col-lg-8">
            
            <!-- Resumen Requerimientos (Visión compacta) -->
            <div class="card shadow-sm border-0 rounded-3 mb-4 bg-light">
                <div class="card-body p-3">
                    <div class="row text-center g-0">
                        <div class="col border-end border-light">
                            <span class="d-block small text-muted text-uppercase fw-bold">Médicos</span>
                            <span class="h5 fw-bold text-info">
                                <span id="count-medicos">{{ asignados.medicos|length }}</span>/{{ requerimientos.medicos }}
                            </span>
                        </div>
                        <div class="col border-end border-light">
                            <span class="d-block small text-muted text-uppercase fw-bold">Matronas</span>
                            <span class="h5 fw-bold text-success">
                                <span id="count-matronas">{{ asignados.matronas|length }}</span>/{{ requerimientos.matronas }}
                            </span>
                        </div>
                        <div class="col">
                            <span class="d-block small text-muted text-uppercase fw-bold">TENS</span>
                            <span class="h5 fw-bold text-warning">
                                <span id="count-tens">{{ asignados.tens|length }}</span>/{{ requerimientos.tens }}
                            </span>
                        </div>
                        <div class="col-auto ps-3 border-start">
                             <span class="d-block small text-muted text-uppercase fw-bold">Total Disp.</span>
                             <span class="h5 fw-bold text-primary">{{ total_disponible }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABS -->
            <div class="card shadow border-0 rounded-3" style="min-height: 500px;">
                <div class="card-header bg-white p-0 border-bottom">
                    <ul class="nav nav-tabs card-header-tabs m-0" id="staffTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="medicos-tab" data-bs-toggle="tab" data-bs-target="#medicos" type="button" role="tab">
                                <i class="bi bi-heart-pulse me-2"></i>Médicos ({{ staff_disponible.medicos|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="matronas-tab" data-bs-toggle="tab" data-bs-target="#matronas" type="button" role="tab">
                                <i class="bi bi-person-plus me-2"></i>Matronas ({{ staff_disponible.matronas|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tens-tab" data-bs-toggle="tab" data-bs-target="#tens" type="button" role="tab">
                                <i class="bi bi-people me-2"></i>TENS ({{ staff_disponible.tens|length }})
                            </button>
                        </li>
                    </ul>
                </div>
                
                <div class="card-body p-4 bg-light">
                    <div class="tab-content" id="staffTabsContent">
                        
                        <!-- TAB MEDICOS -->
                        <div class="tab-pane fade show active" id="medicos" role="tabpanel">
                            <div class="row g-2">
                                {% for p in staff_disponible.medicos %}
                                <div class="col-md-6 col-xl-4">
                                    <div class="card border-0 shadow-sm h-100 card-hover">
                                        <div class="card-body p-3 d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-info-subtle text-info me-3">
                                                    {{ p.usuario.first_name|first }}{{ p.usuario.last_name|first }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold small text-truncate" style="max-width: 120px;">{{ p.usuario.get_full_name }}</div>
                                                    <span class="badge role-badge-medico small">Médico</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline-info rounded-circle shadow-none" 
                                                    style="width: 32px; height: 32px; padding: 0;"
                                                    data-id="{{ p.id }}" data-rol="MEDICO" onclick="solicitarPersonal(this)" title="Solicitar">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12"><div class="alert alert-info border-0 shadow-sm">No hay médicos disponibles</div></div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- TAB MATRONAS -->
                        <div class="tab-pane fade" id="matronas" role="tabpanel">
                            <div class="row g-2">
                                {% for p in staff_disponible.matronas %}
                                <div class="col-md-6 col-xl-4">
                                    <div class="card border-0 shadow-sm h-100 card-hover">
                                        <div class="card-body p-3 d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-success-subtle text-success me-3">
                                                    {{ p.usuario.first_name|first }}{{ p.usuario.last_name|first }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold small text-truncate" style="max-width: 120px;">{{ p.usuario.get_full_name }}</div>
                                                    <span class="badge role-badge-matrona small">Matrona</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline-success rounded-circle shadow-none" 
                                                    style="width: 32px; height: 32px; padding: 0;"
                                                    data-id="{{ p.id }}" data-rol="MATRONA" onclick="solicitarPersonal(this)" title="Solicitar">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12"><div class="alert alert-success border-0 shadow-sm">No hay matronas disponibles</div></div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- TAB TENS -->
                        <div class="tab-pane fade" id="tens" role="tabpanel">
                            <div class="row g-2">
                                {% for p in staff_disponible.tens %}
                                <div class="col-md-6 col-xl-4">
                                    <div class="card border-0 shadow-sm h-100 card-hover">
                                        <div class="card-body p-3 d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-warning-subtle text-warning me-3">
                                                    {{ p.usuario.first_name|first }}{{ p.usuario.last_name|first }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold small text-truncate" style="max-width: 120px;">{{ p.usuario.get_full_name }}</div>
                                                    <span class="badge role-badge-tens small">TENS</span>
                                                </div>
                                            </div>
                                            <button class="btn btn-sm btn-outline-warning rounded-circle shadow-none" 
                                                    style="width: 32px; height: 32px; padding: 0;"
                                                    data-id="{{ p.id }}" data-rol="TENS" onclick="solicitarPersonal(this)" title="Solicitar">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12"><div class="alert alert-warning border-0 shadow-sm">No hay TENS disponibles</div></div>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- DERECHA: Sticky Panel -->
        <div class="col-lg-4">
            <div class="card shadow border-0 rounded-3 mb-4 sticky-top" style="top: 100px; z-index: 900;">
                <div class="card-header bg-dark text-white py-3">
                    <h6 class="m-0 font-weight-bold"><i class="bi bi-list-check me-2"></i>Equipo Solicitado</h6>
                </div>
                <div class="card-body p-0">
                     <div id="lista-notificaciones" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        {% for a in asignados_list %}
                        <div class="list-group-item d-flex align-items-center bg-light-subtle">
                            <div class="me-3">
                                {% if a.confirmo_asistencia %}
                                    <i class="bi bi-check-circle-fill text-success fs-5" title="Confirmado"></i>
                                {% else %}
                                    <div class="spinner-border text-warning spinner-border-sm" role="status" title="Esperando confirmación">
                                        <span class="visually-hidden">...</span>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="w-100">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold small {{ a.confirmo_asistencia|yesno:'text-success,text-muted' }}">
                                        {{ a.personal.usuario.get_full_name }}
                                    </span>
                                    <span class="badge bg-secondary" style="font-size: 0.6rem;">{{ a.personal.get_rol_display }}</span>
                                </div>
                                <div class="phonetic-small d-flex justify-content-between">
                                    <small class="text-muted" style="font-size: 0.7rem;">Solicitado: {{ a.timestamp_notificacion|date:"H:i" }}</small>
                                    {% if a.confirmo_asistencia %}
                                        <small class="text-success fw-bold" style="font-size: 0.7rem;">¡Confirmado!</small>
                                    {% else %}
                                        <small class="text-warning fw-bold" style="font-size: 0.7rem;">Pendiente...</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4 text-muted" id="empty-notif">
                            <i class="bi bi-people display-6 opacity-25"></i>
                            <p class="small mt-2 mb-0">Comienza solicitando personal desde las pestañas.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-white border-top p-3">
                    <button class="btn btn-primary w-100 rounded-pill shadow-sm" onclick="finalizarAsignacion()">
                        <i class="bi bi-check-all me-2"></i>Finalizar y Notificar Equipo
                    </button>
                    <a href="{% url 'matrona:detalle_ficha' ficha.id %}" class="btn btn-link w-100 text-muted small text-decoration-none mt-2">
                        Volver a Ficha
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function solicitarPersonal(btn) {
        // ... (Same logic for individual solicitation - keeps working) ...
        const id = btn.dataset.id;
        const rol = btn.dataset.rol;
        const fichaPartoId = "{{ ficha_parto.id }}";
        
        // Visual feedback
        const originalIcon = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" style="width: 0.8rem; height: 0.8rem;"></span>';
        
        const url = "{% url 'matrona:asignar_personal_parto' ficha.id %}"; // Assuming ficha_parto.id == ficha.id conceptually here or passed correctly
        const csrftoken = getCookie('csrftoken');
        
        // Get staff name for alerts
        let staffName = "Profesional";
        try { staffName = btn.closest('.d-flex').querySelector('.fw-bold').innerText; } catch(e) {}

        fetch(url, {
            method: 'POST',
            body: JSON.stringify({
                personal_id: id,
                ficha_parto_id: fichaPartoId,
                rol_solicitado: rol
            }),
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning', 'btn-outline-info');
                btn.classList.add('btn-secondary'); 
                btn.innerHTML = '<i class="bi bi-check"></i>';
                btn.title = "Solicitado";
                const emptyMsg = document.getElementById('empty-notif');
                if(emptyMsg) emptyMsg.remove();
                
                // Add to sidebar
                const lista = document.getElementById('lista-notificaciones');
                const now = new Date();
                const timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex align-items-center bg-light-subtle animate__animated animate__fadeInLeft';
                item.innerHTML = `
                    <div class="me-3"><i class="bi bi-check-circle-fill text-success fs-5"></i></div>
                    <div class="w-100">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold small">${staffName}</span>
                            <span class="badge bg-secondary" style="font-size: 0.6rem;">${rol}</span>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">Solicitado: ${timeString}</small>
                    </div>
                `;
                lista.prepend(item);
                
                // Alert individual
                alert("✅ Solicitud enviada a " + staffName + ". Se ha notificado por App y Correo.");
            } else {
                alert('❌ Error: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = originalIcon;
            }
        })
        .catch(error => { console.error(error); alert('Error de conexión.'); btn.disabled=false; btn.innerHTML=originalIcon; });
    }

    // FINALIZAR ASIGNACIÓN (NOTIFICAR A TODOS)
    function finalizarAsignacion() {
        if(!confirm("¿CONFIRMAR EQUIPO?\n\nSe enviará un CORREO DE RESUMEN a todo el personal asignado confirmando el inicio del proceso.")) return;

        const btn = document.querySelector('button[onclick="finalizarAsignacion()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando Correos...';

        const url = "{% url 'matrona:finalizar_asignacion_parto' ficha.id %}";
        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                alert("✅ " + data.message);
                btn.className = "btn btn-success w-100 rounded-pill shadow-sm";
                btn.innerHTML = '<i class="bi bi-check-all me-2"></i>Asignación Finalizada';
            } else {
                alert("⚠️ " + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        })
        .catch(e => {
            alert("Error de conexión");
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    }
</script>
{% endblock %}