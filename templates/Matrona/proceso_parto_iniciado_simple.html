{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Centro de Control - Parto{% endblock %}

{% block extra_css %}
<style>
    .control-panel {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .header-card {
        background: #ffffff;
        color: #2c3e50;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border-left: 6px solid #0d6efd;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #0d6efd;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .invite-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .invite-btn {
        background: #0d6efd;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin: 0.5rem;
        transition: transform 0.2s;
    }
    
    .invite-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
    }
    
    .invite-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .team-list {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .team-member {
        padding: 1rem;
        border-left: 4px solid #28a745;
        background: #f8f9fa;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .pending-slot {
        padding: 1rem;
        border-left: 4px solid #ffc107;
        background: #fff3cd;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    /* Progress Modal */
    .progress-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .progress-modal.active {
        display: flex;
    }
    
    .progress-content {
        background: white;
        padding: 3rem;
        border-radius: 16px;
        text-align: center;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .progress-icon {
        font-size: 3rem;
        color: #0d6efd;
        margin-bottom: 1rem;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .progress-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .progress-message {
        color: #666;
        margin-bottom: 1.5rem;
    }
    
    .progress-result {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .btn-close-modal {
        background: #6c757d; /* Default gray if not overridden */
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-close-modal:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        opacity: 0.95;
    }
    
    .sala-card {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        width: 100%;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }
    .sala-card:hover:not(:disabled) {
        border-color: #0d6efd;
        transform: translateY(-2px);
    }
    .sala-card.selected {
        border-color: #0d6efd;
        background: #e7f1ff;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
    }
    .sala-card.ocupada {
        background: #f8d7da;
        border-color: #dc3545;
        cursor: not-allowed;
        opacity: 0.7;
    }
    
    .btn-start {
        background: #28a745;
        color: white;
        font-size: 1.5rem;
        padding: 1.5rem;
        width: 100%;
        border: none;
        border-radius: 12px;
        margin-top: 2rem;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-start:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="control-panel">
    <!-- Header -->
    <div class="header-card">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2"><i class="bi bi-hospital"></i> Centro de Control - Sala de Preparación</h2>
                <h4 class="mb-0 fw-bold">{{ ficha.paciente.persona.nombre_completo }}</h4>
                <div class="mt-2 opacity-75">
                    <span class="me-3"><i class="bi bi-card-text"></i> RUT: {{ ficha.paciente.persona.rut }}-{{ ficha.paciente.persona.dv }}</span>
                    <span class="me-3"><i class="bi bi-person"></i> Edad: {{ ficha.paciente.edad }} años</span>
                    <span class="me-3"><i class="bi bi-folder"></i> Ficha: {{ ficha.numero_ficha }}</span>
                </div>
            </div>
            <div class="text-end bg-white text-dark p-3 rounded-3 shadow-sm">
                <div class="small text-muted text-uppercase fw-bold">Edad Gestacional</div>
                <div class="display-6 fw-bold text-danger">{{ ficha.edad_gestacional_semanas }}<small class="fs-6 text-muted">sem</small> + {{ ficha.edad_gestacional_dias }}<small class="fs-6 text-muted">días</small></div>
                <div class="badge bg-danger mt-1">Bebés: {{ cantidad_bebes }}</div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.enviados }}</div>
            <div class="stat-label">Invitaciones Enviadas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.aceptados }}</div>
            <div class="stat-label">Aceptadas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.pendientes }}</div>
            <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.rechazados }}</div>
            <div class="stat-label">Rechazadas</div>
        </div>
    </div>

    <!-- Invitaciones -->
    <div class="invite-section">
        <h3><i class="bi bi-send"></i> Invitar Personal</h3>
        <p>Haz click para enviar invitaciones a todo el personal disponible:</p>
        
        <button class="invite-btn" onclick="invitarPersonal('MEDICO')">
            <i class="bi bi-person-badge"></i> Invitar Médicos ({{ personal_counts.MEDICO }})
        </button>
        
        <button class="invite-btn" onclick="invitarPersonal('MATRONA')">
            <i class="bi bi-heart-pulse"></i> Invitar Matronas ({{ personal_counts.MATRONA }})
        </button>
        
        <button class="invite-btn" onclick="invitarPersonal('TENS')">
            <i class="bi bi-clipboard-pulse"></i> Invitar TENS ({{ personal_counts.TENS }})
        </button>
        
        <button class="invite-btn" style="background: #6c757d;" onclick="reenviarNotificaciones()">
            <i class="bi bi-arrow-clockwise"></i> Reenviar Notificaciones
        </button>
        
        <div class="mt-3 border-top pt-3">
            <button class="invite-btn" style="background: #343a40;" onclick="autoFillEquipo()">
                <i class="bi bi-lightning-fill"></i> ⚡ AUTO-RELLENAR EQUIPO (TEST)
            </button>
        </div>
    </div>



    <!-- Equipo Confirmado -->
    <div class="team-list mt-4 mb-4">
        <h3><i class="bi bi-people-fill"></i> Equipo Confirmado</h3>
        
        <!-- Lista de Aceptados -->
        {% for asignacion in asignados_aceptados %}
        <div class="team-member">
            <div class="badge rounded-pill me-3" style="min-width: 100px; padding: 0.6rem; font-size: 0.85rem; background: 
                {% if asignacion.personal.rol == 'MEDICO' %}#f093fb
                {% elif asignacion.personal.rol == 'MATRONA' %}#ff5858
                {% else %}#43e97b{% endif %};">
                {{ asignacion.personal.get_rol_display|upper }}
            </div>
            <div>
                <strong>{{ asignacion.personal.usuario.get_full_name }}</strong>
                <div class="text-muted small">{{ asignacion.personal.get_rol_display }}</div>
            </div>
            <div style="margin-left: auto; color: #28a745;">
                <i class="bi bi-check-circle-fill"></i> Confirmado
            </div>
        </div>
        {% endfor %}
        
        <!-- Slots Pendientes -->
        {% for slot in slots_pendientes %}
        <div class="pending-slot">
            <div class="spinner-border spinner-border-sm text-secondary me-2" role="status"></div>
            <strong>{{ slot.rol }}</strong> (Faltan {{ slot.cantidad }}) - Esperando respuesta...
        </div>
        {% endfor %}
    </div>

    <!-- Selección de Sala -->
    <div class="invite-section mt-4">
        <h3><i class="bi bi-door-open"></i> Selección de Sala</h3>
        <p>Seleccione una sala disponible para iniciar el parto:</p>
        
        <div class="stats-grid"> 
            {% for info in salas %}
                <button type="button" 
                        class="sala-card {% if info.ocupada %}ocupada{% endif %}" 
                        onclick="seleccionarSala('{{ info.sala.id }}', '{{ info.sala.nombre }}')"
                        {% if info.ocupada %}disabled{% endif %}>
                    <h4><i class="bi bi-hospital"></i> {{ info.sala.nombre }}</h4>
                     {% if info.ocupada %}
                        <span class="badge bg-danger">Ocupada ({{ info.tiempo_str }})</span>
                    {% else %}
                        <span class="badge bg-success">Disponible</span>
                    {% endif %}
                </button>
            {% endfor %}
        </div>
        <input type="hidden" id="sala_seleccionada_id">
    </div>

    <!-- Panel de Inicio -->
    <div class="header-card mt-4 text-center" style="background: white; color: #333; border: 2px solid #ddd;">
        <h3>Estado del Equipo (Bebés: {{ cantidad_bebes }})</h3>
        <div class="d-flex justify-content-around mb-3 flex-wrap gap-2">
            <span class="badge {% if aceptados_counts.medico >= reqs.medico %}bg-success{% else %}bg-danger{% endif %} p-2 fs-6">
                Médicos: {{ aceptados_counts.medico }}/{{ reqs.medico }}
            </span>
            <span class="badge {% if aceptados_counts.matrona >= reqs.matrona %}bg-success{% else %}bg-danger{% endif %} p-2 fs-6">
                Matronas: {{ aceptados_counts.matrona }}/{{ reqs.matrona }}
            </span>
            <span class="badge {% if aceptados_counts.tens >= reqs.tens %}bg-success{% else %}bg-danger{% endif %} p-2 fs-6">
                TENS: {{ aceptados_counts.tens }}/{{ reqs.tens }}
            </span>
        </div>
        
        <button id="btn-iniciar-parto" class="btn-start" disabled onclick="iniciarPartoDefinitivo()">
            <i class="bi bi-play-circle"></i> SELECCIONE SALA
        </button>
        <p id="msg-requisitos" class="text-muted mt-2">
            {% if not equipo_completo %}
                <i class="bi bi-exclamation-triangle text-warning"></i> Falta completar el equipo.
            {% else %}
                <i class="bi bi-check-circle-fill text-success"></i> Equipo completo. Seleccione sala.
            {% endif %}
        </p>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="progress-modal">
    <div class="progress-content">
        <div class="progress-icon" style="animation: none;">
            <i class="bi bi-question-circle-fill" style="color: #0d6efd;"></i>
        </div>
        <div class="progress-title">Confirmar Invitación</div>
        <div id="confirmMessage" class="progress-message"></div>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn-close-modal" onclick="confirmarInvitacion()" style="background: #198754;">
                <i class="bi bi-check-lg"></i> Aceptar
            </button>
            <button class="btn-close-modal" onclick="cancelarInvitacion()" style="background: #dc3545;">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="pinModal" class="progress-modal">
    <div class="progress-content">
        <div class="progress-icon" style="animation: none;">
            <i class="bi bi-shield-lock-fill" style="color: #0d6efd;"></i>
        </div>
        <div class="progress-title">Seguridad</div>
        <div class="progress-message">Ingrese el PIN de autorización enviado al Médico Jefe:</div>
        
        <input type="text" id="inputPinParto" class="form-control text-center fs-3 my-3" placeholder="------" maxlength="6" style="letter-spacing: 5px; font-weight: bold;">
        
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn-close-modal" onclick="verificarPinYComenzar()" style="background: #0d6efd; width: 100%;">
                <i class="bi bi-check-lg"></i> Autorizar Inicio
            </button>
        </div>
        <button onclick="document.getElementById('pinModal').classList.remove('active')" class="btn btn-link text-muted mt-2">Cancelar</button>
    </div>
</div>

<!-- Progress Modal -->
<div id="progressModal" class="progress-modal">
    <div class="progress-content">
        <div id="progressIcon" class="progress-icon">
            <i class="bi bi-hourglass-split"></i>
        </div>
        <div id="progressTitle" class="progress-title">Invitando...</div>
        <div id="progressMessage" class="progress-message">Enviando invitaciones al personal</div>
        <div id="progressResult" class="progress-result" style="display: none;"></div>
        <button id="btnCloseProgress" class="btn-close-modal" style="display: none;" onclick="cerrarProgressModal()">
            Cerrar
        </button>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function mostrarProgressModal(titulo, mensaje) {
    const modal = document.getElementById('progressModal');
    const icon = document.getElementById('progressIcon');
    const titleEl = document.getElementById('progressTitle');
    const messageEl = document.getElementById('progressMessage');
    const resultEl = document.getElementById('progressResult');
    const btnClose = document.getElementById('btnCloseProgress');
    
    titleEl.textContent = titulo;
    messageEl.textContent = mensaje;
    icon.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    icon.style.animation = 'spin 2s linear infinite';
    resultEl.style.display = 'none';
    btnClose.style.display = 'none';
    modal.classList.add('active');
}

function mostrarResultado(exito, mensaje, detalles) {
    const icon = document.getElementById('progressIcon');
    const titleEl = document.getElementById('progressTitle');
    const messageEl = document.getElementById('progressMessage');
    const resultEl = document.getElementById('progressResult');
    const btnClose = document.getElementById('btnCloseProgress');
    
    icon.style.animation = 'none';
    
    if (exito) {
        icon.innerHTML = '<i class="bi bi-check-circle-fill" style="color: #28a745;"></i>';
        titleEl.textContent = '✅ Invitaciones Enviadas';
        titleEl.style.color = '#28a745';
    } else {
        icon.innerHTML = '<i class="bi bi-x-circle-fill" style="color: #dc3545;"></i>';
        titleEl.textContent = '❌ Error';
        titleEl.style.color = '#dc3545';
    }
    
    messageEl.textContent = mensaje;
    resultEl.innerHTML = detalles;
    resultEl.style.display = 'block';
    btnClose.style.display = 'inline-block';
}

function cerrarProgressModal() {
    document.getElementById('progressModal').classList.remove('active');
    location.reload();
}

let pendingInvitation = null;

function mostrarConfirmacion(mensaje, callback) {
    document.getElementById('confirmMessage').textContent = mensaje;
    document.getElementById('confirmModal').classList.add('active');
    pendingInvitation = callback;
}

function confirmarInvitacion() {
    document.getElementById('confirmModal').classList.remove('active');
    if (pendingInvitation) {
        pendingInvitation();
        pendingInvitation = null;
    }
}

function cancelarInvitacion() {
    document.getElementById('confirmModal').classList.remove('active');
    pendingInvitation = null;
}

function invitarPersonal(rol) {
    const roles = {
        'MEDICO': 'Médicos',
        'MATRONA': 'Matronas',
        'TENS': 'TENS'
    };
    
    // Obtener la cantidad del botón
    const btn = window.event ? window.event.target : null;
    const btnText = btn ? btn.textContent : '';
    const match = btnText.match(/\((\d+)\)/);
    const cantidad = match ? match[1] : '?';
    
    // Mostrar confirmación personalizada
    mostrarConfirmacion(
        `¿Desea enviar invitaciones a ${cantidad} ${roles[rol]} disponibles?`,
        function() {
            // Esta función se ejecuta cuando se confirma
            mostrarProgressModal('Invitando...', `Enviando invitaciones a ${cantidad} ${roles[rol]}`);
            
            if (btn) {
                btn.disabled = true;
            }
            
            fetch("{% url 'matrona:invitar_personal_rol' ficha_parto.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    rol: rol
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const detalles = `
                        <strong>Nuevas invitaciones:</strong> ${data.enviados}<br>
                        <strong>Ya invitados:</strong> ${data.ya_invitados}
                    `;
                    mostrarResultado(true, 'Invitaciones enviadas correctamente', detalles);
                } else {
                    mostrarResultado(false, 'Error al enviar invitaciones', data.error);
                    if (btn) btn.disabled = false;
                }
            })
            .catch(error => {
                mostrarResultado(false, 'Error de conexión', error.toString());
                if (btn) btn.disabled = false;
            });
        }
    );
}

function reenviarNotificaciones() {
    mostrarConfirmacion(
        '¿Desea limpiar todas las invitaciones y reenviar notificaciones?',
        function() {
            mostrarProgressModal('Limpiando...', 'Eliminando invitaciones anteriores');
            
            fetch("{% url 'matrona:limpiar_invitaciones_ajax' ficha_parto.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    mostrarResultado(true, 'Invitaciones limpiadas', `Se eliminaron ${data.eliminados} invitaciones. La página se recargará.`);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    mostrarResultado(false, 'Error al limpiar', data.error);
                }
            })
            .catch(error => {
                mostrarResultado(false, 'Error de conexión', error.toString());
            });
        }
    );
}

function autoFillEquipo() {
    mostrarConfirmacion(
        '¿[DEBUG] Auto-rellenar equipo faltante y generar PIN?',
        function() {
            mostrarProgressModal('Auto-Rellenando...', 'Asignando personal y generando PIN');
            
            // Asumiré nueva URL: matrona:debug_rellenar_equipo
            const url = "/matrona/api/debug/rellenar-equipo/{{ ficha_parto.id }}/"; 
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    mostrarResultado(true, 'Equipo Auto-Rellenado', `Se asignaron: ${data.asignados}. Notificando a médicos. Recargando...`);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    mostrarResultado(false, 'Error Debug', data.error);
                }
            })
            .catch(error => {
                mostrarResultado(false, 'Error de conexión', error.toString());
            });
        }
    );
}

let salaId = null;
const equipoCompleto = {{ equipo_completo|yesno:"true,false" }};

function seleccionarSala(id, nombre) {
    // Reset visual
    document.querySelectorAll('.sala-card').forEach(el => el.classList.remove('selected'));
    
    // Select visual
    const target = event.target.closest('.sala-card');
    if(target) target.classList.add('selected');
    
    salaId = id;
    const btn = document.getElementById('btn-iniciar-parto');
    
    if (equipoCompleto) {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-play-circle-fill"></i> INICIAR PARTO EN ${nombre}`;
        // btn.classList.add('pulse-animation');
    } else {
        btn.innerHTML = `ESPERANDO EQUIPO COMPLETO...`;
        btn.disabled = true;
    }
}

function iniciarPartoDefinitivo() {
    if(!salaId) return;
    // Abrir Modal de PIN
    document.getElementById('inputPinParto').value = '';
    document.getElementById('pinModal').classList.add('active');
    document.getElementById('inputPinParto').focus();
}

function verificarPinYComenzar() {
    const pin = document.getElementById('inputPinParto').value.trim();
    if (pin.length < 4) {
        alert("Ingrese un PIN válido.");
        return;
    }
    
    document.getElementById('pinModal').classList.remove('active');
    mostrarProgressModal('Validando...', 'Verificando PIN y asignando sala...');
    
    fetch("{% url 'matrona:verificar_pin' ficha_parto.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            pin: pin,
            sala_id: salaId
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            mostrarResultado(true, 'Autorizado', 'Redirigiendo al parto...');
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1000);
        } else {
            mostrarResultado(false, 'Acceso Denegado', data.error);
        }
    })
    .catch(err => {
        mostrarResultado(false, 'Error', err.toString());
    });
}
</script>
{% endblock %}
