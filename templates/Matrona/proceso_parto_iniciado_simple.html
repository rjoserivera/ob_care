{% extends 'Shared/base.html' %}
{% load static %}

{% block title %}Centro de Control - Parto{% endblock %}

{% block extra_css %}
<style>
    .control-panel {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }
    
    .header-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .invite-section {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .invite-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin: 0.5rem;
        transition: transform 0.2s;
    }
    
    .invite-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .invite-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .team-list {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .team-member {
        padding: 1rem;
        border-left: 4px solid #28a745;
        background: #f8f9fa;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    .pending-slot {
        padding: 1rem;
        border-left: 4px solid #ffc107;
        background: #fff3cd;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }
    
    /* Progress Modal */
    .progress-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .progress-modal.active {
        display: flex;
    }
    
    .progress-content {
        background: white;
        padding: 3rem;
        border-radius: 16px;
        text-align: center;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .progress-icon {
        font-size: 4rem;
        color: #667eea;
        margin-bottom: 1rem;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .progress-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .progress-message {
        color: #666;
        margin-bottom: 1.5rem;
    }
    
    .progress-result {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .btn-close-modal {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="control-panel">
    <!-- Header -->
    <div class="header-card">
        <h1><i class="bi bi-hospital"></i> Centro de Control - Sala de Preparación</h1>
        <p class="mb-0">Paciente: {{ ficha.paciente.persona.nombre_completo }} | Ficha: {{ ficha.numero_ficha }}</p>
    </div>

    <!-- Estadísticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.enviados }}</div>
            <div class="stat-label">Invitaciones Enviadas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.aceptados }}</div>
            <div class="stat-label">Aceptadas</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.pendientes }}</div>
            <div class="stat-label">Pendientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.rechazados }}</div>
            <div class="stat-label">Rechazadas</div>
        </div>
    </div>

    <!-- Invitaciones -->
    <div class="invite-section">
        <h3><i class="bi bi-send"></i> Invitar Personal</h3>
        <p>Haz click para enviar invitaciones a todo el personal disponible:</p>
        
        <button class="invite-btn" onclick="invitarPersonal('MEDICO')">
            <i class="bi bi-person-badge"></i> Invitar Médicos ({{ personal_counts.MEDICO }})
        </button>
        
        <button class="invite-btn" onclick="invitarPersonal('MATRONA')">
            <i class="bi bi-heart-pulse"></i> Invitar Matronas ({{ personal_counts.MATRONA }})
        </button>
        
        <button class="invite-btn" onclick="invitarPersonal('TENS')">
            <i class="bi bi-clipboard-pulse"></i> Invitar TENS ({{ personal_counts.TENS }})
        </button>
        
        <button class="invite-btn" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);" onclick="reenviarNotificaciones()">
            <i class="bi bi-arrow-clockwise"></i> Reenviar Notificaciones
        </button>
    </div>

    <!-- Equipo Confirmado -->
    <div class="team-list">
        <h3><i class="bi bi-people"></i> Equipo Confirmado</h3>
        
        {% if asignados_aceptados %}
            {% for asignacion in asignados_aceptados %}
            <div class="team-member">
                <strong>{{ asignacion.personal.usuario.get_full_name }}</strong>
                <span class="badge bg-success ms-2">{{ asignacion.rol_en_proceso }}</span>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No hay personal confirmado aún</p>
        {% endif %}
        
        <h4 class="mt-4">Pendientes de Confirmación</h4>
        {% for slot in slots_pendientes %}
        <div class="pending-slot">
            <strong>{{ slot.rol }}</strong> - Esperando respuesta...
        </div>
        {% endfor %}
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="progress-modal">
    <div class="progress-content">
        <div class="progress-icon" style="animation: none;">
            <i class="bi bi-question-circle-fill" style="color: #ffc107;"></i>
        </div>
        <div class="progress-title">Confirmar Invitación</div>
        <div id="confirmMessage" class="progress-message"></div>
        <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="btn-close-modal" onclick="confirmarInvitacion()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <i class="bi bi-check-lg"></i> Aceptar
            </button>
            <button class="btn-close-modal" onclick="cancelarInvitacion()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                <i class="bi bi-x-lg"></i> Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="progressModal" class="progress-modal">
    <div class="progress-content">
        <div id="progressIcon" class="progress-icon">
            <i class="bi bi-hourglass-split"></i>
        </div>
        <div id="progressTitle" class="progress-title">Invitando...</div>
        <div id="progressMessage" class="progress-message">Enviando invitaciones al personal</div>
        <div id="progressResult" class="progress-result" style="display: none;"></div>
        <button id="btnCloseProgress" class="btn-close-modal" style="display: none;" onclick="cerrarProgressModal()">
            Cerrar
        </button>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function mostrarProgressModal(titulo, mensaje) {
    const modal = document.getElementById('progressModal');
    const icon = document.getElementById('progressIcon');
    const titleEl = document.getElementById('progressTitle');
    const messageEl = document.getElementById('progressMessage');
    const resultEl = document.getElementById('progressResult');
    const btnClose = document.getElementById('btnCloseProgress');
    
    titleEl.textContent = titulo;
    messageEl.textContent = mensaje;
    icon.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    icon.style.animation = 'spin 2s linear infinite';
    resultEl.style.display = 'none';
    btnClose.style.display = 'none';
    modal.classList.add('active');
}

function mostrarResultado(exito, mensaje, detalles) {
    const icon = document.getElementById('progressIcon');
    const titleEl = document.getElementById('progressTitle');
    const messageEl = document.getElementById('progressMessage');
    const resultEl = document.getElementById('progressResult');
    const btnClose = document.getElementById('btnCloseProgress');
    
    icon.style.animation = 'none';
    
    if (exito) {
        icon.innerHTML = '<i class="bi bi-check-circle-fill" style="color: #28a745;"></i>';
        titleEl.textContent = '✅ Invitaciones Enviadas';
        titleEl.style.color = '#28a745';
    } else {
        icon.innerHTML = '<i class="bi bi-x-circle-fill" style="color: #dc3545;"></i>';
        titleEl.textContent = '❌ Error';
        titleEl.style.color = '#dc3545';
    }
    
    messageEl.textContent = mensaje;
    resultEl.innerHTML = detalles;
    resultEl.style.display = 'block';
    btnClose.style.display = 'inline-block';
}

function cerrarProgressModal() {
    document.getElementById('progressModal').classList.remove('active');
    location.reload();
}

let pendingInvitation = null;

function mostrarConfirmacion(mensaje, callback) {
    document.getElementById('confirmMessage').textContent = mensaje;
    document.getElementById('confirmModal').classList.add('active');
    pendingInvitation = callback;
}

function confirmarInvitacion() {
    document.getElementById('confirmModal').classList.remove('active');
    if (pendingInvitation) {
        pendingInvitation();
        pendingInvitation = null;
    }
}

function cancelarInvitacion() {
    document.getElementById('confirmModal').classList.remove('active');
    pendingInvitation = null;
}

function invitarPersonal(rol) {
    const roles = {
        'MEDICO': 'Médicos',
        'MATRONA': 'Matronas',
        'TENS': 'TENS'
    };
    
    // Obtener la cantidad del botón
    const btn = window.event ? window.event.target : null;
    const btnText = btn ? btn.textContent : '';
    const match = btnText.match(/\((\d+)\)/);
    const cantidad = match ? match[1] : '?';
    
    // Mostrar confirmación personalizada
    mostrarConfirmacion(
        `¿Desea enviar invitaciones a ${cantidad} ${roles[rol]} disponibles?`,
        function() {
            // Esta función se ejecuta cuando se confirma
            mostrarProgressModal('Invitando...', `Enviando invitaciones a ${cantidad} ${roles[rol]}`);
            
            if (btn) {
                btn.disabled = true;
            }
            
            fetch("{% url 'matrona:invitar_personal_rol' ficha_parto.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    rol: rol
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const detalles = `
                        <strong>Nuevas invitaciones:</strong> ${data.enviados}<br>
                        <strong>Ya invitados:</strong> ${data.ya_invitados}
                    `;
                    mostrarResultado(true, 'Invitaciones enviadas correctamente', detalles);
                } else {
                    mostrarResultado(false, 'Error al enviar invitaciones', data.error);
                    if (btn) btn.disabled = false;
                }
            })
            .catch(error => {
                mostrarResultado(false, 'Error de conexión', error.toString());
                if (btn) btn.disabled = false;
            });
        }
    );
}

function reenviarNotificaciones() {
    mostrarConfirmacion(
        '¿Desea limpiar todas las invitaciones y reenviar notificaciones?',
        function() {
            mostrarProgressModal('Limpiando...', 'Eliminando invitaciones anteriores');
            
            fetch("{% url 'matrona:limpiar_invitaciones_ajax' ficha_parto.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    mostrarResultado(true, 'Invitaciones limpiadas', `Se eliminaron ${data.eliminados} invitaciones. La página se recargará.`);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    mostrarResultado(false, 'Error al limpiar', data.error);
                }
            })
            .catch(error => {
                mostrarResultado(false, 'Error de conexión', error.toString());
            });
        }
    );
}
</script>
{% endblock %}
