{% extends 'Shared/base.html' %}
{% load url_encryption_tags %}
{% load static %}

{% block title %}Dashboard Administrador - Sistema Obstétrico{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --admin-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --medico-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --matrona-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --tens-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --export-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-primary: #1a1a2e;
        --text-secondary: #6c757d;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        /* min-height handled by base */
    }

    /* Dashboard Container */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
        width: 55px;
        height: 55px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        color: white;
        flex-shrink: 0;
    }

    .stat-icon.admin { background: var(--admin-gradient); }
    .stat-icon.medico { background: var(--medico-gradient); }
    .stat-icon.matrona { background: var(--matrona-gradient); }
    .stat-icon.tens { background: var(--tens-gradient); }
    .stat-icon.paciente { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-icon.total { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }

    .stat-info h3 {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .stat-info p {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin: 0;
    }

    .active-badge {
        font-size: 0.65rem;
        background: #d4edda;
        color: #155724;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
    }

    .section-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Roles Grid */
    .roles-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 992px) {
        .roles-grid { grid-template-columns: 1fr; }
    }

    .role-card {
        background: var(--card-bg);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .role-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }

    .role-header {
        padding: 1.25rem 1.5rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .role-header.admin { background: var(--admin-gradient); }
    .role-header.medico { background: var(--medico-gradient); }
    .role-header.matrona { background: var(--matrona-gradient); }
    .role-header.tens { background: var(--tens-gradient); }
    .role-header.export { background: var(--export-gradient); }

    .role-header i { font-size: 1.75rem; }
    .role-header h3 { font-size: 1.15rem; font-weight: 700; margin: 0; }
    .role-header .count {
        margin-left: auto;
        background: rgba(255, 255, 255, 0.25);
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .role-body { padding: 1rem 1.5rem; }

    .function-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .function-list li { margin-bottom: 0.35rem; }

    .function-list a {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.6rem 0.85rem;
        border-radius: 10px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .function-list a:hover {
        background: #f8f9fa;
        transform: translateX(5px);
    }

    .function-list a i {
        font-size: 1rem;
        width: 22px;
        text-align: center;
    }

    .function-list a.admin-link:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; }
    .function-list a.medico-link:hover { background: rgba(17, 153, 142, 0.1); color: #11998e; }
    .function-list a.matrona-link:hover { background: rgba(240, 147, 251, 0.1); color: #f5576c; }
    .function-list a.tens-link:hover { background: rgba(79, 172, 254, 0.1); color: #4facfe; }

    /* Export Panel */
    .export-panel {
        background: var(--card-bg);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .export-content {
        padding: 2.5rem;
        text-align: center;
    }

    .export-content i {
        font-size: 3.5rem;
        color: #adb5bd;
        margin-bottom: 1rem;
    }

    .export-content h4 {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .coming-soon-badge {
        display: inline-block;
        background: var(--admin-gradient);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.85rem;
        margin-top: 1rem;
    }

    /* Alert Admin */
    .alert-admin {
        background: var(--admin-gradient);
        color: white;
        border: none;
        border-left: 4px solid #764ba2;
    }

    .alert-admin .btn-close { filter: brightness(0) invert(1); }

    /* Date Time */
    .date-time-section { text-align: right; margin-bottom: 1.5rem; }
    .date-time-section .date { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }

    /* Footer - Removed here as it is in base.html */
    
    @media (max-width: 768px) {
        .dashboard-container { padding: 1rem; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 576px) {
        .stats-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- Alerta Bienvenida -->
    <div class="alert alert-admin alert-dismissible fade show" role="alert" id="welcomeAlert">
        <h5 class="alert-heading"><i class="bi bi-emoji-smile-fill"></i> ¡Bienvenido/a al Menú de Administración!</h5>
        <p class="mb-0"><i class="bi bi-building"></i> Hospital Clínico Herminda Martín - Chillán</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Fecha y Hora -->
    <div class="date-time-section">
        <div class="date fw-bold fs-5" id="currentDate"></div>
        <div class="text-muted" id="currentTime"></div>
    </div>

    <!-- Stats -->
    <h4 class="section-title">
        <i class="bi bi-graph-up-arrow"></i> Resumen de Personal y Pacientes Activos
    </h4>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon admin"><i class="bi bi-shield-check"></i></div>
            <div class="stat-info">
                <h3>{{ total_administradores|default:"0" }}</h3>
                <p>Administradores</p>
                <span class="active-badge">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon medico"><i class="bi bi-heart-pulse"></i></div>
            <div class="stat-info">
                <h3>{{ total_medicos|default:"0" }}</h3>
                <p>Médicos</p>
                <span class="active-badge">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon matrona"><i class="bi bi-person-heart"></i></div>
            <div class="stat-info">
                <h3>{{ total_matronas|default:"0" }}</h3>
                <p>Matronas</p>
                <span class="active-badge">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon tens"><i class="bi bi-person-badge"></i></div>
            <div class="stat-info">
                <h3>{{ total_tens|default:"0" }}</h3>
                <p>TENS</p>
                <span class="active-badge">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon paciente"><i class="bi bi-people-fill"></i></div>
            <div class="stat-info">
                <h3>{{ total_pacientes|default:"0" }}</h3>
                <p>Pacientes</p>
                <span class="active-badge">Activos</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon total"><i class="bi bi-file-earmark-medical-fill"></i></div>
            <div class="stat-info">
                <h3>{{ total_fichas|default:"0" }}</h3>
                <p>Fichas Obstétricas</p>
            </div>
        </div>
    </div>

    <!-- Módulos -->
    <h4 class="section-title">
        <i class="bi bi-grid-3x3-gap-fill"></i> Módulos del Sistema
    </h4>
    <div class="roles-grid">
        
        <!-- Administrador -->
        <div class="role-card">
            <div class="role-header admin">
                <i class="bi bi-shield-lock-fill"></i>
                <h3>Administrador</h3>
                <span class="count">{{ total_administradores|default:"0" }} activos</span>
            </div>
            <div class="role-body">
                <ul class="function-list">
                    <li><a href="/n5p8r3t7/" class="admin-link"><i class="bi bi-speedometer2 text-primary"></i> Panel de Django Admin</a></li>
                    <li><a href="{% url 'authentication:registro_usuario' %}" class="admin-link"><i class="bi bi-person-fill-add text-primary"></i> Registrar Nuevo Usuario</a></li>
                    <li><a href="/portal/profiles/new/" class="admin-link"><i class="bi bi-person-plus-fill text-primary"></i> Registrar Nueva Persona</a></li>
                    <li><a href="/portal/profiles/" class="admin-link"><i class="bi bi-people-fill text-primary"></i> Ver Todas las Personas</a></li>
                    <li><a href="/portal/search/" class="admin-link"><i class="bi bi-search text-primary"></i> Buscar Persona por RUT</a></li>
                    <li><a href="{% url 'gestion:configurar_telegram' %}" class="admin-link"><i class="bi bi-telegram text-primary"></i> Configurar Telegram</a></li>
                    <li><a href="{% url 'partos:exportar_libro_partos' %}" class="admin-link"><i class="bi bi-file-earmark-excel-fill text-primary"></i> Exportación de Datos</a></li>
                    <li><a href="{% url 'gestion:listar_logs' %}" class="admin-link"><i class="bi bi-clock-history text-primary"></i> Ver Logs del Sistema</a></li>
                </ul>
            </div>
        </div>

        <!-- Médico -->
        <div class="role-card">
            <div class="role-header medico">
                <i class="bi bi-heart-pulse-fill"></i>
                <h3>Médico</h3>
                <span class="count">{{ total_medicos|default:"0" }} activos</span>
            </div>
            <div class="role-body">
                <!-- Advertencia Permanente sobre Modificación de Datos -->
                <div class="alert alert-warning border-start border-4 mb-3 shadow-sm" role="alert" style="background-color: #fff3cd; border-left-color: #11998e !important; font-size: 0.85rem;">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2" style="font-size: 1.25rem; flex-shrink: 0;"></i>
                        <div style="flex: 1;">
                            <h6 class="alert-heading mb-1" style="color: #11998e; font-size: 0.9rem; font-weight: 700;">
                                <i class="bi bi-shield-exclamation"></i> Advertencia Legal - Modificación de Datos
                            </h6>
                            <p class="mb-1" style="font-size: 0.8rem; line-height: 1.4;">
                                <strong>Ley N° 19.628 - Protección de la Vida Privada:</strong> 
                                Toda modificación de datos de pacientes debe estar debidamente justificada y documentada. 
                                La alteración sin autorización puede constituir una violación a la privacidad del paciente.
                            </p>
                            <hr style="border-color: #11998e; opacity: 0.25; margin: 0.5rem 0;">
                            <p class="mb-0" style="font-size: 0.75rem;">
                                <i class="bi bi-info-circle-fill text-info"></i> 
                                <strong>Recuerde:</strong> Toda modificación queda registrada con fecha, hora y usuario responsable.
                            </p>
                        </div>
                    </div>
                </div>
                
                <ul class="function-list">
                    <li><a href="/medico/" class="medico-link"><i class="bi bi-house-door-fill text-success"></i> Menú Principal Médico</a></li>
                    <li><a href="/medico/seleccionar-persona/" class="medico-link"><i class="bi bi-file-earmark-plus-fill text-success"></i> Crear Ficha Obstétrica</a></li>
                    <li><a href="/medico/fichas/" class="medico-link"><i class="bi bi-folder-fill text-success"></i> Ver Fichas Obstétricas</a></li>
                    <li><a href="/partos/" class="medico-link"><i class="bi bi-journal-medical text-success"></i> Registro de Partos</a></li>
                    <li><a href="{% url 'partos:exportar_libro_partos' %}" class="medico-link"><i class="bi bi-file-earmark-excel-fill text-success"></i> Exportación de Datos</a></li>
                </ul>
            </div>
        </div>

        <!-- Matrona -->
        <div class="role-card">
            <div class="role-header matrona">
                <i class="bi bi-suit-heart-fill"></i>
                <h3>Matrona</h3>
                <span class="count">{{ total_matronas|default:"0" }} activos</span>
            </div>
            <div class="role-body">
                <!-- Advertencia Permanente sobre Modificación de Datos -->
                <div class="alert alert-warning border-start border-4 mb-3 shadow-sm" role="alert" style="background-color: #fff3cd; border-left-color: #f5576c !important; font-size: 0.85rem;">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2" style="font-size: 1.25rem; flex-shrink: 0;"></i>
                        <div style="flex: 1;">
                            <h6 class="alert-heading mb-1" style="color: #f5576c; font-size: 0.9rem; font-weight: 700;">
                                <i class="bi bi-shield-exclamation"></i> Advertencia Legal - Modificación de Datos
                            </h6>
                            <p class="mb-1" style="font-size: 0.8rem; line-height: 1.4;">
                                <strong>Ley N° 19.628 - Protección de la Vida Privada:</strong> 
                                Toda modificación de datos de pacientes debe estar debidamente justificada y documentada. 
                                La alteración sin autorización puede constituir una violación a la privacidad del paciente.
                            </p>
                            <hr style="border-color: #f5576c; opacity: 0.25; margin: 0.5rem 0;">
                            <p class="mb-0" style="font-size: 0.75rem;">
                                <i class="bi bi-info-circle-fill text-info"></i> 
                                <strong>Recuerde:</strong> Toda modificación queda registrada con fecha, hora y usuario responsable.
                            </p>
                        </div>
                    </div>
                </div>
                
                <ul class="function-list">
                    <li><a href="/services/" class="matrona-link"><i class="bi bi-house-door-fill text-danger"></i> Menú Principal Matrona</a></li>
                    <li><a href="/services/select/" class="matrona-link"><i class="bi bi-file-earmark-plus-fill text-danger"></i> Crear Ficha Obstétrica</a></li>
                    <li><a href="/services/cases/" class="matrona-link"><i class="bi bi-folder-fill text-danger"></i> Ver Fichas Obstétricas</a></li>
                    <li><a href="/records/" class="matrona-link"><i class="bi bi-journal-medical text-danger"></i> Registro de Partos</a></li>
                </ul>
            </div>
        </div>

        <!-- TENS -->
        <div class="role-card">
            <div class="role-header tens">
                <i class="bi bi-person-badge-fill"></i>
                <h3>TENS</h3>
                <span class="count">{{ total_tens|default:"0" }} activos</span>
            </div>
            <div class="role-body">
                <!-- Advertencia Permanente sobre Modificación de Datos -->
                <div class="alert alert-warning border-start border-4 mb-3 shadow-sm" role="alert" style="background-color: #fff3cd; border-left-color: #4facfe !important; font-size: 0.85rem;">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-exclamation-triangle-fill text-warning me-2" style="font-size: 1.25rem; flex-shrink: 0;"></i>
                        <div style="flex: 1;">
                            <h6 class="alert-heading mb-1" style="color: #4facfe; font-size: 0.9rem; font-weight: 700;">
                                <i class="bi bi-shield-exclamation"></i> Advertencia Legal - Modificación de Datos
                            </h6>
                            <p class="mb-1" style="font-size: 0.8rem; line-height: 1.4;">
                                <strong>Ley N° 19.628 - Protección de la Vida Privada:</strong> 
                                Toda modificación de datos de pacientes debe estar debidamente justificada y documentada. 
                                La alteración sin autorización puede constituir una violación a la privacidad del paciente.
                            </p>
                            <hr style="border-color: #4facfe; opacity: 0.25; margin: 0.5rem 0;">
                            <p class="mb-0" style="font-size: 0.75rem;">
                                <i class="bi bi-info-circle-fill text-info"></i> 
                                <strong>Recuerde:</strong> Toda modificación queda registrada con fecha, hora y usuario responsable.
                            </p>
                        </div>
                    </div>
                </div>
                
                <ul class="function-list">
                    <li><a href="{% url 'authentication:dashboard_tens' %}" class="tens-link"><i class="bi bi-house-door-fill text-info"></i> Menú Principal TENS</a></li>
                    <li><a href="/tens/signos-vitales/" class="tens-link"><i class="bi bi-heart-pulse-fill text-info"></i> Registrar Signos Vitales</a></li>
                    <li><a href="/tens/pacientes/" class="tens-link"><i class="bi bi-people-fill text-info"></i> Ver Pacientes Activos</a></li>
                    <li><a href="/tens/buscar-paciente/" class="tens-link"><i class="bi bi-capsule text-info"></i> Ver Tratamientos por Paciente</a></li>
                </ul>
            </div>
        </div>
    </div>


</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-cerrar alerta
    setTimeout(function() {
        const alert = document.getElementById('welcomeAlert');
        if (alert) new bootstrap.Alert(alert).close();
    }, 5000);

    // Fecha y hora
    function updateDateTime() {
        const now = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateStr = now.toLocaleDateString('es-CL', options);
        const timeStr = now.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('currentDate').textContent = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
        document.getElementById('currentTime').textContent = timeStr + ' hrs';
    }
    
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // ═══════════════════════════════════════════════════════════════
    // PREVENIR ACCESO A PÁGINA CACHEADA AL RETROCEDER
    // ═══════════════════════════════════════════════════════════════
    
    // Detectar si la página se cargó desde el caché del navegador (botón retroceder)
    window.addEventListener('pageshow', function(event) {
        // Si la página viene del caché (persisted = true), recargar
        if (event.persisted) {
            console.log('Página cargada desde caché - Recargando para validar permisos...');
            window.location.reload();
        }
    });

    // Marcar la página como "no cacheable" usando performance API
    if (performance.navigation.type === 2) {
        // type 2 = página cargada desde caché (botón retroceder)
        console.log('Navegación desde caché detectada - Recargando...');
        window.location.reload();
    }

    // Prevenir que la página se guarde en el caché del navegador
    window.addEventListener('beforeunload', function() {
        // Esto ayuda a que el navegador no cachee la página
        document.body.style.display = 'none';
    });

    // Detectar cuando el usuario vuelve a esta página usando el historial
    window.addEventListener('popstate', function(event) {
        // Forzar recarga cuando se usa el botón retroceder
        console.log('Navegación con botón retroceder detectada - Recargando...');
        window.location.reload();
    });
</script>
{% endblock %}